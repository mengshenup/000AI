/* ==========================================================================
   ğŸ“ƒ æ–‡ä»¶åŠŸèƒ½ : æ‰«ææœ¬åœ°åº”ç”¨ç›®å½•å¹¶åŒæ­¥è‡³æœåŠ¡ç«¯
   âš¡ é€»è¾‘æ‘˜è¦ : éå†æ–‡ä»¶ç³»ç»Ÿ -> æ„å»ºåº”ç”¨æ¸…å• -> æ‰¹é‡HTTPæ¨é€ -> æäº¤äº‹åŠ¡
   ğŸ’¡ æ˜“æ‡‚è§£é‡Š : å°±åƒå¿«é€’å‘˜å°å“¥ï¼ŒæŒ¨å®¶æŒ¨æˆ·æ”¶å¿«é€’ï¼ˆæ‰«ææ–‡ä»¶ï¼‰ï¼Œè£…æ»¡ä¸€è½¦ï¼ˆBatchï¼‰å°±å‘å¾€é›†æ•£ä¸­å¿ƒï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œæœ€åç­¾å•ç¡®è®¤ï¼ˆCommitï¼‰ã€‚
   ğŸ”‹ æ‰©å±•å¤‡æ³¨ : æœªæ¥å¯å¢åŠ å¢é‡åŒæ­¥åŠŸèƒ½ï¼Œä»…ä¸Šä¼ ä¿®æ”¹è¿‡çš„æ–‡ä»¶ã€‚
   ğŸ“Š å½“å‰çŠ¶æ€ : æ´»è·ƒ (æœ€åæ›´æ–°: 2025-11-29)
   ğŸ§± apps_list.rs è¸©å‘è®°å½• (å¿…é¡»ç´¯åŠ ï¼Œä¸¥ç¦è¦†ç›–) :
      1. 2025-11-29 [å¾…éªŒè¯] è·¯å¾„åˆ†éš”ç¬¦: Windowsä¸‹è·¯å¾„å¯èƒ½åŒ…å«åæ–œæ  -> å·²ç»Ÿä¸€æ›¿æ¢ä¸ºUnixé£æ ¼ (Line 108)
   ========================================================================== */

use std::fs; // ğŸ“‚ æ–‡ä»¶ç³»ç»Ÿæ“ä½œåº“
use std::path::Path; // ğŸ›£ï¸ è·¯å¾„å¤„ç†æ¨¡å—
use walkdir::WalkDir; // ğŸš¶ ç›®å½•é€’å½’éå†å™¨
use serde::{Serialize, Deserialize}; // ğŸ§¬ åºåˆ—åŒ–åè®®
use reqwest::blocking::Client; // ğŸŒ é˜»å¡å¼ç½‘ç»œå®¢æˆ·ç«¯
use anyhow::{Result, Context}; // ğŸ›¡ï¸ é”™è¯¯å¤„ç†å¢å¼º

const SERVER_URL: &str = "http://localhost:9000"; // ğŸ¯ æœåŠ¡ç«¯åœ°å€é”šç‚¹
const BATCH_SIZE: usize = 50; // ğŸ“¦ æ‰¹é‡ä¼ è¾“é˜ˆå€¼

// =============================================================================
//  ğŸ‰ åº”ç”¨æ•°æ®èƒ¶å›Š
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//      å®šä¹‰å•ä¸ªåº”ç”¨æ–‡ä»¶çš„å…ƒæ•°æ®å’Œå†…å®¹ç»“æ„ï¼Œç”¨äºåºåˆ—åŒ–ä¼ è¾“ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//      è¿™å°±æ˜¯ä¸€ä¸ªå¿«é€’åŒ…è£¹å•ï¼Œä¸Šé¢å†™ç€é‡Œé¢è£…çš„æ˜¯ä»€ä¹ˆï¼ˆå†…å®¹ï¼‰ã€å«ä»€ä¹ˆåå­—ï¼ˆåç§°ï¼‰ã€æœ‰å¤šé‡ï¼ˆå¤§å°ï¼‰ã€é€åˆ°å“ªé‡Œï¼ˆè·¯å¾„ï¼‰ã€‚
//  
//  âš ï¸ è­¦å‘Šï¼š
//      å†…å­˜æº¢å‡º: å¦‚æœå•ä¸ªæ–‡ä»¶è¿‡å¤§ï¼Œcontentå­—æ®µå¯èƒ½å ç”¨è¿‡å¤šå†…å­˜ã€‚
//  
//  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
//      apps_list.rs -> main() -> WalkDiréå† -> AppDataæ„å»º
// =============================================================================
#[derive(Debug, Serialize, Deserialize, Clone)]
struct AppData {
    name: String, // ğŸ·ï¸ åº”ç”¨åç§°æ ‡è¯†
    path: String, // ğŸ“‚ ç›¸å¯¹è·¯å¾„å®šä½
    size: u64, // âš–ï¸ æ–‡ä»¶å­—èŠ‚å¤§å°
    content: String, // ğŸ“ æºç å†…å®¹è½½è·
}

// =============================================================================
//  ğŸ‰ æ‰¹é‡è¯·æ±‚è½½ä½“
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//      å°è£…ä¸€ç»„åº”ç”¨æ•°æ®ï¼Œä½œä¸ºHTTPè¯·æ±‚çš„Bodyå‘é€ç»™æœåŠ¡ç«¯ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//      è¿™æ˜¯ä¸€è¾†å¿«é€’è´§è½¦ï¼Œé‡Œé¢è£…äº†å¾ˆå¤šä¸ªå¿«é€’åŒ…è£¹ï¼ˆAppDataï¼‰ï¼Œä¸€æ¬¡æ€§æ‹‰èµ°ã€‚
//  
//  âš ï¸ è­¦å‘Šï¼š
//      ç½‘ç»œè¶…æ—¶: å¦‚æœåˆ—è¡¨è¿‡é•¿ï¼Œåºåˆ—åŒ–åçš„JSONå¯èƒ½å¯¼è‡´è¯·æ±‚ä½“è¿‡å¤§ã€‚
//  
//  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
//      apps_list.rs -> send_batch() -> BatchRequestæ„å»º
// =============================================================================
#[derive(Debug, Serialize)]
struct BatchRequest {
    apps: Vec<AppData>, // ğŸ“š åº”ç”¨æ•°æ®é›†åˆ
}

// =============================================================================
//  ğŸ‰ ä¸»å‡½æ•° (æ— )
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//      ç¨‹åºçš„æ‰§è¡Œèµ·ç‚¹ï¼Œåè°ƒæ‰«æã€æ‰“åŒ…ã€å‘é€çš„å…¨è¿‡ç¨‹ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//      è¿™æ˜¯å¿«é€’ç«™é•¿ï¼ŒæŒ‡æŒ¥å¤§å®¶å¼€å§‹å¹²æ´»ï¼šå…ˆæ‰¾åˆ°ä»“åº“ï¼ˆç›®å½•ï¼‰ï¼Œç„¶åæ‰“åŒ…ï¼ˆæ‰«æï¼‰ï¼Œæœ€åå‘è½¦ï¼ˆå‘é€ï¼‰ã€‚
//  
//  âš ï¸ è­¦å‘Šï¼š
//      æ— ç‰¹æ®Šé£é™©
//  
//  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
//      å‘½ä»¤è¡Œæ‰§è¡Œ -> cargo run
// =============================================================================
fn main() -> Result<()> {
    #[cfg(windows)]
    let _ = console::enable_ansi_support(); // ğŸ¨ ç»ˆç«¯é¢œè‰²æ¿€æ´»

    println!("========================================================"); // ğŸ–¨ï¸ åˆ†éš”çº¿è¾“å‡º
    println!(" ğŸ‰ Angel Apps List Sync (Rust Edition)"); // ğŸ–¨ï¸ æ ‡é¢˜æ‰“å°
    println!("========================================================"); // ğŸ–¨ï¸ åˆ†éš”çº¿è¾“å‡º

    let current_dir = std::env::current_dir()?; // ğŸ“ å½“å‰è·¯å¾„è·å–
    
    let apps_dir = if current_dir.join("js").join("apps").exists() { // ğŸ” è·¯å¾„å­˜åœ¨åˆ¤å®š
        current_dir.join("js").join("apps") // ğŸ¯ æ ¹ç›®å½•å®šä½
    } else if current_dir.parent().map(|p| p.join("js").join("apps").exists()).unwrap_or(false) { // ğŸ” çˆ¶çº§è·¯å¾„åˆ¤å®š
        current_dir.parent().unwrap().join("js").join("apps") // ğŸ¯ çˆ¶çº§ç›®å½•å®šä½
    } else { // ğŸ¤· é»˜è®¤è·¯å¾„å›é€€
        Path::new("js/apps").to_path_buf() // ğŸ¯ é»˜è®¤è·¯å¾„æ„é€ 
    };

    println!("ğŸ“‚ ç›®æ ‡æ‰«æç›®å½•: {:?}", apps_dir); // ğŸ–¨ï¸ æ‰«æç›®æ ‡å›æ˜¾

    if !apps_dir.exists() { // ğŸ›‘ ç›®å½•å­˜åœ¨æ ¡éªŒ
        println!("âŒ é”™è¯¯: æ‰¾ä¸åˆ° js/apps ç›®å½•ï¼è¯·ç¡®ä¿åœ¨ Web_compute_low ç›®å½•ä¸‹è¿è¡Œã€‚"); // ğŸ–¨ï¸ é”™è¯¯ä¿¡æ¯æç¤º
        return Ok(()); // ğŸšª æå‰é€€å‡ºç¨‹åº
    }

    let mut apps_buffer: Vec<AppData> = Vec::new(); // ğŸ§º ç¼“å†²é˜Ÿåˆ—åˆå§‹åŒ–
    let client = Client::new(); // ğŸŒ ç½‘ç»œå®¢æˆ·ç«¯åˆ›å»º
    let mut total_synced = 0; // ğŸ”¢ åŒæ­¥è®¡æ•°å½’é›¶

    println!("ğŸš€ å¼€å§‹æ‰«æå¹¶åŒæ­¥..."); // ğŸ–¨ï¸ ä»»åŠ¡å¼€å§‹æç¤º

    for entry in WalkDir::new(&apps_dir).into_iter().filter_map(|e| e.ok()) { // ğŸš¶ ç›®å½•é€’å½’éå†
        let path = entry.path(); // ğŸ“‚ æ–‡ä»¶è·¯å¾„æå–
        
        if path.is_file() && path.extension().is_some_and(|ext| ext == "js") { // ğŸ” JSæ–‡ä»¶è¿‡æ»¤
            let content = fs::read_to_string(path).unwrap_or_default(); // ğŸ“– æ–‡ä»¶å†…å®¹è¯»å–
            let name = path.file_stem().unwrap().to_string_lossy().to_string(); // ğŸ·ï¸ æ–‡ä»¶åæå–
            
            let relative_path = path.strip_prefix(apps_dir.parent().unwrap_or(&apps_dir)) // ğŸ“ ç›¸å¯¹è·¯å¾„è®¡ç®—
                .unwrap_or(path) // ğŸ›¡ï¸ è·¯å¾„å›é€€ä¿æŠ¤
                .to_string_lossy() // ğŸ§¬ å­—ç¬¦ä¸²è½¬æ¢
                .replace("\\", "/"); // ğŸ”„ è·¯å¾„åˆ†éš”ç¬¦ç»Ÿä¸€

            let size = content.len() as u64; // âš–ï¸ æ–‡ä»¶å¤§å°è®¡ç®—

            let app = AppData { // ğŸ“¦ æ•°æ®å¯¹è±¡æ„å»º
                name, // ğŸ·ï¸ åç§°èµ‹å€¼
                path: relative_path, // ğŸ“‚ è·¯å¾„èµ‹å€¼
                size, // âš–ï¸ å¤§å°èµ‹å€¼
                content, // ğŸ“ å†…å®¹èµ‹å€¼
            };

            apps_buffer.push(app); // ğŸ“¥ ç¼“å†²åŒºå‹å…¥

            if apps_buffer.len() >= BATCH_SIZE { // âš–ï¸ æ‰¹é‡é˜ˆå€¼åˆ¤å®š
                send_batch(&client, &apps_buffer)?; // ğŸ“¤ æ‰¹é‡æ•°æ®å‘é€
                total_synced += apps_buffer.len(); // ğŸ”¢ è®¡æ•°å™¨ç´¯åŠ 
                apps_buffer.clear(); // ğŸ§¹ ç¼“å†²åŒºæ¸…ç©º
                println!("   ğŸ“¦ å·²æ¨é€ {} ä¸ªåº”ç”¨...", total_synced); // ğŸ–¨ï¸ è¿›åº¦ä¿¡æ¯æ‰“å°
            }
        }
    }

    if !apps_buffer.is_empty() { // ğŸ” å‰©ä½™æ•°æ®æ£€æŸ¥
        send_batch(&client, &apps_buffer)?; // ğŸ“¤ å°¾éƒ¨æ•°æ®å‘é€
        total_synced += apps_buffer.len(); // ğŸ”¢ è®¡æ•°å™¨ç´¯åŠ 
    }

    println!("ğŸ’¾ æ­£åœ¨æäº¤æ›´æ”¹åˆ°æœåŠ¡å™¨..."); // ğŸ–¨ï¸ æäº¤çŠ¶æ€æç¤º
    let commit_url = format!("{}/admin/sync_commit", SERVER_URL); // ğŸ”— æäº¤æ¥å£æ‹¼æ¥
    let res = client.post(&commit_url).send(); // ğŸ“¨ æäº¤è¯·æ±‚å‘é€

    match res { // âš–ï¸ å“åº”ç»“æœåŒ¹é…
        Ok(response) => { // âœ… è¯·æ±‚æˆåŠŸåˆ†æ”¯
            if response.status().is_success() { // ğŸ” çŠ¶æ€ç æ ¡éªŒ
                println!("âœ… åŒæ­¥æˆåŠŸï¼å…±å¤„ç†äº† {} ä¸ªåº”ç”¨ã€‚", total_synced); // ğŸ–¨ï¸ æˆåŠŸä¿¡æ¯æ‰“å°
            } else { // âŒ çŠ¶æ€ç é”™è¯¯åˆ†æ”¯
                println!("âŒ æäº¤å¤±è´¥: Status {}", response.status()); // ğŸ–¨ï¸ å¤±è´¥çŠ¶æ€æ‰“å°
                println!("   Response: {}", response.text().unwrap_or_default()); // ğŸ–¨ï¸ å“åº”å†…å®¹æ‰“å°
            }
        },
        Err(e) => { // âŒ è¯·æ±‚å¼‚å¸¸åˆ†æ”¯
            println!("âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥: {}", e); // ğŸ–¨ï¸ å¼‚å¸¸ä¿¡æ¯æ‰“å°
            println!("   è¯·ç¡®ä¿ Web_compute_high (Port 9000) å·²å¯åŠ¨ã€‚"); // ğŸ–¨ï¸ æ•…éšœæ’æŸ¥æç¤º
        }
    }

    Ok(()) // ğŸšª æ­£å¸¸é€€å‡º
}

// =============================================================================
//  ğŸ‰ æ‰¹é‡å‘é€ (HTTPå®¢æˆ·ç«¯, åº”ç”¨åˆ—è¡¨)
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//      å°†æ„å»ºå¥½çš„åº”ç”¨åˆ—è¡¨åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶é€šè¿‡HTTP POSTè¯·æ±‚å‘é€åˆ°æœåŠ¡ç«¯ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//      è¿™æ˜¯å‘è½¦æŒ‡ä»¤ï¼ŒæŠŠè£…å¥½è´§çš„å¡è½¦å¼€å¾€ç›®çš„åœ°ã€‚
//  
//  âš ï¸ è­¦å‘Šï¼š
//      ç½‘ç»œå¼‚å¸¸: å¦‚æœæœåŠ¡ç«¯ä¸å¯è¾¾ï¼Œä¼šæŠ›å‡ºé”™è¯¯ã€‚
//  
//  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
//      main() -> æ‰¹é‡é˜ˆå€¼è§¦å‘/å°¾éƒ¨æ•°æ®è§¦å‘ -> send_batch()
// =============================================================================
fn send_batch(client: &Client, apps: &[AppData]) -> Result<()> {
    let url = format!("{}/admin/sync_batch", SERVER_URL); // ğŸ”— æ¥å£åœ°å€æ‹¼æ¥
    let body = BatchRequest { apps: apps.to_vec() }; // ğŸ“¦ è¯·æ±‚ä½“æ„å»º
    
    let res = client.post(&url) // ğŸ“¨ POSTè¯·æ±‚æ„å»º
        .json(&body) // ğŸ§¬ JSONåºåˆ—åŒ–
        .send() // ğŸš€ è¯·æ±‚å‘é€
        .context("âŒ å‘é€æ‰¹æ¬¡æ•°æ®å¤±è´¥")?; // ğŸ›¡ï¸ é”™è¯¯ä¸Šä¸‹æ–‡æ³¨å…¥

    if !res.status().is_success() { // ğŸ” å“åº”çŠ¶æ€æ£€æŸ¥
        println!("âš ï¸ æ‰¹æ¬¡ä¸Šä¼ è­¦å‘Š: {}", res.status()); // ğŸ–¨ï¸ è­¦å‘Šä¿¡æ¯æ‰“å°
    }
    Ok(()) // ğŸšª æ­£å¸¸è¿”å›
}

#[cfg(windows)]
mod console {
    // =============================================================================
    //  ğŸ‰ å¯ç”¨ANSIæ”¯æŒ (æ— )
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //      åœ¨Windowsç¯å¢ƒä¸‹å¯ç”¨æ§åˆ¶å°çš„ANSIè½¬ä¹‰åºåˆ—æ”¯æŒï¼Œä»¥æ˜¾ç¤ºå½©è‰²æ–‡æœ¬ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //      ç»™é»‘ç™½çš„ç”µè§†æœºè£…ä¸Šå½©è‰²æ˜¾åƒç®¡ã€‚
    //  
    //  âš ï¸ è­¦å‘Šï¼š
    //      æ— ç‰¹æ®Šé£é™©
    //  
    //  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
    //      main() -> console::enable_ansi_support()
    // =============================================================================
    pub fn enable_ansi_support() -> Result<(), u32> {
        Ok(()) // ğŸšª å ä½è¿”å›
    }
}
