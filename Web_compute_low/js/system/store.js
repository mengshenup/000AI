import { DEFAULT_APPS, WEB_API_URL } from './config.js'; // âš™ï¸ å¯¼å…¥é»˜è®¤é…ç½®
import { bus } from './event_bus.js'; // ğŸšŒ å¯¼å…¥äº‹ä»¶æ€»çº¿ (ç”¨äºé€šçŸ¥ UI æ›´æ–°)

export const VERSION = '1.0.0'; // ğŸ’– ç³»ç»Ÿæ ¸å¿ƒæ¨¡å—ç‰ˆæœ¬å·

class Store {
    // =================================
    //  ğŸ‰ çŠ¶æ€å­˜å‚¨ç±» (æ— å‚æ•°)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     ç®¡ç†åº”ç”¨çš„çŠ¶æ€ï¼ˆå¦‚çª—å£ä½ç½®ã€æ˜¯å¦æ‰“å¼€ï¼‰ï¼Œå¹¶æŒä¹…åŒ–åˆ° å®¢æˆ·ç«¯æ•°æ®åº“ (Client Database)ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     è¿™æ˜¯å°å¤©ä½¿çš„â€œè®°äº‹æœ¬â€ã€‚
    //     å®ƒä¼šè®°ä¸‹ä½ æŠŠçª—å£æ‹–åˆ°äº†å“ªé‡Œï¼Œä¸Šæ¬¡å…³æœºå‰å¼€äº†å“ªäº›è½¯ä»¶ã€‚
    //     è¿™æ ·ä¸‹æ¬¡ä½ æ‰“å¼€ç½‘é¡µï¼Œä¸€åˆ‡è¿˜æ˜¯ä½ ç†Ÿæ‚‰çš„æ ·å­ã€‚
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     å¦‚æœç”¨æˆ·æ¸…é™¤äº†æµè§ˆå™¨ç¼“å­˜ï¼Œæ‰€æœ‰ä¿å­˜çš„è®¾ç½®ï¼ˆå¦‚çª—å£ä½ç½®ï¼‰éƒ½ä¼šä¸¢å¤±ï¼Œé‡ç½®ä¸ºé»˜è®¤å€¼ã€‚
    // =================================
    constructor() {
        // =================================
        //  ğŸ‰ æœ¬åœ°æ•°æ®åº“ (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     åˆå§‹åŒ–å­˜å‚¨å¯¹è±¡ï¼Œå°è¯•ä» å®¢æˆ·ç«¯æ•°æ®åº“ è¯»å–æ•°æ®ã€‚
        //     ğŸ’– ä¿®æ”¹ï¼šä¸å†ä½¿ç”¨ LocalStorageï¼Œæ”¹ä¸ºå®Œå…¨ä¾èµ– å®¢æˆ·ç«¯æ•°æ®åº“ (Angel_Client/Memorybank/window_memory.json)ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     ç¿»å¼€è®°äº‹æœ¬ï¼Œçœ‹çœ‹ä¸Šæ¬¡å†™äº†ä»€ä¹ˆã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœæ•°æ®æŸåï¼Œä¼šè‡ªåŠ¨é‡ç½®ä¸ºç©ºã€‚
        // =================================

        this.apps = {}; // ğŸ†• åˆå§‹åŒ–ä¸ºç©º
        this.lazyRegistry = {}; // ğŸ†• æ‡’åŠ è½½æ³¨å†Œè¡¨ (ID -> æ–‡ä»¶è·¯å¾„)
        this.installedApps = {}; // ğŸ†• å·²å®‰è£…åº”ç”¨ç¼“å­˜ (ID -> å…ƒæ•°æ®)

        // 1. ğŸ’– å¼‚æ­¥ä» å®¢æˆ·ç«¯æ•°æ®åº“ åŠ è½½æœ€æ–°å¸ƒå±€ (æƒå¨æ•°æ®)
        // åˆ›å»ºä¸€ä¸ª Promiseï¼Œä»¥ä¾¿å¤–éƒ¨ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
        this.readyPromise = this.syncFromClientDB();
    }

    // ğŸ’– æ³¨å†Œæ‡’åŠ è½½åº”ç”¨
    registerLazyApp(id, path, metadata = {}) {
        // =================================
        //  ğŸ‰ æ³¨å†Œæ‡’åŠ è½½åº”ç”¨ (Register Lazy App) (åº”ç”¨ID, è„šæœ¬è·¯å¾„, [å…ƒæ•°æ®])
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     ç™»è®°ä¸€ä¸ªåº”ç”¨çš„åŠ è½½è·¯å¾„ï¼Œä½†ä¸ç«‹å³åŠ è½½å®ƒã€‚
        //     åªæœ‰å½“ç”¨æˆ·çœŸæ­£ç‚¹å‡»æ‰“å¼€æ—¶ï¼Œæ‰ä¼šå»åŠ è½½å¯¹åº”çš„ JS æ–‡ä»¶ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     æŠŠèœå•ä¸Šçš„èœåå†™ä¸Šå»ï¼Œä½†å…ˆä¸ç‚’èœã€‚
        //     ç­‰å®¢äººç‚¹äº†è¿™é“èœï¼Œå¨å¸ˆæ‰å¼€å§‹åŠ¨æ‰‹ã€‚è¿™æ ·å¼€åº—ï¼ˆå¯åŠ¨ç³»ç»Ÿï¼‰å°±å¿«å¤šäº†ï¼âš¡
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     path å¿…é¡»æ˜¯ç›¸å¯¹äº js/apps/ çš„è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ã€‚
        // =================================
        this.lazyRegistry[id] = path; // ğŸ“ è®°å½• ID å’Œè·¯å¾„çš„å¯¹åº”å…³ç³»
        // å¦‚æœ metadata åŒ…å« name/iconï¼Œå­˜å…¥ installedApps ä»¥ä¾¿æ¡Œé¢æ¸²æŸ“
        if (metadata.name) { // ğŸ“› å¦‚æœæœ‰åå­—
            this.installedApps[id] = { ...metadata, path }; // ğŸ’¾ å­˜å…¥å·²å®‰è£…åˆ—è¡¨ï¼Œä¾›æ¡Œé¢å›¾æ ‡ä½¿ç”¨
        }
    }

    // ğŸ’– è·å–æ‡’åŠ è½½è·¯å¾„
    getLazyAppPath(id) {
        // =================================
        //  ğŸ‰ è·å–åº”ç”¨è·¯å¾„ (Get App Path) (åº”ç”¨ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æŸ¥è¯¢æŸä¸ªåº”ç”¨ ID å¯¹åº”çš„è„šæœ¬æ–‡ä»¶è·¯å¾„ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     æŸ¥èœå•ã€‚çœ‹çœ‹â€œçº¢çƒ§è‚‰â€è¿™é“èœåœ¨ç¬¬å‡ é¡µï¼ˆå“ªä¸ªæ–‡ä»¶é‡Œï¼‰ã€‚ğŸ“–
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœ ID æœªæ³¨å†Œï¼Œè¿”å› undefinedã€‚
        // =================================
        return this.lazyRegistry[id]; // ğŸ“ è¿”å›è·¯å¾„
    }

    // ğŸ’– ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
    async ready() {
        // =================================
        //  ğŸ‰ ç­‰å¾…å°±ç»ª (Wait Ready) (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æä¾›ä¸€ä¸ª Promiseï¼Œç¡®ä¿åœ¨æ‰§è¡Œåç»­æ“ä½œå‰ï¼ŒStore å·²ç»å®Œæˆäº†ä»æ•°æ®åº“çš„åˆå§‹åŒ–åŠ è½½ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     åˆ«æ€¥ï¼Œç­‰è®°äº‹æœ¬ç¿»å¼€äº†å†å†™å­—ã€‚â³
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¿…é¡»ä½¿ç”¨ await store.ready()ã€‚
        // =================================
        if (this.readyPromise) { // ğŸ”„ å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„åˆå§‹åŒ–ä»»åŠ¡
            await this.readyPromise; // ğŸ›‘ ç­‰å¾…ä»»åŠ¡å®Œæˆ
        }
    }

    // ğŸ’– ä» Agentç«¯ åŒæ­¥æ•°æ®
    async syncFromClientDB() {
        // =================================
        //  ğŸ‰ åŒæ­¥æ•°æ® (Sync Data) (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     åŠ è½½åº”ç”¨çŠ¶æ€ã€‚ä¼˜å…ˆçº§ï¼šæœ¬åœ°ç¼“å­˜ (LocalStorage) -> æœåŠ¡å™¨ (Web_compute_high) -> é»˜è®¤ç©ºçŠ¶æ€ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     1. å…ˆç¿»ç¿»å£è¢‹ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰æœ‰æ²¡æœ‰è®°äº‹æœ¬ã€‚
        //     2. å¦‚æœæ²¡æœ‰ï¼Œå°±æ‰“ç”µè¯é—®æ€»éƒ¨ï¼ˆæœåŠ¡å™¨ï¼‰ã€‚
        //     3. å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°±æ‹¿ä¸€æœ¬æ–°çš„ï¼ˆé»˜è®¤ç©ºï¼‰ã€‚
        // =================================
        
        // è·å–å½“å‰ç”¨æˆ· ID
        const userId = localStorage.getItem('current_user_id') || 'default';
        const cacheKey = `angel_memory_bank_${userId}`; // ğŸ”‘ æœ¬åœ°ç¼“å­˜ Key

        // 1. å°è¯•è¯»å–æœ¬åœ°ç¼“å­˜
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const data = JSON.parse(cachedData);
                console.log("ğŸ“‚ ä»æœ¬åœ°ç¼“å­˜åŠ è½½ Memorybank");
                this.apps = data.apps || {};
                if (data.installedApps) this.installedApps = data.installedApps;
                
                // ğŸ’– å³ä½¿æœ‰æœ¬åœ°ç¼“å­˜ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ˜¯å¦åå°åŒæ­¥ (ç›®å‰ç­–ç•¥ï¼šæœ‰ç¼“å­˜åˆ™ä¸é˜»å¡ï¼Œä½†ä¹Ÿä¸åå°åŒæ­¥ï¼ŒèŠ‚çœæµé‡)
                // å¦‚æœéœ€è¦"è¯»å–æœåŠ¡å™¨é‡ŒæœªåŒæ­¥çš„é…ç½®ä¿¡æ¯"ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ é€»è¾‘ï¼Œä½†ä¸ºäº†"èŠ‚çœæœåŠ¡å™¨æµé‡"ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›
                
                // ğŸ’– 2025-12-03 ä¼˜åŒ–ï¼šæœ¬åœ°ä¼˜å…ˆï¼Œä½†åå°é™é»˜åŒæ­¥ (Stale-While-Revalidate)
                // è¿™æ ·æ—¢èƒ½ç§’å¼€ï¼Œåˆèƒ½ä¿è¯äº‘ç«¯æ•°æ®æœ€ç»ˆä¸€è‡´ï¼Œä¸ä¼š"å¼ƒç”¨äº‘ç«¯"
                this.syncFromServerBackground(userId); 
                return; // âœ… å‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å› (è®© UI å…ˆè·‘èµ·æ¥)
            } catch (e) {
                console.warn("âš ï¸ æœ¬åœ°ç¼“å­˜æ•°æ®æŸåï¼Œå°è¯•ä»æœåŠ¡å™¨åŠ è½½");
            }
        }

        // 2. å°è¯•ä»æœåŠ¡å™¨åŠ è½½ (å¸¦è¶…æ—¶æ§åˆ¶)
        const controller = new AbortController(); // â±ï¸ åˆ›å»ºæ§åˆ¶å™¨
        const timeoutId = setTimeout(() => controller.abort(), 3000); // â³ 3ç§’è¶…æ—¶

        try {
            // ä¿®æ­£ï¼šä½¿ç”¨ memory_window.json å¹¶ä¼ é€’ user_id
            const res = await fetch(`${WEB_API_URL}/load_memory?user_id=${userId}`, {
                signal: controller.signal // ğŸ“¶ ç»‘å®šä¿¡å·
            }); 
            const data = await res.json(); // ğŸ“¦ è§£æ JSON å“åº”
            if (data) { // âœ… å¦‚æœæœ‰æ•°æ®
                console.log("â˜ï¸ ä»æœåŠ¡å™¨åŠ è½½ Memorybank");
                this.apps = data.apps || {}; // ğŸ“‚ åŠ è½½åº”ç”¨çŠ¶æ€
                // ğŸ’– åŠ è½½å·²å®‰è£…åº”ç”¨ç¼“å­˜ (å¦‚æœæœ‰)
                if (data.installedApps) { // ğŸ’¾ å¦‚æœæœ‰å®‰è£…åˆ—è¡¨
                    this.installedApps = data.installedApps; // ğŸ“‚ åŠ è½½å®‰è£…åˆ—è¡¨
                }
                
                // ğŸ”„ åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜
                localStorage.setItem(cacheKey, JSON.stringify(data));
            }
        } catch (e) { // ğŸ›¡ï¸ æ•è·å¼‚å¸¸
            if (e.name === 'AbortError') {
                console.warn("â³ åŠ è½½å¸ƒå±€è¶…æ—¶ (æœåŠ¡å™¨å“åº”æ…¢)ï¼Œè·³è¿‡");
            } else {
                console.error("æ— æ³•åŠ è½½å¸ƒå±€ (æœåŠ¡å™¨ä¸å¯ç”¨):", e); // âŒ æ‰“å°é”™è¯¯
            }
            // 3. é»˜è®¤ç©ºçŠ¶æ€ (æ„é€ å‡½æ•°ä¸­å·²åˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡ï¼Œæ­¤å¤„æ— éœ€æ“ä½œ)
            console.log("ğŸ†• ä½¿ç”¨é»˜è®¤ç©º Memorybank");
        } finally {
            clearTimeout(timeoutId); // ğŸ§¹ æ¸…ç†å®šæ—¶å™¨
        }
    }

    // ğŸ’– åå°é™é»˜åŒæ­¥ (Background Sync)
    async syncFromServerBackground(userId) {
        console.log("â˜ï¸ [åå°] å¼€å§‹åŒæ­¥äº‘ç«¯æ•°æ®...");
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // â³ 10ç§’è¶…æ—¶ï¼Œåå°å¯ä»¥å®½å®¹ç‚¹

        try {
            const res = await fetch(`${WEB_API_URL}/load_memory?user_id=${userId}`, {
                signal: controller.signal
            });
            const data = await res.json();
            
            if (data) {
                console.log("â˜ï¸ [åå°] äº‘ç«¯æ•°æ®å·²è·å–ï¼Œæ­£åœ¨åˆå¹¶...");
                let hasChanges = false;

                // 1. åˆå¹¶ installedApps (å…ƒæ•°æ®ï¼Œä»¥æœåŠ¡å™¨ä¸ºå‡†ï¼Œè¡¥å……æœ¬åœ°ç¼ºå¤±çš„)
                if (data.installedApps) {
                    // éå†æœåŠ¡å™¨çš„ installedApps
                    Object.keys(data.installedApps).forEach(id => {
                        // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œæˆ–è€…ç‰ˆæœ¬ä¸åŒï¼Œåˆ™æ›´æ–°
                        // è¿™é‡Œç®€å•èµ·è§ï¼Œåªè¦æœåŠ¡å™¨æœ‰ï¼Œå°±åˆå¹¶è¿›æ¥ (Object.assign æµ…æ‹·è´)
                        if (!this.installedApps[id]) {
                            this.installedApps[id] = data.installedApps[id];
                            hasChanges = true;
                        }
                    });
                }

                // 2. åˆå¹¶ apps (çŠ¶æ€ï¼Œä»¥æœ¬åœ°ä¸ºå‡†ï¼Œåªè¡¥å……ç¼ºå¤±é¡¹)
                // âš ï¸ å…³é”®ç­–ç•¥ï¼šç»å¯¹ä¸è¦†ç›–æœ¬åœ°å·²å­˜åœ¨çš„çŠ¶æ€ï¼Œé˜²æ­¢ç”¨æˆ·æ“ä½œæ—¶çª—å£è·³å˜
                if (data.apps) {
                    Object.keys(data.apps).forEach(id => {
                        if (!this.apps[id]) {
                            // æœ¬åœ°æ²¡æœ‰ï¼ŒæœåŠ¡å™¨æœ‰ -> æ–°å¢ (å¯èƒ½æ˜¯å…¶ä»–è®¾å¤‡å®‰è£…çš„)
                            this.apps[id] = data.apps[id];
                            hasChanges = true;
                            console.log(`â˜ï¸ [åå°] åŒæ­¥æ–°å¢åº”ç”¨: ${id}`);
                        }
                    });
                }

                if (hasChanges) {
                    this.save(); // ğŸ’¾ ä¿å­˜åˆå¹¶åçš„ç»“æœåˆ°æœ¬åœ°å’ŒæœåŠ¡å™¨
                    console.log("â˜ï¸ [åå°] æ•°æ®åˆå¹¶å®Œæˆï¼Œå·²ä¿å­˜");
                    
                    // ğŸ“¢ é€šçŸ¥ UI æ›´æ–° (ä¾‹å¦‚æ¡Œé¢å›¾æ ‡)
                    // åªæœ‰å½“ç¡®å®æœ‰æ–°åº”ç”¨æ—¶æ‰åˆ·æ–°ï¼Œé¿å…æ— æ„ä¹‰çš„é‡ç»˜
                    bus.emit('system:apps_loaded'); 
                } else {
                    console.log("â˜ï¸ [åå°] æœ¬åœ°å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°");
                }
            }
        } catch (e) {
            if (e.name !== 'AbortError') {
                console.warn("â˜ï¸ [åå°] äº‘ç«¯åŒæ­¥å¤±è´¥ (éè‡´å‘½):", e);
            }
        } finally {
            clearTimeout(timeoutId);
        }
    }

    // ğŸ†• åŠ¨æ€ç‰ˆæœ¬æ£€æŸ¥ï¼šè®¡ç®—å½“å‰é…ç½®çš„æŒ‡çº¹
    checkVersion(metadataMap) {
        // =================================
        //  ğŸ‰ ç‰ˆæœ¬æ£€æŸ¥ (Check Version) (å…ƒæ•°æ®æ˜ å°„)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     (å·²æš‚æ—¶ç¦ç”¨) æ¯”è¾ƒå½“å‰åº”ç”¨åˆ—è¡¨çš„æŒ‡çº¹ä¸æœ¬åœ°å­˜å‚¨çš„æŒ‡çº¹ï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦é‡ç½®çŠ¶æ€ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     çœ‹çœ‹èœå•æ˜¯ä¸æ˜¯æ¢äº†ã€‚å¦‚æœæ¢äº†ï¼Œå¯èƒ½è¦æŠŠæ¡Œå­æ¸…ç†ä¸€ä¸‹ã€‚ğŸ§¹
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     ç›®å‰ä»£ç å—è¢«æ³¨é‡Šæ‰äº†ã€‚
        // =================================
        // æš‚æ—¶ç¦ç”¨æŒ‡çº¹æ£€æŸ¥ï¼Œå› ä¸ºå·²ç§»é™¤ LocalStorage
        /*
        // ç”ŸæˆæŒ‡çº¹ï¼šæ‰€æœ‰ App ID æ’åºåçš„å­—ç¬¦ä¸²
        const currentFingerprint = Object.keys(metadataMap).sort().join('|');
        const savedFingerprint = localStorage.getItem('seraphim_fingerprint');

        if (savedFingerprint !== currentFingerprint) {
            console.log(`[Store] æ£€æµ‹åˆ°åº”ç”¨ç»“æ„å˜æ›´ (${savedFingerprint} -> ${currentFingerprint})ï¼Œæ‰§è¡Œæ™ºèƒ½æ¸…ç†...`);
            
            // ç­–ç•¥ï¼šä¿ç•™ä½ç½®ä¿¡æ¯ï¼Œé‡ç½®æ‰“å¼€çŠ¶æ€ (é˜²æ­¢æ–°æ—§é€»è¾‘å†²çªå¯¼è‡´å¡æ­»)
            Object.keys(this.apps).forEach(id => {
                if (this.apps[id]) {
                    this.apps[id].isOpen = false; // ğŸ”’ å¼ºåˆ¶å…³é—­æ‰€æœ‰çª—å£
                    this.apps[id].isMinimized = false;
                    // å¦‚æœ ID å·²ç»ä¸å­˜åœ¨äºæ–°é…ç½®ä¸­ï¼Œprune æ–¹æ³•ç¨åä¼šå¤„ç†
                }
            });
            
            // æ›´æ–°æŒ‡çº¹
            localStorage.setItem('seraphim_fingerprint', currentFingerprint);
            this.save();
        }
        */
    }

    // ğŸ’– ä¿å­˜æ•°æ®åˆ° å®¢æˆ·ç«¯æ•°æ®åº“
    async save() {
        // =================================
        //  ğŸ‰ ä¿å­˜æ•°æ® (Save Data) (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     å°†å½“å‰å†…å­˜ä¸­çš„åº”ç”¨çŠ¶æ€å’Œå®‰è£…åˆ—è¡¨ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå¹¶å¼‚æ­¥å‘é€åˆ°åç«¯ API è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     å†™æ—¥è®°ã€‚å…ˆå†™åœ¨éšèº«å¸¦çš„å°æœ¬æœ¬ä¸Šï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰ï¼Œæœ‰ç©ºäº†å†èªŠå†™åˆ°ä¿é™©æŸœé‡Œï¼ˆæœåŠ¡å™¨ï¼‰ã€‚ğŸ“
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚
        // =================================
        try {
            // è·å–å½“å‰ç”¨æˆ· ID
            const userId = localStorage.getItem('current_user_id') || 'default';
            const cacheKey = `angel_memory_bank_${userId}`; // ğŸ”‘ æœ¬åœ°ç¼“å­˜ Key
            
            const payloadData = { 
                apps: this.apps, // ğŸ“‚ åº”ç”¨çŠ¶æ€
                installedApps: this.installedApps // ğŸ’¾ æŒä¹…åŒ–å®‰è£…åˆ—è¡¨
            };

            // 1. ç«‹å³ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            localStorage.setItem(cacheKey, JSON.stringify(payloadData));

            // 2. å¼‚æ­¥å‘é€åˆ°æœåŠ¡å™¨
            await fetch(`${WEB_API_URL}/save_memory`, { // ğŸ“¡ å‘èµ· POST è¯·æ±‚
                method: 'POST', // ğŸ“® ä½¿ç”¨ POST æ–¹æ³•
                headers: { 'Content-Type': 'application/json' }, // ğŸ·ï¸ è®¾ç½®å†…å®¹ç±»å‹ä¸º JSON
                body: JSON.stringify({ // ğŸ“¦ æ‰“åŒ…æ•°æ®
                    user_id: userId, // ğŸ‘¤ ç”¨æˆ· ID
                    data: payloadData
                })
            });
        } catch (e) { // ğŸ›¡ï¸ æ•è·å¼‚å¸¸
            console.error("æ— æ³•ä¿å­˜å¸ƒå±€:", e); // âŒ æ‰“å°é”™è¯¯
        }
    }

    // =================================
    //  ğŸ‰ é‡ç½®æ‰€æœ‰çŠ¶æ€ (Reset All) (æ— å‚æ•°)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     æ¸…ç©ºå†…å­˜ä¸­çš„åº”ç”¨çŠ¶æ€ï¼Œå¹¶è°ƒç”¨åç«¯ API æ¸…ç©ºæŒä¹…åŒ–å­˜å‚¨ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     æŠŠè®°äº‹æœ¬æ’•äº†ï¼ğŸ“„ ä¸€åˆ‡ä»å¤´å¼€å§‹ï¼
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     è¿™æ˜¯ä¸€ä¸ªç ´åæ€§æ“ä½œï¼Œä¸å¯æ’¤é”€ã€‚
    // =================================
    async reset() {
        console.log("æ­£åœ¨é‡ç½®æ‰€æœ‰åº”ç”¨çŠ¶æ€..."); // ğŸ“ æ‰“å°æ—¥å¿—
        this.apps = {}; // ğŸ§¹ æ¸…ç©ºå†…å­˜
        
        // ğŸ“¡ è°ƒç”¨åç«¯ API æ¸…ç©ºæ–‡ä»¶
        try {
            const userId = localStorage.getItem('current_user_id') || 'default';
            await fetch(`${WEB_API_URL}/save_memory`, { // ğŸ“¡ å‘èµ·è¯·æ±‚
                method: 'POST', // ğŸ“® POST
                headers: { 'Content-Type': 'application/json' }, // ğŸ·ï¸ JSON
                body: JSON.stringify({ user_id: userId, data: {} }) // ğŸ“¦ å‘é€ç©ºå¯¹è±¡
            });
            console.log("å·²æ¸…ç©ºæœåŠ¡ç«¯å¸ƒå±€å­˜å‚¨ âœ¨"); // ğŸ“ æˆåŠŸæ—¥å¿—
        } catch (e) { // ğŸ›¡ï¸ æ•è·å¼‚å¸¸
            console.error("é‡ç½®æœåŠ¡ç«¯å­˜å‚¨å¤±è´¥", e); // âŒ é”™è¯¯æ—¥å¿—
        }
    }

    prune(validIds) {
        // =================================
        //  ğŸ‰ æ¸…ç†åƒµå°¸æ•°æ® (Prune Zombies) (æœ‰æ•ˆIDåˆ—è¡¨)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     åˆ é™¤é‚£äº›å­˜åœ¨äºç¼“å­˜ä¸­ä½†å½“å‰ä»£ç ä¸­å·²ä¸å­˜åœ¨çš„åº”ç”¨æ•°æ®ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     å¤§æ‰«é™¤ã€‚æŠŠé‚£äº›å·²ç»æ¬èµ°çš„äººï¼ˆåˆ æ‰çš„åº”ç”¨ï¼‰çš„æˆ·å£æ³¨é”€æ‰ã€‚ğŸ§¹
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     ä¸€æ—¦åˆ é™¤æ— æ³•æ¢å¤ã€‚
        // =================================
        const validSet = new Set(validIds); // ğŸ“‹ å°†æ•°ç»„è½¬æ¢ä¸º Set ä»¥æé«˜æŸ¥æ‰¾æ•ˆç‡
        let changed = false; // ğŸš© æ ‡è®°æ˜¯å¦æœ‰æ•°æ®å˜æ›´
        
        Object.keys(this.apps).forEach(id => { // ğŸ”„ éå†æ‰€æœ‰å·²å­˜å‚¨çš„åº”ç”¨ ID
            if (!validSet.has(id)) { // ğŸ‘» å¦‚æœè¯¥ ID ä¸åœ¨æœ‰æ•ˆåˆ—è¡¨ä¸­
                console.log(`[Store] æ¸…ç†åƒµå°¸åº”ç”¨æ•°æ®: ${id}`); // ğŸ“ æ‰“å°æ¸…ç†æ—¥å¿—
                delete this.apps[id]; // ğŸ—‘ï¸ åˆ é™¤è¯¥åº”ç”¨æ•°æ®
                changed = true; // ğŸš© æ ‡è®°å‘ç”Ÿäº†å˜æ›´
            }
        });

        if (changed) this.save(); // ğŸ’¾ å¦‚æœæœ‰å˜åŠ¨ï¼Œç«‹å³ä¿å­˜
    }

    getApp(id) {
        // =================================
        //  ğŸ‰ è·å–åº”ç”¨ä¿¡æ¯ (Get App Info) (åº”ç”¨ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æ ¹æ® ID è·å–æŸä¸ªåº”ç”¨çš„å®Œæ•´é…ç½®ä¿¡æ¯ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     æŸ¥æˆ·å£ã€‚æ ¹æ®èº«ä»½è¯å·ï¼ˆIDï¼‰æŸ¥å‡ºè¿™ä¸ªè½¯ä»¶å«ä»€ä¹ˆã€å›¾æ ‡æ˜¯ä»€ä¹ˆã€ä¸Šæ¬¡åœåœ¨å“ªé‡Œã€‚ğŸ”
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœä¼ å…¥ä¸å­˜åœ¨çš„ IDï¼Œä¼šè¿”å› undefinedã€‚
        // =================================

        return this.apps[id]; // ğŸ“¤ è¿”å›åº”ç”¨æ•°æ®å¯¹è±¡
    }

    updateApp(id, data) {
        // =================================
        //  ğŸ‰ æ›´æ–°åº”ç”¨ä¿¡æ¯ (Update App Info) (åº”ç”¨ID, æ–°æ•°æ®)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æ›´æ–°æŸä¸ªåº”ç”¨çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ä½ç½®æ”¹å˜äº†ã€è¢«å…³é—­äº†ï¼‰ï¼Œå¹¶ç«‹å³ä¿å­˜ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     ä¿®æ”¹æˆ·å£ä¿¡æ¯ã€‚æ¯”å¦‚â€œå°æ˜æ¬å®¶äº†â€ï¼Œå°±æŠŠä»–çš„æ–°åœ°å€è®°ä¸‹æ¥ã€‚ğŸ 
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     data å‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœä¼ å…¥ null æˆ–éå¯¹è±¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æŸåã€‚
        // =================================

        if (!this.apps[id]) { // ğŸ†• å¦‚æœåº”ç”¨åœ¨ apps ä¸­ä¸å­˜åœ¨ (ä¾‹å¦‚æ‡’åŠ è½½åº”ç”¨é¦–æ¬¡è¢«æ‹–æ‹½)
            // å°è¯•ä» installedApps è·å–å…ƒæ•°æ®
            const installed = this.installedApps[id];
            if (installed) {
                // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€ï¼Œåˆå¹¶å…ƒæ•°æ®å’Œæ–°æ•°æ®
                this.apps[id] = { ...installed, ...data };
            } else {
                // å…œåº•ï¼šå¦‚æœè¿ installedApps éƒ½æ²¡æœ‰ï¼Œç›´æ¥åˆ›å»º (é˜²æ­¢æŠ¥é”™)
                this.apps[id] = { ...data };
            }
        } else {
            // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦ ... åˆå¹¶æ–°æ—§æ•°æ®
            this.apps[id] = { ...this.apps[id], ...data }; // ğŸ”„ åˆå¹¶æ•°æ®
        }
        // ä¿å­˜æ›´æ”¹
        this.save(); // ğŸ’¾ ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
    }

    setAppMetadata(id, metadata) {
        // =================================
        //  ğŸ‰ è®¾ç½®åº”ç”¨å…ƒæ•°æ® (Set App Metadata) (åº”ç”¨ID, å…ƒæ•°æ®å¯¹è±¡)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     è¿è¡Œæ—¶æ³¨å…¥åº”ç”¨çš„é™æ€ä¿¡æ¯ï¼ˆå¦‚åç§°ã€æ¬¢è¿è¯­ï¼‰ã€‚
        //     è¿™äº›ä¿¡æ¯ä¸åº”è¯¥è¢«ä¿å­˜åˆ° localStorage ä¸­ï¼ˆå› ä¸ºå®ƒä»¬æ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œä¸æ˜¯ç”¨æˆ·çŠ¶æ€ï¼‰ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     ç»™æˆ·å£æœ¬ä¸Šè¡¥å…¨åå­—å’Œç…§ç‰‡ã€‚ğŸ“¸
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœåº”ç”¨IDå·²å­˜åœ¨ï¼Œä¼šä¿ç•™åŸæœ‰çš„ç”¨æˆ·çŠ¶æ€ï¼ˆå¦‚ä½ç½®ï¼‰ï¼Œåªæ›´æ–°é™æ€ä¿¡æ¯ã€‚
        // =================================
        if (this.apps[id]) { // ğŸ”„ å¦‚æœåº”ç”¨å·²å­˜åœ¨ï¼ˆæœ‰æ—§çŠ¶æ€ï¼‰
            // ä¿®å¤ï¼šä¼˜å…ˆä¿ç•™ this.apps[id] ä¸­çš„ç”¨æˆ·çŠ¶æ€ (å¦‚ pos, winPos, isOpen)
            // metadata ä¸­çš„é»˜è®¤å€¼åªåœ¨ this.apps[id] ä¸­ä¸å­˜åœ¨æ—¶ç”Ÿæ•ˆ
            this.apps[id] = { ...metadata, ...this.apps[id] }; // ğŸ”„ åˆå¹¶ï¼Œä¿ç•™ç”¨æˆ·çŠ¶æ€
            
            // ç¡®ä¿é™æ€é…ç½® (name, content, icon, color) æ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„ä»£ç ç‰ˆæœ¬
            // è¿™æ ·å³ä½¿ç”¨æˆ·ç¼“å­˜äº†æ—§çš„é…ç½®ï¼Œä»£ç æ›´æ–°åä¹Ÿèƒ½çœ‹åˆ°æ–°ç•Œé¢
            // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„åç§° (customName)ï¼Œå¦‚æœä¸å­˜åœ¨æ‰ä½¿ç”¨å…ƒæ•°æ®ä¸­çš„é»˜è®¤åç§°
            this.apps[id].name = this.apps[id].customName || metadata.name; // ğŸ“› æ›´æ–°åç§°
            this.apps[id].description = metadata.description; // ğŸ“ æ›´æ–°æè¿°
            this.apps[id].content = metadata.content; // ğŸ“„ æ›´æ–°å†…å®¹
            this.apps[id].icon = metadata.icon; // ğŸ–¼ï¸ æ›´æ–°å›¾æ ‡
            this.apps[id].color = metadata.color; // ğŸ¨ æ›´æ–°é¢œè‰²
            this.apps[id].contentStyle = metadata.contentStyle; // ğŸ’… æ›´æ–°æ ·å¼
            this.apps[id].openMsg = metadata.openMsg; // ğŸ’¬ æ›´æ–°æ¬¢è¿è¯­
            
            // ğŸ’– æ˜¾å¼æ›´æ–°å¸ƒå±€å±æ€§ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬ UI ç”Ÿæ•ˆ
            this.apps[id].skipTaskbar = metadata.skipTaskbar; // ğŸ’– æ›´æ–°è·³è¿‡ä»»åŠ¡æ è®¾ç½®
            this.apps[id].showTrayIcon = metadata.showTrayIcon; // ğŸ’– æ›´æ–°æ‰˜ç›˜å›¾æ ‡è®¾ç½®
            this.apps[id].frameless = metadata.frameless; // ğŸ–¼ï¸ æ›´æ–°æ— è¾¹æ¡†è®¾ç½®
            this.apps[id].fixed = metadata.fixed; // ğŸ“Œ æ›´æ–°å›ºå®šä½ç½®è®¾ç½®
            this.apps[id].width = metadata.width; // ğŸ“ æ›´æ–°å®½åº¦
            this.apps[id].height = metadata.height; // ğŸ“ æ›´æ–°é«˜åº¦
        } else { // ğŸ†• å¦‚æœæ˜¯æ–°åº”ç”¨
            // ğŸ†• ä¿®å¤ï¼šå¦‚æœåº”ç”¨ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡æ‡’åŠ è½½ï¼‰ï¼Œç›´æ¥ä½¿ç”¨å…ƒæ•°æ®åˆå§‹åŒ–
            // ä½¿ç”¨è§£æ„å¤åˆ¶ï¼Œé¿å…ç›´æ¥å¼•ç”¨æ¨¡å—å¯¼å‡ºçš„å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ– isOpen çŠ¶æ€
            this.apps[id] = { ...metadata, isOpen: false }; 
        }
        this.save(); // ğŸ’¾ ä¿å­˜çŠ¶æ€
    }
}

// å¯¼å‡ºå•ä¾‹
export const store = new Store(); // ğŸ’¾ å…¨å±€å”¯ä¸€çš„å­˜å‚¨å®ä¾‹
