import { store } from '../system/store.js'; // ğŸ’– å¼•å…¥å…¨å±€çŠ¶æ€ç®¡ç†
import { bus } from '../system/event_bus.js'; // ğŸ’– å¼•å…¥äº‹ä»¶æ€»çº¿

export const VERSION = '1.0.0'; // ğŸ’– ç‰ˆæœ¬å·

// =================================
//  ğŸ‰ æ¡Œé¢é…ç½®å¯¹è±¡
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//     å®šä¹‰æ¡Œé¢æœåŠ¡çš„å…ƒæ•°æ®ï¼Œå¦‚ IDã€åç§°ã€ç±»å‹ç­‰ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//     è¿™æ˜¯æ¡Œé¢çš„â€œèº«ä»½è¯â€ï¼Œå‘Šè¯‰ç³»ç»Ÿå®ƒæ˜¯è°ï¼Œè´Ÿè´£ç®¡ç†é‚£äº›æ¼‚äº®çš„å›¾æ ‡ï¼ğŸ“‡
//
//  âš ï¸ è­¦å‘Šï¼š
//     isSystem: true æ ‡è®°è¿™æ˜¯ç³»ç»Ÿçº§æœåŠ¡ï¼Œä¸å¯è¢«æ™®é€šç”¨æˆ·å¸è½½ã€‚
// =================================
export const config = {
    id: 'sys-desktop',
    name: 'æ¡Œé¢',
    version: '1.0.0', // ğŸ†• ç‰ˆæœ¬å·
    type: 'service',
    isSystem: true,
    description: 'ç³»ç»Ÿæ¡Œé¢å›¾æ ‡ç®¡ç†å™¨'
};

// =================================
//  ğŸ‰ åˆå§‹åŒ–å‡½æ•° (æ— å‚æ•°)
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//     å¯åŠ¨æ¡Œé¢æ¸²æŸ“ï¼Œå¹¶ç›‘å¬åº”ç”¨é‡å‘½åäº‹ä»¶ä»¥æ›´æ–°å›¾æ ‡ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//     æ¡Œé¢å¯åŠ¨å•¦ï¼å…ˆæŠŠå›¾æ ‡ç”»å‡ºæ¥ï¼Œç„¶åç«–èµ·è€³æœµå¬ï¼šâ€œæœ‰æ²¡æœ‰åº”ç”¨æ”¹åå­—å•¦ï¼Ÿâ€ ğŸ‘‚
//
//  âš ï¸ è­¦å‘Šï¼š
//     ä¾èµ– DOM ä¸­ id="desktop" çš„å…ƒç´ ã€‚
// =================================
export function init() {
    render(); // ğŸ’– åˆå§‹æ¸²æŸ“æ¡Œé¢å›¾æ ‡
    
    // ç›‘å¬åº”ç”¨é‡å‘½åäº‹ä»¶
    bus.on('app:renamed', () => render()); // ğŸ’– å½“åº”ç”¨æ”¹åæ—¶ï¼Œé‡æ–°æ¸²æŸ“å›¾æ ‡
}

// =================================
//  ğŸ‰ æ¸²æŸ“æ¡Œé¢å›¾æ ‡ (æ— å‚æ•°)
//
//  ğŸ¨ ä»£ç ç”¨é€”ï¼š
//     æ ¹æ®å·²å®‰è£…çš„åº”ç”¨åˆ—è¡¨ï¼Œåœ¨æ¡Œé¢ä¸ŠåŠ¨æ€ç”Ÿæˆå›¾æ ‡å…ƒç´ ã€‚
//
//  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
//     æŠŠä½ çš„åº”ç”¨ä¸€ä¸ªä¸ªæ‘†åœ¨æ¡Œé¢ä¸Šï¼Œå°±åƒæ•´ç†ä¹¦æ¡Œä¸€æ ·ï¼ğŸ“š
//     ç³»ç»Ÿåº”ç”¨å’Œä¸æƒ³æ˜¾ç¤ºçš„åº”ç”¨ä¼šè¢«è—èµ·æ¥å“¦~
//
//  âš ï¸ è­¦å‘Šï¼š
//     ä¼šæ¸…ç©º #desktop ä¸‹æ‰€æœ‰ .desktop-icon å…ƒç´ ï¼Œä½†ä¿ç•™ drag-overlayã€‚
// =================================
function render() {
    const dt = document.getElementById('desktop'); // ğŸ’– è·å–æ¡Œé¢å®¹å™¨å…ƒç´ 
    if (!dt) return; // ğŸ’– å¦‚æœæ‰¾ä¸åˆ°æ¡Œé¢å®¹å™¨ï¼Œç›´æ¥è¿”å›
    
    // ğŸ§¹ æ¸…é™¤æ—§çš„å›¾æ ‡å…ƒç´  (ä¿ç•™ drag-overlay)
    dt.querySelectorAll('.desktop-icon').forEach(e => e.remove()); // ğŸ’– ç§»é™¤æ‰€æœ‰æ—§çš„å›¾æ ‡

    // ğŸ’– æ¸²æŸ“é€»è¾‘å‡çº§ï¼šä¼˜å…ˆä½¿ç”¨ installedApps (åŒ…å«æ‰€æœ‰å·²å®‰è£…åº”ç”¨)ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ° store.apps
    // è¿™æ ·å³ä½¿åº”ç”¨ä»æœªæ‰“å¼€è¿‡ (store.apps é‡Œæ²¡æœ‰)ï¼Œåªè¦å®‰è£…äº† (installedApps é‡Œæœ‰)ï¼Œä¹Ÿèƒ½æ˜¾ç¤ºå›¾æ ‡
    const source = Object.keys(store.installedApps).length > 0 ? store.installedApps : store.apps;

    Object.entries(source).forEach(([id, app]) => { // ğŸ’– éå†æ‰€æœ‰åº”ç”¨
        const pathData = app.icon || app.iconPath; // ğŸ’– è·å–å›¾æ ‡è·¯å¾„æ•°æ®
        if (!pathData) return; // ğŸ’– å¦‚æœæ²¡æœ‰å›¾æ ‡æ•°æ®ï¼Œè·³è¿‡
        
        // ğŸ’– è¿‡æ»¤æ‰ç³»ç»Ÿåº”ç”¨
        if (app.isSystem) return; // ğŸ’– ç³»ç»Ÿåº”ç”¨é€šå¸¸ä¸æ˜¾ç¤ºåœ¨æ¡Œé¢

        // ğŸ’– è¿‡æ»¤æ‰æ˜¾å¼é…ç½®ä¸æ˜¾ç¤ºçš„åº”ç”¨
        if (app.showDesktopIcon === false) return; // ğŸ’– å¦‚æœé…ç½®äº†ä¸æ˜¾ç¤ºæ¡Œé¢å›¾æ ‡ï¼Œè·³è¿‡
        
        // ğŸ’– è·å–ä½ç½®ä¿¡æ¯ (ä¼˜å…ˆä» store.apps è·å–ç”¨æˆ·è‡ªå®šä¹‰ä½ç½®ï¼Œå¦åˆ™ç”¨é»˜è®¤ä½ç½®)
        const userState = store.apps[id] || {}; // ğŸ’– è·å–åº”ç”¨çš„ç”¨æˆ·çŠ¶æ€
        const pos = userState.pos || app.pos || { x: 20, y: 20 }; // ğŸ’– ç¡®å®šå›¾æ ‡åæ ‡

        const el = document.createElement('div'); // ğŸ’– åˆ›å»ºå›¾æ ‡å®¹å™¨
        el.className = 'desktop-icon'; // ğŸ’– æ·»åŠ  CSS ç±»å
        el.id = `icon-${id}`; // ğŸ’– è®¾ç½®å”¯ä¸€ ID
        el.style.left = `${pos.x}px`; // ğŸ’– è®¾ç½®æ°´å¹³ä½ç½®
        el.style.top = `${pos.y}px`; // ğŸ’– è®¾ç½®å‚ç›´ä½ç½®
        el.dataset.id = id; // ğŸ’– å­˜å‚¨åº”ç”¨ ID
        el.dataset.type = 'icon'; // ğŸ’– æ ‡è®°ç±»å‹ä¸ºå›¾æ ‡

        el.innerHTML = `
            <svg class="icon-svg" viewBox="0 0 24 24" fill="${app.color || '#ccc'}">
                <path d="${pathData}"/> <!-- ğŸ’– ç»˜åˆ¶ SVG å›¾æ ‡è·¯å¾„ -->
            </svg>
            <div class="icon-text">${app.name}</div> <!-- ğŸ’– æ˜¾ç¤ºåº”ç”¨åç§° -->
        `;
        
        dt.appendChild(el); // ğŸ’– å°†å›¾æ ‡æ·»åŠ åˆ°æ¡Œé¢
    });
}
