import { bus } from '../system/event_bus.js'; // ğŸ’– å¯¼å…¥äº‹ä»¶æ€»çº¿ï¼Œè™½ç„¶å½“å‰æ–‡ä»¶æš‚æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥å¤‡æ‰©å±•

export const VERSION = '1.0.0'; // ğŸ’– ç‰ˆæœ¬å·

export class ContextMenuApp {
    // =================================
    //  ğŸ‰ ä»ªå¼èœå•ç±» (æ— å‚æ•°)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     ç®¡ç†è‡ªå®šä¹‰å³é”®èœå•çš„æ˜¾ç¤ºã€éšè—å’Œäº¤äº’é€»è¾‘
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     è¿™æ˜¯ä½ çš„â€œé­”æ³•ä¹¦â€ï¼å½“ä½ å¿µå‡ºå’’è¯­ï¼ˆç‚¹å‡»å³é”®ï¼‰ï¼Œå®ƒå°±ä¼šæµ®ç°å‡ºæ¥ï¼Œä¾›ä½ é€‰æ‹©è¦æ–½å±•çš„æ³•æœ¯~ ğŸ“–
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     èœå•çš„æ ·å¼ï¼ˆå¦‚èƒŒæ™¯è‰²ã€è¾¹æ¡†ï¼‰ä¾èµ– CSS ç±» .context-menu å’Œ .menu-itemï¼Œä¿®æ”¹æ ·å¼æ—¶è¯·æ³¨æ„ã€‚
    // =================================
    constructor() {
        this.config = {
            id: 'sys-context-menu',
            name: 'å³é”®èœå•',
            version: '1.0.0',
            type: 'service',
            isSystem: true
        };
        this.menu = null; // ğŸ’– èœå• DOM å…ƒç´ ï¼Œç¨ååœ¨ init ä¸­è·å–
        this.isVisible = false; // ğŸ’– èœå•å½“å‰æ˜¯å¦å¯è§çš„çŠ¶æ€æ ‡è®°

        // ç»‘å®š this
        this.hide = this.hide.bind(this); // ğŸ’– ç¡®ä¿ hide æ–¹æ³•åœ¨ä½œä¸ºå›è°ƒä¼ é€’æ—¶ï¼Œthis ä¾ç„¶æŒ‡å‘å½“å‰å®ä¾‹
        
        // è‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', () => this.init()); // ğŸ’– ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åï¼Œè‡ªåŠ¨æ‰§è¡Œåˆå§‹åŒ–
    }

    // =================================
    //  ğŸ‰ åˆå§‹åŒ–å‡½æ•° (æ— å‚æ•°)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     è·å–èœå• DOM å…ƒç´ å¹¶è®¾ç½®å…¨å±€ç‚¹å‡»ç›‘å¬ä»¥å…³é—­èœå•
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     å‡†å¤‡å¥½é­”æ³•ä¹¦ï¼Œå¹¶å‘Šè¯‰å®ƒï¼šâ€œåªè¦æˆ‘ç‚¹åˆ«çš„åœ°æ–¹ï¼Œä½ å°±èµ¶ç´§è—èµ·æ¥ï¼â€ ğŸ¤«
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     ä¾èµ– DOM ä¸­ id="context-menu" çš„å…ƒç´ ã€‚
    // =================================
    init() {
        this.menu = document.getElementById('context-menu'); // ğŸ’– è·å– HTML ä¸­é¢„å®šä¹‰çš„èœå•å®¹å™¨å…ƒç´ 
        
        // ç‚¹å‡»ä»»æ„åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', (e) => {
            // ğŸ’– å¦‚æœèœå•æ˜¯æ‰“å¼€çš„ï¼Œä¸”ç‚¹å‡»çš„ä½ç½®ä¸åœ¨èœå•å†…éƒ¨
            if (this.isVisible && !this.menu.contains(e.target)) {
                this.hide(); // ğŸ’– éšè—èœå•
            }
        });

        // æ»šåŠ¨æ—¶ä¹Ÿå…³é—­èœå•
        document.addEventListener('scroll', this.hide, true); // ğŸ’– é¡µé¢æ»šåŠ¨æ—¶ï¼Œå¼ºåˆ¶éšè—èœå•ï¼Œé˜²æ­¢ä½ç½®é”™ä¹±
    }

    // =================================
    //  ğŸ‰ æ˜¾ç¤ºèœå• (Xåæ ‡, Yåæ ‡, èœå•é¡¹åˆ—è¡¨)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     åœ¨æŒ‡å®šä½ç½®æ¸²æŸ“å¹¶æ˜¾ç¤ºèœå•ï¼ŒåŠ¨æ€ç”Ÿæˆèœå•é¡¹
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     åœ¨ä½ çš„æŒ‡å°–å¬å”¤é­”æ³•ä¹¦ï¼æŠŠä½ æƒ³ç”¨çš„æ³•æœ¯ï¼ˆèœå•é¡¹ï¼‰éƒ½åˆ—å‡ºæ¥~ âœ¨
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     items æ•°ç»„ä¸­çš„ action å¿…é¡»æ˜¯å‡½æ•°ï¼Œå¦åˆ™ç‚¹å‡»ä¼šæŠ¥é”™ã€‚
    // =================================
    show(x, y, items) {
        if (!this.menu) return; // ğŸ’– å¦‚æœèœå•å…ƒç´ æœªæ‰¾åˆ°ï¼Œç›´æ¥è¿”å›

        // 1. ç”Ÿæˆèœå•å†…å®¹
        this.menu.innerHTML = ''; // ğŸ’– æ¸…ç©ºæ—§çš„èœå•é¡¹
        items.forEach(item => { // ğŸ’– éå†ä¼ å…¥çš„èœå•é¡¹æ•°æ®
            const el = document.createElement('div'); // ğŸ’– åˆ›å»ºèœå•é¡¹å®¹å™¨
            el.className = 'menu-item'; // ğŸ’– æ·»åŠ  CSS ç±»å
            // ç®€å•çš„å†…è”æ ·å¼ï¼Œå»ºè®®åç»­ç§»å…¥ CSS æ–‡ä»¶
            el.style.padding = '8px 12px'; // ğŸ’– è®¾ç½®å†…è¾¹è·
            el.style.cursor = 'pointer'; // ğŸ’– è®¾ç½®é¼ æ ‡æ ·å¼ä¸ºæ‰‹å‹
            el.style.display = 'flex'; // ğŸ’– ä½¿ç”¨ Flex å¸ƒå±€
            el.style.alignItems = 'center'; // ğŸ’– å‚ç›´å±…ä¸­å¯¹é½
            el.style.gap = '8px'; // ğŸ’– å›¾æ ‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è·
            el.style.backgroundColor = 'rgba(0, 0, 0, 0.8)'; // ğŸ’– è®¾ç½®åŠé€æ˜é»‘è‰²èƒŒæ™¯
            el.style.color = '#fff'; // ğŸ’– è®¾ç½®æ–‡å­—é¢œè‰²ä¸ºç™½è‰²
            el.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)'; // ğŸ’– æ·»åŠ åº•éƒ¨ç»†çº¿åˆ†éš”ç¬¦

            // é¼ æ ‡æ‚¬åœæ•ˆæœ
            el.onmouseenter = () => el.style.backgroundColor = 'var(--primary-color)'; // ğŸ’– é¼ æ ‡ç§»å…¥æ—¶é«˜äº®
            el.onmouseleave = () => el.style.backgroundColor = 'rgba(0, 0, 0, 0.8)'; // ğŸ’– é¼ æ ‡ç§»å‡ºæ—¶æ¢å¤èƒŒæ™¯

            el.innerHTML = `
                ${item.icon ? `<span>${item.icon}</span>` : ''} <!-- ğŸ’– å¦‚æœæœ‰å›¾æ ‡ï¼Œæ˜¾ç¤ºå›¾æ ‡ -->
                <span>${item.label}</span> <!-- ğŸ’– æ˜¾ç¤ºèœå•é¡¹æ–‡å­— -->
            `;

            el.onclick = (e) => {
                e.stopPropagation(); // ğŸ’– é˜²æ­¢è§¦å‘å…¨å±€ç‚¹å‡»å…³é—­äº‹ä»¶
                item.action(); // ğŸ’– æ‰§è¡Œè¯¥èœå•é¡¹å¯¹åº”çš„åŠ¨ä½œå‡½æ•°
                this.hide(); // ğŸ’– åŠ¨ä½œæ‰§è¡Œå®Œåå…³é—­èœå•
            };

            this.menu.appendChild(el); // ğŸ’– å°†èœå•é¡¹æ·»åŠ åˆ°èœå•å®¹å™¨ä¸­
        });

        // 2. è®¾ç½®ä½ç½®
        this.menu.style.left = `${x}px`; // ğŸ’– è®¾ç½®èœå•çš„æ°´å¹³ä½ç½®
        this.menu.style.top = `${y}px`; // ğŸ’– è®¾ç½®èœå•çš„å‚ç›´ä½ç½®
        this.menu.style.display = 'block'; // ğŸ’– æ˜¾ç¤ºèœå•

        // 3. è¾¹ç•Œæ£€æŸ¥ (é˜²æ­¢èœå•è¶…å‡ºå±å¹•)
        const rect = this.menu.getBoundingClientRect(); // ğŸ’– è·å–èœå•æ¸²æŸ“åçš„å°ºå¯¸å’Œä½ç½®
        if (rect.right > window.innerWidth) { // ğŸ’– å¦‚æœèœå•å³ä¾§è¶…å‡ºå±å¹•å®½åº¦
            this.menu.style.left = `${window.innerWidth - rect.width - 5}px`; // ğŸ’– å‘å·¦ç§»åŠ¨ï¼Œä½¿å…¶å®Œå…¨æ˜¾ç¤º
        }
        if (rect.bottom > window.innerHeight) { // ğŸ’– å¦‚æœèœå•åº•éƒ¨è¶…å‡ºå±å¹•é«˜åº¦
            this.menu.style.top = `${window.innerHeight - rect.height - 5}px`; // ğŸ’– å‘ä¸Šç§»åŠ¨ï¼Œä½¿å…¶å®Œå…¨æ˜¾ç¤º
        }

        this.isVisible = true; // ğŸ’– æ ‡è®°èœå•ä¸ºå¯è§çŠ¶æ€
    }

    // =================================
    //  ğŸ‰ éšè—èœå• (æ— å‚æ•°)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     éšè—èœå• DOM å…ƒç´ å¹¶æ›´æ–°çŠ¶æ€
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     æ”¶èµ·é­”æ³•ä¹¦ï¼Œä¸‹æ¬¡å†è§ï¼ğŸ‘‹
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     æ— 
    // =================================
    hide() {
        if (this.menu) { // ğŸ’– ç¡®ä¿èœå•å…ƒç´ å­˜åœ¨
            this.menu.style.display = 'none'; // ğŸ’– éšè—èœå•
            this.isVisible = false; // ğŸ’– æ ‡è®°èœå•ä¸ºä¸å¯è§çŠ¶æ€
        }
    }
}

export const contextMenuApp = new ContextMenuApp(); // ğŸ’– å¯¼å‡ºå•ä¾‹å®ä¾‹ä¾›å…¨å±€ä½¿ç”¨
