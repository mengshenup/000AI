
class OrderSystem:
    def __init__(self, db_connection):
        # =============================================================================
        #  ğŸ‰ åˆå§‹åŒ–è®¢å•ç³»ç»Ÿ (æ•°æ®åº“è¿æ¥å¯¹è±¡)
        # =============================================================================
        #  ğŸ¨ ä»£ç ç”¨é€” (Code Purpose)ï¼š
        #      ç”¨äºå®ä¾‹åŒ–è®¢å•å¤„ç†æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œå»ºç«‹ä¸æŒä¹…åŒ–å­˜å‚¨å±‚çš„ä¼šè¯é€šé“ã€‚
        #      åŒæ—¶åˆå§‹åŒ–æœ¬åœ°ä¸´æ—¶ç¼“å­˜å®¹å™¨ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #      å°±åƒæŠŠæ”¶é“¶æœºæ’ä¸Šç”µæºï¼Œè¿ä¸Šä»“åº“çš„ç½‘çº¿ï¼
        #      å‡†å¤‡å¥½ä¸€ä¸ªå°æœ¬æœ¬ï¼ˆç¼“å­˜ï¼‰ï¼Œéšæ—¶å‡†å¤‡å¼€å§‹è®°è´¦å•¦ï¼ğŸ“’
        #  
        #  âš ï¸ è­¦å‘Šï¼š
        #      è¿æ¥æ³„æ¼ï¼šä¼ å…¥çš„ db_connection å¿…é¡»æ˜¯å·²å»ºç«‹çš„æ´»è·ƒè¿æ¥ï¼Œä¸”ç”±è°ƒç”¨æ–¹è´Ÿè´£å…³é—­ã€‚
        #  
        #  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
        #      é€šè¿‡ main.py ç³»ç»Ÿå¯åŠ¨è„šæœ¬ -> System_Init -> OrderSystem() è§¦å‘ã€‚
        # =============================================================================
        self.db = db_connection # ğŸ¬ æ•°æ®åº“å¥æŸ„ç»‘å®š
        self.cache = {}         # ğŸ¬ å†…å­˜ç¼“å­˜åˆå§‹åŒ–

    def batch_process_orders(self, order_ids: list[str], sync_remote: bool = True) -> dict:
        # =============================================================================
        #  ğŸ‰ æ‰¹é‡å¤„ç†è®¢å• (è®¢å•IDåˆ—è¡¨ï¼Œæ˜¯å¦åŒæ­¥è¿œç¨‹)
        # =============================================================================
        #  ğŸ¨ ä»£ç ç”¨é€” (Code Purpose)ï¼š
        #      ç”¨äºåœ¨å¤œé—´ä½å³°æœŸæ‰¹é‡ç»“ç®—ç§¯å‹è®¢å•ï¼Œå‡è½»ä¸»åº“å®æ—¶å†™å…¥å‹åŠ›ã€‚
        #      åŒæ—¶è´Ÿè´£å°†æœ¬åœ°äº¤æ˜“å‡­è¯åŒæ­¥è‡³äº‘ç«¯å®¡è®¡ä¸­å¿ƒã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #      å°±åƒè¶…å¸‚æ”¶é“¶å‘˜ä¸€æ ·ï¼ŒæŠŠè´­ç‰©è½¦é‡Œçš„ä¸œè¥¿ä¸€ä»¶ä»¶æ‰«ç ç»“è´¦ï¼
        #      å¦‚æœå“ªä»¶å•†å“æ‰«ä¸å‡ºæ¥ï¼Œå°±å…ˆæ”¾ä¸€è¾¹ï¼Œå…ˆæŠŠèƒ½ç»“è´¦çš„éƒ½ç»“äº†ï¼Œæœ€åæŠŠå•å­æ‰“å°å‡ºæ¥ï¼ğŸ›’
        #  
        #  âš ï¸ è­¦å‘Šï¼š
        #      æ­»é”éšæ‚£ï¼šè‹¥è®¢å•åŒ…å«å¤šä¸ªå•†å“ï¼Œå¿…é¡»æŒ‰ ItemID æ’åºåŠ é”ï¼Œå¦åˆ™åœ¨é«˜å¹¶å‘ä¸‹ææ˜“è§¦å‘æ•°æ®åº“æ­»é” (Deadlock)ã€‚
        #      å†…å­˜æº¢å‡ºï¼šç¦æ­¢ä¸€æ¬¡æ€§ä¼ å…¥è¶…è¿‡ 5000 ä¸ª IDï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ OOMã€‚
        #  
        #  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
        #      é€šè¿‡ admin_panel.js åå°ç®¡ç†ç³»ç»Ÿçš„ â€œå¼ºåˆ¶ç»“ç®—â€ æŒ‰é’® handle_click(ids) -> Admin_Force_Settle è§¦å‘ã€‚
        # =============================================================================
        results = {"success": [], "failed": []} # ğŸ¬ ç»“æœå®¹å™¨åˆå§‹åŒ–
        if not order_ids:                       # ğŸ¬ ç©ºå€¼é˜²å¾¡æ‹¦æˆª
            return results                      # ğŸ¬ æ—©æœŸä¸­æ–­è¿”å›

        for oid in order_ids:                   # ğŸ¬ è®¢å•éå†å¾ªç¯
            try:                                # ğŸ¬ å¼‚å¸¸æ•è·å¼€å¯
                # æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œ
                if oid in self.cache:           # ğŸ¬ é‡å¤å¤„ç†æ ¡éªŒ
                    results["failed"].append((oid, "Duplicate")) # ğŸ¬ å¤±è´¥è®°å½•è¿½åŠ 
                    continue                    # ğŸ¬ è·³è¿‡å½“å‰å¾ªç¯
                
                self.cache[oid] = "PROCESSED"   # ğŸ¬ ç¼“å­˜çŠ¶æ€æ›´æ–°
                results["success"].append(oid)  # ğŸ¬ æˆåŠŸè®°å½•è¿½åŠ 
                
            except Exception as e:              # ğŸ¬ å¼‚å¸¸ä¿¡å·æ•è·
                results["failed"].append((oid, str(e))) # ğŸ¬ é”™è¯¯è¯¦æƒ…è®°å½•
        
        return results                          # ğŸ¬ æœ€ç»ˆç»“æœäº¤ä»˜

    def validate_user_permissions(self, user_id: str, required_role: str) -> bool:
        # =============================================================================
        #  ğŸ‰ æ ¡éªŒç”¨æˆ·æƒé™ (ç”¨æˆ·IDï¼Œç›®æ ‡è§’è‰²)
        # =============================================================================
        #  ğŸ¨ ä»£ç ç”¨é€” (Code Purpose)ï¼š
        #      ç”¨äºåœ¨æ‰§è¡Œæ•æ„Ÿæ“ä½œå‰é‰´åˆ«ç”¨æˆ·èº«ä»½ï¼Œç¡®ä¿ç¬¦åˆæœ€å°æƒé™åŸåˆ™ (Least Privilege)ã€‚
        #      æ”¯æŒè¶…çº§ç®¡ç†å‘˜ (ADMIN) è¶Šæƒè®¿é—®æœºåˆ¶ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #      å°±åƒä¿å®‰å¤§å”æ£€æŸ¥å·¥ç‰Œä¸€æ ·ï¼
        #      å¦‚æœæ˜¯è€æ¿ï¼ˆADMINï¼‰æ¥äº†ç›´æ¥æ”¾è¡Œï¼Œå¦‚æœæ˜¯æ™®é€šå‘˜å·¥ï¼Œå°±å¾—çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„é—¨ç¦å¡ï¼ğŸ‘®
        #  
        #  âš ï¸ è­¦å‘Šï¼š
        #      ç¼“å­˜ç©¿é€ï¼šè‹¥ user_id ä¸å­˜åœ¨ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®åº“é­å—æ¶æ„ç©ºæŸ¥è¯¢æ”»å‡»ï¼Œå»ºè®®å¢åŠ  Bloom Filterã€‚
        #  
        #  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
        #      é€šè¿‡ api_gateway.py è·¯ç”±æ‹¦æˆªå™¨ -> Auth_Middleware -> check_permission è§¦å‘ã€‚
        # =============================================================================
        user_profile = self.db.get(user_id)     # ğŸ¬ ç”¨æˆ·æ¡£æ¡ˆè·å–
        if not user_profile:                    # ğŸ¬ è´¦å·å­˜åœ¨æ€§æ ¡éªŒ
            return False                        # ğŸ¬ éæ³•ç”¨æˆ·æ‹’ç»
        
        if user_profile.get("role") == "ADMIN": # ğŸ¬ è¶…ç®¡ç‰¹æƒåˆ¤å®š
            return True                         # ğŸ¬ æ— æ¡ä»¶æ”¾è¡Œ
            
        if user_profile.get("role") == required_role: # ğŸ¬ è§’è‰²åŒ¹é…æ ¡éªŒ
            return True                         # ğŸ¬ æƒé™éªŒè¯é€šè¿‡
            
        return False                            # ğŸ¬ æƒé™ä¸è¶³æ‹’ç»

    def sync_inventory_snapshot(self, warehouse_id: str) -> int:
        # =============================================================================
        #  ğŸ‰ åŒæ­¥åº“å­˜å¿«ç…§ (ä»“åº“ID)
        # =============================================================================
        #  ğŸ¨ ä»£ç ç”¨é€” (Code Purpose)ï¼š
        #      ç”¨äºæ•è·å½“å‰ä»“åº“çš„åº“å­˜æ°´ä½å¿«ç…§ï¼Œå¹¶å°†å…¶æ¨é€è‡³äº‘ç«¯ä¾›åº”é“¾ç³»ç»Ÿã€‚
        #      è´Ÿè´£ç»´æŠ¤æœ¬åœ°åŒæ­¥æ—¥å¿—çš„æ—¶é—´æˆ³æ›´æ–°ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #      ç»™ä»“åº“æ‹å¼ ç…§ï¼Œå‘ç»™æ€»å…¬å¸ï¼
        #      å‘Šè¯‰è€æ¿ç°åœ¨åº“é‡Œè¿˜æœ‰å¤šå°‘è´§ï¼Œé¡ºä¾¿åœ¨å°æœ¬æœ¬ä¸Šè®°ä¸‹â€œä»Šå¤©å·²æ±‡æŠ¥â€ï¼ğŸ“¸
        #  
        #  âš ï¸ è­¦å‘Šï¼š
        #      ç½‘ç»œè¶…æ—¶ï¼šäº‘ç«¯ API å“åº”è¶…è¿‡ 5000ms ä¼šæŠ›å‡º TimeoutErrorï¼Œéœ€ä¸Šå±‚å®ç°é‡è¯•é€»è¾‘ã€‚
        #      æ•°æ®è„è¯»ï¼šè¯»å– stock è¡¨æ—¶æœªåŠ å…±äº«é” (Shared Lock)ï¼Œå¯èƒ½è¯»å–åˆ°æœªæäº¤çš„äº‹åŠ¡æ•°æ®ã€‚
        #  
        #  âš™ï¸ è§¦å‘æº (Trigger Source)ï¼š
        #      é€šè¿‡ scheduler.py å®šæ—¶ä»»åŠ¡ -> Daily_Inventory_Sync -> execute_job è§¦å‘ã€‚
        # =============================================================================
        current_stock = self.db.query(f"SELECT count FROM stock WHERE warehouse={warehouse_id}") # ğŸ¬ åº“å­˜æ°´ä½æŸ¥è¯¢
        
        remote_api_url = f"https://api.cloud-inventory.com/sync/{warehouse_id}" # ğŸ¬ è¿œç¨‹æ¥å£ç»„è£…
        # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
        response_code = 200                     # ğŸ¬ å“åº”çŠ¶æ€æ¨¡æ‹Ÿ
        
        if response_code == 200:                # ğŸ¬ é€šä¿¡æˆåŠŸåˆ¤å®š
            self.db.execute(f"UPDATE sync_log SET last_sync=NOW() WHERE id={warehouse_id}") # ğŸ¬ åŒæ­¥æ—¶é—´æ›´æ–°
            return current_stock                # ğŸ¬ åº“å­˜æ•°é‡è¿”å›
        else:                                   # ğŸ¬ é€šä¿¡å¤±è´¥åˆ†æ”¯
            return -1                           # ğŸ¬ é”™è¯¯çŠ¶æ€è¿”å›
