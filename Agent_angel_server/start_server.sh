#!/bin/bash
# ==========================================================================
#  📃 文件功能 : 服务器启动脚本 (Linux/macOS)
#  ⚡ 逻辑摘要 : 自动清理端口占用，安装依赖，并循环启动 Python 主服务。
#  💡 易懂解释 : 这是一个 "自动重启开关"，保证服务器一直开着。
#  🔋 未来扩展 : 支持后台运行模式 (nohup)，支持日志重定向。
#  📊 当前状态 : 活跃 (更新: 2025-12-06)
#  🧱 Agent_angel_server/start_server.sh 踩坑记录 :
#     1. [2025-12-04] [已修复] [路径问题]: 相对路径导致找不到模块。 -> 使用 DIR 变量获取绝对路径。
# ==========================================================================

PORT=8000 # 🔌 服务端口
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )" # 📂 获取脚本所在目录
cd "$DIR" # 📍 切换工作目录

echo "========================================================" # 📢 输出分隔符
echo " 🎉 Angel Agent Server (Port $PORT)" # 📢 输出标题
echo "========================================================" # 📢 输出分隔符

while true; do # 🔄 进入主循环
    # =============================================================================
    #  🎉 [Loop] 主循环
    #
    #  🎨 代码用途：
    #      确保服务崩溃后自动重启。
    #
    #  💡 易懂解释:
    #      "倒下了？扶起来接着跑！"
    #
    #  ⚠️ 警告:
    #      [死循环]: 如果启动失败会无限重试，需手动 Ctrl+C 终止。
    #
    #  ⚙️ 触发源:
    #      Script Execution
    # =============================================================================
    echo "" # 📄 输出空行
    echo "[启动] 正在检查端口 $PORT..." # 📢 输出检查提示
    
    # 清理端口
    PID=$(lsof -t -i:$PORT) # 🔍 查找占用端口的进程
    if [ -n "$PID" ]; then # ⚖️ 判断是否存在
        echo "[清理] 端口 $PORT 被占用，PID: $PID" # 📢 输出清理提示
        kill -9 $PID # 🛑 强制终止进程
        sleep 1 # ⏳ 等待释放
    fi

    echo "[环境] 正在检查依赖库..." # 📢 输出环境检查提示
    pip3 install -r requirements.txt # 📦 安装/更新依赖

    echo "[启动] 正在启动 Agent 服务..." # 📢 输出启动提示
    export PYTHONPATH="$DIR" # 🔧 设置 Python 路径
    python3 Brain/Main.py # 🚀 启动主程序

    echo "" # 📄 输出空行
    echo "[警告] 服务器已停止。" # 📢 输出停止警告
    echo "[提示] 按回车键重启，或按 Ctrl+C 退出..." # 📢 输出操作提示
    read # ⏸️ 等待用户确认
done # 🔄 结束循环