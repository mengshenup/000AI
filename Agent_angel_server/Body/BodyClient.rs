/* ==========================================================================
   ğŸ“ƒ æ–‡ä»¶åŠŸèƒ½ : èº«ä½“å®¢æˆ·ç«¯ (Body Client) - è´Ÿè´£ä¸ Python æµè§ˆå™¨æ‰§è¡Œå±‚é€šä¿¡
   âš¡ é€»è¾‘æ‘˜è¦ : å°è£… HTTP è¯·æ±‚ï¼Œå°† Rust ç«¯çš„ BrowserAction è½¬æ¢ä¸º JSON å‘é€ç»™ Python Workerï¼Œå¹¶å¤„ç†å“åº”æ•°æ®ï¼ˆå¦‚ Base64 æˆªå›¾è§£ç ï¼‰ã€‚
   ğŸ’¡ æ˜“æ‡‚è§£é‡Š : è¿™é‡Œè´Ÿè´£å¼€å¿ƒåœ°æŠŠ Rust çš„æŒ‡ä»¤é€ç»™ Python æœ‹å‹ï¼Œè®©å®ƒå¸®å¿™æ“ä½œæµè§ˆå™¨ï¼Œç„¶åå†æŠŠç»“æœå¸¦å›æ¥ï¼
   ğŸ”‹ æœªæ¥æ‰©å±• : æ”¯æŒ WebSocket é•¿è¿æ¥ä»¥é™ä½ HTTP æ¡æ‰‹å»¶è¿Ÿï¼›å¢åŠ é‡è¯•æœºåˆ¶ã€‚
   ğŸ“Š å½“å‰çŠ¶æ€ : æ´»è·ƒ (æ›´æ–°: 2025-12-06)
   ğŸ§± Body/BodyClient.rs è¸©å‘è®°å½• (ç´¯ç§¯ï¼Œå‹¿è¦†ç›–) :
      1. [2025-12-04] [å·²ä¿®å¤] [æˆªå›¾æ ¼å¼]: Python è¿”å› JSON åŒ…è£…çš„ Base64ï¼Œè€Œéç›´æ¥äºŒè¿›åˆ¶ã€‚ -> éœ€å…ˆè§£æ JSONã€‚ (Line 108)
   ========================================================================== */

use reqwest::Client; // ğŸ“¦ å¼•å…¥ HTTP å®¢æˆ·ç«¯
use serde_json::json; // ğŸ“¦ å¼•å…¥ JSON å®
use crate::data_models::BrowserAction; // ğŸ“¦ å¼•å…¥æµè§ˆå™¨åŠ¨ä½œ
use base64::{Engine as _, engine::general_purpose::STANDARD as BASE64_STANDARD}; // ğŸ“¦ å¼•å…¥ Base64 å¼•æ“

// Hardcoded for now as config module is gone/moved
const PYTHON_WORKER_URL: &str = "http://localhost:8001"; // ğŸ”— å®šä¹‰ Worker åœ°å€

#[derive(Clone)] // ğŸ§¬ æ´¾ç”Ÿå…‹éš†ç‰¹æ€§
pub struct BrowserClient {
    // =============================================================================
    //  ğŸ‰ æµè§ˆå™¨å®¢æˆ·ç«¯
    //
    //  ğŸ¨ ä»£ç ç”¨é€”:
    //      æŒæœ‰ reqwest::Client å®ä¾‹ï¼Œä½œä¸º HTTP è¿æ¥æ± çš„è½½ä½“ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    //      è¿™ä¸ªå°ç›’å­è£…ç€ç¥å¥‡çš„ç”µè¯ï¼Œä¸“é—¨ç”¨æ¥å’Œ Python æœ‹å‹èŠå¤©å»ºç«‹è¿æ¥å“¦ï¼
    //
    //  âš ï¸ è­¦å‘Š:
    //      [èµ„æºå ç”¨]: æ¯ä¸ªå®ä¾‹ç»´æŠ¤ä¸€ä¸ªè¿æ¥æ± ï¼Œåº”å°½é‡å¤ç”¨ã€‚
    //
    //  âš™ï¸ è§¦å‘æº:
    //      é€šè¿‡ Planner.rs è®¤çŸ¥ç³»ç»Ÿçš„ â€œç³»ç»Ÿåˆå§‹åŒ–â€ æµç¨‹ -> CognitiveSystem::new å‡½æ•°è§¦å‘
    // =============================================================================
    client: Client, // ğŸ”Œ HTTP å®¢æˆ·ç«¯å®ä¾‹
}

impl BrowserClient {
    pub fn new() -> Self {
        // =============================================================================
        //  ğŸ‰ æ„é€ å‡½æ•°
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      åˆå§‹åŒ– reqwest::Client å¹¶æ„å»º BrowserClientã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      æˆ‘ä»¬è¦é€ ä¸€ä¸ªæ–°çš„ä¼ è¯ç­’å•¦ï¼Œå‡†å¤‡å¥½éšæ—¶ç»™ Python å‘æ¶ˆæ¯ï¼
        //
        //  âš ï¸ è­¦å‘Š:
        //      [åˆå§‹åŒ–å¼€é”€]: åˆ›å»º Client æœ‰ä¸€å®šå¼€é”€ï¼Œä¸è¦é¢‘ç¹åˆ›å»ºã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      é€šè¿‡ CognitiveSystem::new è®¤çŸ¥ç³»ç»Ÿçš„ â€œæ„é€ å‡½æ•°â€ è°ƒç”¨ -> BrowserClient::new å‡½æ•°è§¦å‘
        // =============================================================================
        Self {
            client: Client::new(), // ğŸ—ï¸ åˆ›å»ºæ–°å®¢æˆ·ç«¯
        }
    }

    pub async fn init_session(&self, user_id: &str) -> Result<(), String> {
        // =============================================================================
        //  ğŸ‰ åˆå§‹åŒ–ä¼šè¯ (ç”¨æˆ·ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      å‘ Python ç«¯å‘é€ POST è¯·æ±‚ï¼Œåˆå§‹åŒ–æŒ‡å®šç”¨æˆ·çš„æµè§ˆå™¨ä¼šè¯ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      ç»™ Python æ‰“ä¸ªæ‹›å‘¼ï¼šâ€œå˜¿ï¼Œæœ‰æ–°æœ‹å‹æ¥äº†ï¼Œå¿«å¸®ä»–å‡†å¤‡å¥½æµè§ˆå™¨ï¼â€
        //
        //  âš ï¸ è­¦å‘Š:
        //      [ç½‘ç»œè¶…æ—¶]: è‹¥ Python æœåŠ¡æœªå¯åŠ¨ï¼Œä¼šç«‹å³å¤±è´¥ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      é€šè¿‡ Planner.rs ä»»åŠ¡è§„åˆ’å™¨çš„ â€œå¼€å§‹ä»»åŠ¡â€ å†³ç­– -> process_user å‡½æ•°è§¦å‘ (é¢„ç•™)
        // =============================================================================
        let url = format!("{}/session/init", PYTHON_WORKER_URL); // ğŸ”— æ‹¼æ¥ API åœ°å€
        let res = self.client.post(&url) // ğŸ“® æ„å»º POST è¯·æ±‚
            .json(&json!({ "user_id": user_id })) // ğŸ“¦ åºåˆ—åŒ–ç”¨æˆ· ID
            .send() // ğŸš€ å‘é€ç½‘ç»œè¯·æ±‚
            .await // â³ ç­‰å¾…å¼‚æ­¥å“åº”
            .map_err(|e| e.to_string())?; // ğŸš¨ è½¬æ¢é”™è¯¯ç±»å‹
        
        if !res.status().is_success() { // ğŸš¦ æ£€æŸ¥å“åº”çŠ¶æ€
            return Err(format!("Failed to init session: {}", res.status())); // âŒ è¿”å›é”™è¯¯ä¿¡æ¯
        }
        Ok(()) // âœ… è¿”å›æˆåŠŸç»“æœ
    }

    pub async fn close_session(&self, user_id: &str) -> Result<(), String> {
        // =============================================================================
        //  ğŸ‰ å…³é—­ä¼šè¯ (ç”¨æˆ·ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      å‘ Python ç«¯å‘é€ POST è¯·æ±‚ï¼Œå…³é—­æŒ‡å®šç”¨æˆ·çš„æµè§ˆå™¨ä¼šè¯ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      å‘Šè¯‰ Pythonï¼šâ€œè¿™ä½æœ‹å‹çš„ä»»åŠ¡å®Œæˆå•¦ï¼Œå¯ä»¥æŠŠä»–çš„æµè§ˆå™¨å…³æ‰ä¼‘æ¯äº†ã€‚â€
        //
        //  âš ï¸ è­¦å‘Š:
        //      [å¿½ç•¥é”™è¯¯]: æ­¤æ“ä½œæ˜¯â€œå°½åŠ›è€Œä¸ºâ€ï¼Œä¸ä¿è¯ä¸€å®šæˆåŠŸã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      é€šè¿‡ Planner.rs ä»»åŠ¡è§„åˆ’å™¨çš„ â€œä»»åŠ¡å®Œæˆâ€ å†³ç­– -> process_user å‡½æ•°è§¦å‘ (é¢„ç•™)
        // =============================================================================
        let url = format!("{}/session/close", PYTHON_WORKER_URL); // ğŸ”— æ‹¼æ¥ API åœ°å€
        let _ = self.client.post(&url) // ğŸ“® æ„å»º POST è¯·æ±‚
            .json(&json!({ "user_id": user_id })) // ğŸ“¦ åºåˆ—åŒ–ç”¨æˆ· ID
            .send() // ğŸš€ å‘é€ç½‘ç»œè¯·æ±‚
            .await; // â³ å¿½ç•¥æ‰§è¡Œç»“æœ
        Ok(()) // âœ… è¿”å›æˆåŠŸç»“æœ
    }

    pub async fn get_screenshot(&self, user_id: &str) -> Result<Vec<u8>, String> {
        // =============================================================================
        //  ğŸ‰ è·å–æˆªå›¾ (ç”¨æˆ·ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //      å‘ Python ç«¯å‘é€ GET è¯·æ±‚ï¼Œè·å–å½“å‰é¡µé¢çš„ Base64 æˆªå›¾å¹¶è§£ç ä¸ºäºŒè¿›åˆ¶ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      é—®é—® Pythonï¼šâ€œç°åœ¨å±å¹•ä¸Šæ˜¯ä»€ä¹ˆæ ·å­å‘€ï¼Ÿå¿«æ‹å¼ ç…§ç‰‡å‘ç»™æˆ‘çœ‹çœ‹ï¼â€
        //
        //  âš ï¸ è­¦å‘Š:
        //      [å†…å­˜æ¶ˆè€—]: é«˜åˆ†è¾¨ç‡æˆªå›¾è§£ç åå ç”¨å†…å­˜è¾ƒå¤§ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      é€šè¿‡ Planner.rs è§†è§‰ç³»ç»Ÿçš„ â€œè·å–è§†é‡â€ è¯·æ±‚ -> process_user å‡½æ•°è§¦å‘
        // =============================================================================
        let url = format!("{}/state/screenshot?user_id={}", PYTHON_WORKER_URL, user_id); // ğŸ”— æ‹¼æ¥ API åœ°å€
        let res = self.client.get(&url) // ğŸ“¥ æ„å»º GET è¯·æ±‚
            .send() // ğŸš€ å‘é€ç½‘ç»œè¯·æ±‚
            .await // â³ ç­‰å¾…å¼‚æ­¥å“åº”
            .map_err(|e| e.to_string())?; // ğŸš¨ è½¬æ¢é”™è¯¯ç±»å‹

        if !res.status().is_success() { // ğŸš¦ æ£€æŸ¥å“åº”çŠ¶æ€
            return Err(format!("Failed to get screenshot: {}", res.status())); // âŒ è¿”å›é”™è¯¯ä¿¡æ¯
        }

        // Python returns raw bytes or base64? Let's assume raw bytes for efficiency if possible, 
        // but for simplicity with JSON APIs, base64 in JSON is safer.
        // Let's assume the Python endpoint returns JSON: { "screenshot": "base64..." }
        let json: serde_json::Value = res.json().await.map_err(|e| e.to_string())?; // ğŸ“¦ è§£æ JSON æ•°æ®
        let b64 = json["screenshot"].as_str().ok_or("No screenshot field")?; // ğŸ” æå–æˆªå›¾å­—æ®µ
        
        BASE64_STANDARD.decode(b64).map_err(|e| e.to_string()) // ğŸ”“ è§£ç  Base64 æ•°æ®
    }
    
    pub async fn get_url(&self, user_id: &str) -> Result<String, String> {
        // =============================================================================
        //  ğŸ‰ è·å–å½“å‰ç½‘å€ (ç”¨æˆ·ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //      å‘ Python ç«¯å‘é€ GET è¯·æ±‚ï¼Œè·å–å½“å‰é¡µé¢ URLã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      å¥½å¥‡åœ°é—® Pythonï¼šâ€œæˆ‘ä»¬ç°åœ¨æ˜¯åœ¨å“ªä¸ªç½‘ç«™é—²é€›å‘¢ï¼ŸæŠŠç½‘å€å‘Šè¯‰æˆ‘å§ï¼â€
        //
        //  âš ï¸ è­¦å‘Š:
        //      [ç©ºå€¼é£é™©]: è‹¥é¡µé¢æœªåŠ è½½ï¼Œå¯èƒ½è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      é€šè¿‡ Planner.rs çŠ¶æ€ç›‘æ§çš„ â€œæ£€æŸ¥ä½ç½®â€ è¯·æ±‚ -> process_user å‡½æ•°è§¦å‘
        // =============================================================================
        let url = format!("{}/state/url?user_id={}", PYTHON_WORKER_URL, user_id); // ğŸ”— æ‹¼æ¥ API åœ°å€
        let res = self.client.get(&url) // ğŸ“¥ æ„å»º GET è¯·æ±‚
            .send() // ğŸš€ å‘é€ç½‘ç»œè¯·æ±‚
            .await // â³ ç­‰å¾…å¼‚æ­¥å“åº”
            .map_err(|e| e.to_string())?; // ğŸš¨ è½¬æ¢é”™è¯¯ç±»å‹
            
        let json: serde_json::Value = res.json().await.map_err(|e| e.to_string())?; // ğŸ“¦ è§£æ JSON æ•°æ®
        Ok(json["url"].as_str().unwrap_or("").to_string()) // ğŸ“¤ æå– URL å­—ç¬¦ä¸²
    }

    pub async fn execute_action(&self, user_id: &str, action: BrowserAction) -> Result<(), String> {
        // =============================================================================
        //  ğŸ‰ æ‰§è¡ŒåŠ¨ä½œ (ç”¨æˆ·IDï¼ŒåŠ¨ä½œæŒ‡ä»¤)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //      å‘ Python ç«¯å‘é€ POST è¯·æ±‚ï¼Œæ‰§è¡Œå…·ä½“çš„æµè§ˆå™¨æ“ä½œ (å¦‚ç‚¹å‡»ã€è¾“å…¥)ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      ç»™ Python ä¸‹è¾¾å…·ä½“çš„æŒ‡ä»¤ï¼šâ€œå¿«å»ç‚¹å‡»é‚£ä¸ªæŒ‰é’®ï¼Œæˆ–è€…è¾“å…¥è¿™æ®µæ–‡å­—ï¼â€
        //
        //  âš ï¸ è­¦å‘Š:
        //      [æ‰§è¡Œé˜»å¡]: æŸäº›åŠ¨ä½œï¼ˆå¦‚é¡µé¢è·³è½¬ï¼‰å¯èƒ½å¯¼è‡´ Python ç«¯é•¿æ—¶é—´é˜»å¡ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      é€šè¿‡ Planner.rs å†³ç­–å¼•æ“çš„ â€œæ‰§è¡Œæ“ä½œâ€ æŒ‡ä»¤ -> process_user å‡½æ•°è§¦å‘
        // =============================================================================
        let url = format!("{}/action/execute", PYTHON_WORKER_URL); // ğŸ”— æ‹¼æ¥ API åœ°å€
        let res = self.client.post(&url) // ğŸ“® æ„å»º POST è¯·æ±‚
            .json(&json!({
                "user_id": user_id,
                "action": action
            })) // ğŸ“¦ æ„é€  JSON è¯·æ±‚ä½“
            .send() // ğŸš€ å‘é€ç½‘ç»œè¯·æ±‚
            .await // â³ ç­‰å¾…å¼‚æ­¥å“åº”
            .map_err(|e| e.to_string())?; // ğŸš¨ è½¬æ¢é”™è¯¯ç±»å‹

        if !res.status().is_success() { // ğŸš¦ æ£€æŸ¥å“åº”çŠ¶æ€
            return Err(format!("Action failed: {}", res.status())); // âŒ è¿”å›é”™è¯¯ä¿¡æ¯
        }
        Ok(()) // âœ… è¿”å›æˆåŠŸç»“æœ
    }
}
