import asyncio # âš¡ å¼‚æ­¥ I/O åº“
import random # ğŸ² éšæœºæ•°ç”Ÿæˆåº“
import time # â±ï¸ æ—¶é—´æ¨¡å—
from Memory.system_config import VIEWPORT # âš™ï¸ å¯¼å…¥è§†å£é…ç½®

class MouseController:
    # =================================
    #  ğŸ‰ é¼ æ ‡æ§åˆ¶å™¨ (æ— å‚æ•°)
    #
    #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    #     ä½œä¸º Angel çš„â€œæ‰‹â€ï¼Œè´Ÿè´£æ‰§è¡Œå…·ä½“çš„é¡µé¢äº¤äº’æ“ä½œï¼Œå¦‚ç‚¹å‡»ã€ç§»åŠ¨ã€æ»‘åŠ¨ç­‰ï¼Œå¹¶æ¨¡æ‹Ÿäººç±»çš„æ“ä½œä¹ æƒ¯ã€‚
    #     å…³é”®ç‰¹æ€§ï¼šä¼šåœ¨é¡µé¢ä¸­æ³¨å…¥ä¸€ä¸ªâ€œè™šæ‹Ÿå…‰æ ‡â€å…ƒç´ ï¼Œç¡®ä¿åœ¨æˆªå›¾/è§†é¢‘æµä¸­èƒ½çœ‹åˆ°é¼ æ ‡ä½ç½®ã€‚
    #
    #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    #     Angel çš„å°æ‰‹æ‰‹ï¼âœ‹ å®ƒå¯ä»¥å¸®ä½ ç‚¹ç‚¹ç‚¹ï¼Œæ»‘æ»‘æ»‘ã€‚è€Œä¸”å®ƒè¿˜ä¼šå˜é­”æœ¯ï¼Œåœ¨å±å¹•ä¸Šå˜å‡ºä¸€ä¸ªå°çº¢ç‚¹ï¼Œ
    #     è¿™æ ·ä½ å°±çŸ¥é“å®ƒæ­£æŒ‡ç€å“ªé‡Œå•¦ï¼
    #
    #  âš ï¸ è­¦å‘Šï¼š
    #     åæ ‡è®¡ç®—ä¾èµ–äº VIEWPORT é…ç½®ã€‚è™šæ‹Ÿå…‰æ ‡é€šè¿‡ JS æ³¨å…¥ï¼Œå¦‚æœé¡µé¢åˆ·æ–°ï¼Œéœ€è¦é‡æ–°æ³¨å…¥ï¼ˆå·²è‡ªåŠ¨å¤„ç†ï¼‰ã€‚
    # =================================
    def __init__(self, page):
        # =================================
        #  ğŸ‰ åˆå§‹åŒ–æ‰‹éƒ¨ (Playwrighté¡µé¢å¯¹è±¡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     ç»‘å®š Playwright çš„ Page å¯¹è±¡ï¼Œä»¥ä¾¿æ§åˆ¶é¼ æ ‡ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     æŠŠæ‰‹ä¼¸è¿›æµè§ˆå™¨é‡Œï¼ğŸ‘‹ å‡†å¤‡å¥½å¹²æ´»å•¦ï¼
        # =================================
        self.page = page # ğŸ“„ ç»‘å®šçš„é¡µé¢å®ä¾‹
        self.cursor_id = "angel-ai-cursor" # ğŸ†” è™šæ‹Ÿå…‰æ ‡çš„ DOM ID
        self.last_action_time = 0 # â±ï¸ æœ€åä¸€æ¬¡æ“ä½œçš„æ—¶é—´æˆ³

    def _mark_active(self):
        # =================================
        #  ğŸ‰ æ ‡è®°æ´»è·ƒçŠ¶æ€ (æ— å‚æ•°)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     æ›´æ–°æœ€åæ“ä½œæ—¶é—´æˆ³ã€‚ç”¨äºé€šçŸ¥ WebSocket æœåŠ¡å½“å‰å¤„äºâ€œäººæœºåä½œâ€æ¨¡å¼ï¼Œéœ€è¦é«˜é¢‘æ¨æµã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     Angel åˆšåˆšåŠ¨äº†ä¸€ä¸‹ï¼ğŸ•’ è®°ä¸‹æ—¶é—´ï¼Œå‘Šè¯‰ç³»ç»Ÿç°åœ¨æˆ‘å¾ˆæ´»è·ƒï¼Œä¸è¦å·æ‡’ï¼Œç”»é¢è¦ä¼ å¿«ç‚¹ï¼
        #
        #  âš ï¸ è­¦å‘Šï¼š
        #     ä»…æ›´æ–°æ—¶é—´æˆ³ï¼Œä¸è§¦å‘ä»»ä½•å®é™…æ“ä½œã€‚
        # =================================
        self.last_action_time = time.time()

    async def _ensure_cursor_visible(self):
        # =================================
        #  ğŸ‰ ç¡®ä¿å…‰æ ‡å¯è§ (æ— å‚æ•°)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦å­˜åœ¨è™šæ‹Ÿå…‰æ ‡å…ƒç´ ï¼Œå¦‚æœä¸å­˜åœ¨ï¼ˆå¦‚é¡µé¢åˆ·æ–°åï¼‰ï¼Œåˆ™é‡æ–°æ³¨å…¥ HTML å’Œ CSSã€‚
        #     å…‰æ ‡æ ·å¼ä¸ºä¸€ä¸ªå¸¦çº¢ç‚¹çš„åŠé€æ˜åœ†åœˆï¼Œå±‚çº§æœ€é«˜ (z-index: 999999)ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     æ£€æŸ¥ä¸€ä¸‹å°çº¢ç‚¹è¿˜åœ¨ä¸åœ¨ï¼Ÿå¦‚æœè¢«ç½‘é¡µâ€œåƒâ€æ‰äº†ï¼Œå°±èµ¶ç´§å†å˜ä¸€ä¸ªå‡ºæ¥ï¼âœ¨
        #
        #  âš ï¸ è­¦å‘Šï¼š
        #     å¦‚æœé¡µé¢æ­£åœ¨åŠ è½½æˆ–å·²å…³é—­ï¼Œevaluate å¯èƒ½ä¼šå¤±è´¥ï¼Œå·²åšå¼‚å¸¸æ•è·ã€‚
        # =================================
        if not self.page: return
        
        # æ³¨å…¥å…‰æ ‡çš„ JS ä»£ç 
        js_code = f"""
        (id) => {{
            if (!document.getElementById(id)) {{
                const cursor = document.createElement('div');
                cursor.id = id;
                cursor.style.position = 'fixed';
                cursor.style.width = '20px';
                cursor.style.height = '20px';
                cursor.style.borderRadius = '50%';
                cursor.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';
                cursor.style.border = '2px solid white';
                cursor.style.pointerEvents = 'none'; // ğŸš« ç¡®ä¿ä¸é˜»æŒ¡ç‚¹å‡»
                cursor.style.zIndex = '999999';
                cursor.style.transition = 'top 0.1s, left 0.1s, transform 0.1s'; // ğŸŒŠ å¹³æ»‘åŠ¨ç”»
                cursor.style.transform = 'translate(-50%, -50%)'; // ğŸ¯ å±…ä¸­å®šä½
                cursor.style.boxShadow = '0 0 10px rgba(255,0,0,0.5)';
                document.body.appendChild(cursor);
            }}
        }}
        """
        try:
            await self.page.evaluate(js_code, self.cursor_id)
        except Exception:
            pass # å¿½ç•¥é¡µé¢å·²å…³é—­ç­‰é”™è¯¯

    async def _update_cursor_visual(self, x, y, click_effect=False):
        # =================================
        #  ğŸ‰ æ›´æ–°å…‰æ ‡è§†è§‰ (Xåæ ‡ï¼ŒYåæ ‡ï¼Œæ˜¯å¦ç‚¹å‡»ç‰¹æ•ˆ)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     é€šè¿‡ JS æ›´æ–°è™šæ‹Ÿå…‰æ ‡çš„ä½ç½®ã€‚å¦‚æœ click_effect ä¸º Trueï¼Œåˆ™è§¦å‘ç‚¹å‡»åŠ¨ç”»ï¼ˆç¼©æ”¾ï¼‰ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     å°çº¢ç‚¹ï¼Œå¿«è·Ÿä¸Šï¼ğŸƒâ€â™€ï¸ è·‘åˆ°è¿™é‡Œæ¥ï¼å¦‚æœæ˜¯ç‚¹å‡»ï¼Œå°±é—ªä¸€ä¸‹ï¼âœ¨
        #
        #  âš ï¸ è­¦å‘Šï¼š
        #     é¢‘ç¹è°ƒç”¨ evaluate å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œå»ºè®®ä»…åœ¨å¿…è¦æ—¶æ›´æ–°ã€‚
        # =================================
        if not self.page: return
        
        scale = "scale(0.8)" if click_effect else "scale(1)"
        color = "rgba(255, 0, 0, 0.8)" if click_effect else "rgba(255, 0, 0, 0.5)"
        
        js_code = f"""
        (params) => {{
            const cursor = document.getElementById(params.id);
            if (cursor) {{
                cursor.style.left = params.x + 'px';
                cursor.style.top = params.y + 'px';
                cursor.style.transform = 'translate(-50%, -50%) {scale}';
                cursor.style.backgroundColor = '{color}';
            }}
        }}
        """
        try:
            await self.page.evaluate(js_code, {'id': self.cursor_id, 'x': x, 'y': y})
        except Exception:
            pass

    async def human_move(self, end_x, end_y):
        # =================================
        #  ğŸ‰ æ‹ŸäººåŒ–ç§»åŠ¨ (ç›®æ ‡Xåæ ‡ï¼Œç›®æ ‡Yåæ ‡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     å°†é¼ æ ‡ç§»åŠ¨åˆ°æŒ‡å®šåæ ‡ï¼Œå¹¶åŒæ­¥æ›´æ–°è™šæ‹Ÿå…‰æ ‡ä½ç½®ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     æ…¢æ…¢ç§»è¿‡å»... ğŸš¶â€â™€ï¸ å°±åƒäººæ‰‹æ‹¿é¼ æ ‡ä¸€æ ·ï¼Œæœ‰å¿«æœ‰æ…¢ï¼Œä¸ä¼šâ€œå—–â€çš„ä¸€ä¸‹å°±é£è¿‡å»ï¼Œè¿™æ ·æ‰ä¸ä¼šè¢«å‘ç°æ˜¯æœºå™¨äººåœ¨æ“ä½œï¼
        # =================================
        """æ‹ŸäººåŒ–ç§»åŠ¨"""
        if not self.page: return
        self._mark_active() # â±ï¸ æ ‡è®°æ´»è·ƒ
        
        await self._ensure_cursor_visible() # ğŸ‘ï¸ ç¡®ä¿å…‰æ ‡å­˜åœ¨
        
        steps = random.randint(5, 10) # âš¡ å‡å°‘æ­¥æ•°ä»¥æé«˜å“åº”é€Ÿåº¦ï¼Œä½†ä¿ç•™å¹³æ»‘æ„Ÿ
        
        # æ‰§è¡Œ Playwright çœŸå®ç§»åŠ¨
        await self.page.mouse.move(end_x, end_y, steps=steps) 
        
        # åŒæ­¥æ›´æ–°è§†è§‰å…‰æ ‡ (åªåœ¨ç»ˆç‚¹æ›´æ–°ï¼Œé¿å…é€šä¿¡è¿‡äºé¢‘ç¹)
        await self._update_cursor_visual(end_x, end_y)

    async def click(self, x_ratio, y_ratio):
        # =================================
        #  ğŸ‰ æ‹ŸäººåŒ–ç‚¹å‡» (Xè½´æ¯”ä¾‹ï¼ŒYè½´æ¯”ä¾‹)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     æ ¹æ®ç›¸å¯¹æ¯”ä¾‹è®¡ç®—ç»å¯¹åæ ‡ï¼Œå…ˆç§»åŠ¨é¼ æ ‡ï¼Œæ¨¡æ‹Ÿååº”å»¶è¿Ÿï¼Œç„¶åæ‰§è¡ŒæŒ‰ä¸‹å’ŒæŠ¬èµ·æ“ä½œã€‚
        #     åŒæ—¶è§¦å‘è§†è§‰å…‰æ ‡çš„ç‚¹å‡»åŠ¨ç”»ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     ç„å‡†... å‘å°„ï¼ğŸ‘‰ å…ˆçœ‹å‡†ä½ç½®ç§»è¿‡å»ï¼Œç¨å¾®åœé¡¿ä¸€ä¸‹ï¼ˆå‡è£…åœ¨æ€è€ƒï¼‰ï¼Œç„¶åè½»è½»ç‚¹ä¸‹å»ï¼Œå†æ¾å¼€ã€‚å®Œç¾ï¼
        #
        #  âš ï¸ è­¦å‘Šï¼š
        #     è¾“å…¥å‚æ•°æ˜¯ 0.0-1.0 çš„æ¯”ä¾‹å€¼ï¼Œè€Œéç»å¯¹åƒç´ åæ ‡ã€‚
        # =================================
        """æ‹ŸäººåŒ–ç‚¹å‡»"""
        if not self.page: return
        self._mark_active() # â±ï¸ æ ‡è®°æ´»è·ƒ
        
        target_x = x_ratio * VIEWPORT['width'] # ğŸ“ è®¡ç®—ç»å¯¹ X åæ ‡
        target_y = y_ratio * VIEWPORT['height'] # ğŸ“ è®¡ç®—ç»å¯¹ Y åæ ‡
        
        # 1. ç§»åŠ¨
        await self.human_move(target_x, target_y) # ğŸ–±ï¸ ç§»åŠ¨åˆ°ä½
        
        # 2. ååº”å»¶è¿Ÿ
        await asyncio.sleep(random.uniform(0.05, 0.1)) # â³ æ¨¡æ‹Ÿäººç±»ååº”æ—¶é—´
        
        # 3. ç‚¹å‡»è§†è§‰ç‰¹æ•ˆ
        await self._update_cursor_visual(target_x, target_y, click_effect=True)
        
        # 4. çœŸå®ç‚¹å‡»
        await self.page.mouse.down() # ğŸ‘‡ æŒ‰ä¸‹é¼ æ ‡
        await asyncio.sleep(random.uniform(0.05, 0.1)) # â³ æ¨¡æ‹ŸæŒ‰é”®æ—¶é•¿
        await self.page.mouse.up() # â˜ï¸ æŠ¬èµ·é¼ æ ‡
        
        # 5. æ¢å¤è§†è§‰ç‰¹æ•ˆ
        await self._update_cursor_visual(target_x, target_y, click_effect=False)

    async def scroll(self, delta_y):
        # =================================
        #  ğŸ‰ é¡µé¢æ»šåŠ¨ (Yè½´æ»šåŠ¨é‡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     æ¨¡æ‹Ÿé¼ æ ‡æ»šè½®æ»šåŠ¨é¡µé¢ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     æ»‘è½®æ»šä¸€æ»šï¼Œé¡µé¢èµ°ä¸€èµ°ï¼ğŸ¡ å¾€ä¸‹çœ‹æ›´å¤šç²¾å½©å†…å®¹ï¼
        # =================================
        if not self.page: return
        self._mark_active() # â±ï¸ æ ‡è®°æ´»è·ƒ
        await self.page.mouse.wheel(0, delta_y)

    async def jump_video(self, timestamp):
        # =================================
        #  ğŸ‰ è§†é¢‘è·³è½¬ (æ—¶é—´æˆ³)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     æ§åˆ¶é¡µé¢ä¸­çš„è§†é¢‘æ’­æ”¾å™¨è·³è½¬åˆ°æŒ‡å®šæ—¶é—´ç‚¹ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     å¿«è¿›ï¼â© ç›´æ¥è·³åˆ°ç²¾å½©çš„åœ°æ–¹ï¼
        #
        #  âš ï¸ è­¦å‘Šï¼š
        #     å½“å‰ä¸ºç®€åŒ–ç‰ˆå®ç°ï¼Œå°šæœªæ³¨å…¥å…·ä½“çš„ JS ä»£ç æ¥æ§åˆ¶ Video æ ‡ç­¾ã€‚
        # =================================
        """æ§åˆ¶è§†é¢‘è·³è½¬"""
        if not self.page: return False # ğŸš« é¡µé¢ä¸å­˜åœ¨ï¼Œè¿”å›å¤±è´¥
        print(f"âœ‹ Mouse: Jumping to {timestamp}s") # ğŸ“¢ æ‰“å°è·³è½¬æ—¥å¿—
        # è¿™é‡Œéœ€è¦æ³¨å…¥ JS æ¥æ§åˆ¶ video æ ‡ç­¾
        # ç®€åŒ–ç‰ˆå®ç°
        return True # âœ… æ¨¡æ‹Ÿè·³è½¬æˆåŠŸ
