/* ==========================================================================
   ğŸ“ƒ æ–‡ä»¶åŠŸèƒ½ : æˆæœ¬ç›‘æ§å™¨
   âš¡ é€»è¾‘æ‘˜è¦ : å®æ—¶ç»Ÿè®¡ç½‘ç»œæµé‡ (WebSocket/Browser) å’Œ AI Token æ¶ˆè€—ï¼Œè®¡ç®—æ€»æˆæœ¬ã€‚
   ğŸ’¡ æ˜“æ‡‚è§£é‡Š : æœºå™¨äººçš„ "è®°è´¦æœ¬"ï¼Œæ¯ä¸€åˆ†é’±éƒ½ç®—å¾—æ¸…æ¸…æ¥šæ¥šã€‚
   ğŸ”‹ æœªæ¥æ‰©å±• : æ”¯æŒæŒ‰ç”¨æˆ·åˆ†è´¦ï¼Œæ”¯æŒå¯¼å‡ºæŠ¥è¡¨ã€‚
   ğŸ“Š å½“å‰çŠ¶æ€ : æ´»è·ƒ (æ›´æ–°: 2025-12-16)
   ğŸ§± Energy/CostMonitor.rs è¸©å‘è®°å½• (ç´¯ç§¯ï¼Œå‹¿è¦†ç›–) :
      1. [2025-12-04] [å·²ä¿®å¤] [ç²¾åº¦ä¸¢å¤±]: æµ®ç‚¹æ•°ç´¯åŠ å¯¼è‡´é‡‘é¢è¯¯å·®ã€‚ -> å†…éƒ¨ä½¿ç”¨å¾®ç¾å…ƒ (micro-USD) æ•´æ•°å­˜å‚¨ã€‚
      2. [2025-12-16] [å·²ä¿®å¤] [æ–‡ä»¶é‡å¤]: æ–‡ä»¶å†…å®¹è¢«é‡å¤ç²˜è´´å¤šæ¬¡ã€‚ -> æ¸…ç†é‡å¤å†…å®¹ã€‚
   ========================================================================== */

// ğŸ“¦ å¼•å…¥ä¾èµ–
use std::sync::atomic::{AtomicU64, AtomicUsize, Ordering};
use serde::Serialize;

#[derive(Debug, Serialize)]
pub struct CostReport {
    pub total_cost: f64, // ğŸ’° æ€»æˆæœ¬ (USD)
    pub ai_cost: f64, // ğŸ§  AI æˆæœ¬ (USD)
    pub net_cost: f64, // ğŸŒ ç½‘ç»œæˆæœ¬ (USD)
}

pub struct CostMonitor {
    // =============================================================================
    //  ğŸ‰ æˆæœ¬ç›‘æ§å™¨
    //
    //  ğŸ¨ ä»£ç ç”¨é€”:
    //      çº¿ç¨‹å®‰å…¨çš„æˆæœ¬ç»Ÿè®¡å®¹å™¨ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    //      ä¸€ä¸ªä¼šè‡ªåŠ¨åŠ æ³•çš„è´¦æœ¬ã€‚
    //
    //  âš ï¸ è­¦å‘Š:
    //      [å¹¶å‘]: ä½¿ç”¨ Atomic ç±»å‹ä¿è¯å¹¶å‘å®‰å…¨ï¼Œä½† get_report æ—¶å¯èƒ½å­˜åœ¨ç¬é—´çš„ä¸ä¸€è‡´ã€‚
    //
    //  âš™ï¸ è§¦å‘æº:
    //      Through Brain/Main.rs "System Init" -> CostMonitor
    // =============================================================================
    ws_tx: AtomicUsize, // ğŸ“¡ WebSocket å‘é€å­—èŠ‚
    ws_rx: AtomicUsize, // ğŸ“¡ WebSocket æ¥æ”¶å­—èŠ‚
    browser_tx: AtomicUsize, // ğŸŒ æµè§ˆå™¨å‘é€å­—èŠ‚
    browser_rx: AtomicUsize, // ğŸŒ æµè§ˆå™¨æ¥æ”¶å­—èŠ‚
    ai_input_tokens: AtomicU64, // ğŸ§  AI è¾“å…¥ Token
    ai_output_tokens: AtomicU64, // ğŸ§  AI è¾“å‡º Token
    ai_cost_usd: AtomicU64, // ğŸ’° AI æˆæœ¬ (å¾®ç¾å…ƒ)
}

impl CostMonitor {
    pub fn new() -> Self {
        // =============================================================================
        //  ğŸ‰ æ„é€ å‡½æ•°
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      åˆå§‹åŒ–è®¡æ•°å™¨ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      è´¦æœ¬å½’é›¶ã€‚
        //
        //  âš ï¸ è­¦å‘Š:
        //      æ— ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Brain/Main.rs "System Init" -> new
        // =============================================================================
        Self {
            ws_tx: AtomicUsize::new(0), // ğŸ”¢ åˆå§‹åŒ–å‘é€è®¡æ•°
            ws_rx: AtomicUsize::new(0), // ğŸ”¢ åˆå§‹åŒ–æ¥æ”¶è®¡æ•°
            browser_tx: AtomicUsize::new(0), // ğŸ”¢ åˆå§‹åŒ–æµè§ˆå™¨å‘é€
            browser_rx: AtomicUsize::new(0), // ğŸ”¢ åˆå§‹åŒ–æµè§ˆå™¨æ¥æ”¶
            ai_input_tokens: AtomicU64::new(0), // ğŸ”¢ åˆå§‹åŒ– AI è¾“å…¥
            ai_output_tokens: AtomicU64::new(0), // ğŸ”¢ åˆå§‹åŒ– AI è¾“å‡º
            ai_cost_usd: AtomicU64::new(0), // ğŸ”¢ åˆå§‹åŒ– AI æˆæœ¬
        }
    }

    pub fn track_ws(&self, tx: usize, rx: usize) {
        // =============================================================================
        //  ğŸ‰ è®°å½• WebSocket æµé‡ (å‘é€é‡ï¼Œæ¥æ”¶é‡)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      è®°å½• WebSocket æµé‡ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      "åˆšæ‰è·Ÿå‰ç«¯è¯´äº†å¤šå°‘è¯ï¼Ÿ"
        //
        //  âš ï¸ è­¦å‘Š:
        //      æ— ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Energy/Gateway.rs "Traffic Event" -> track_ws
        // =============================================================================
        self.ws_tx.fetch_add(tx, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ å‘é€
        self.ws_rx.fetch_add(rx, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ æ¥æ”¶
    }

    pub fn track_browser(&self, tx: usize, rx: usize) {
        // =============================================================================
        //  ğŸ‰ è®°å½•æµè§ˆå™¨æµé‡ (å‘é€é‡ï¼Œæ¥æ”¶é‡)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      è®°å½•æµè§ˆå™¨æµé‡ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      "åˆšæ‰ç½‘é¡µåŠ è½½äº†å¤šå°‘æ•°æ®ï¼Ÿ"
        //
        //  âš ï¸ è­¦å‘Š:
        //      æ— ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Body/Playwright.py "Network Event" -> track_browser
        // =============================================================================
        self.browser_tx.fetch_add(tx, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ å‘é€
        self.browser_rx.fetch_add(rx, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ æ¥æ”¶
    }

    pub fn track_ai(&self, input: u64, output: u64, cost: f64) {
        // =============================================================================
        //  ğŸ‰ è®°å½• AI æˆæœ¬ (è¾“å…¥Tokenï¼Œè¾“å‡ºTokenï¼Œæˆæœ¬)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      è®°å½• AI è°ƒç”¨æˆæœ¬ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      "åˆšæ‰é—® Gemini èŠ±äº†å¤šå°‘é’±ï¼Ÿ"
        //
        //  âš ï¸ è­¦å‘Š:
        //      cost å‚æ•°å•ä½æ˜¯ç¾å…ƒï¼Œå†…éƒ¨è½¬æ¢ä¸ºå¾®ç¾å…ƒå­˜å‚¨ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Energy/Gateway.rs "cost_handler" -> track_ai
        // =============================================================================
        self.ai_input_tokens.fetch_add(input, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ è¾“å…¥
        self.ai_output_tokens.fetch_add(output, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ è¾“å‡º
        let cost_micro = (cost * 1_000_000.0) as u64; // ğŸ§® è½¬æ¢ä¸ºå¾®ç¾å…ƒ
        self.ai_cost_usd.fetch_add(cost_micro, Ordering::Relaxed); // ğŸ“ˆ ç´¯åŠ æˆæœ¬
    }

    pub fn get_report(&self) -> CostReport {
        // =============================================================================
        //  ğŸ‰ è·å–æŠ¥å‘Š
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      ç”Ÿæˆå½“å‰çš„æˆæœ¬æŠ¥è¡¨ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      "ç®—ä¸€ä¸‹æ€»è´¦ã€‚"
        //
        //  âš ï¸ è­¦å‘Š:
        //      ç½‘ç»œæµé‡æŒ‰ $0.10/GB ä¼°ç®—ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      (é¢„ç•™)
        // =============================================================================
        let total_tx = self.ws_tx.load(Ordering::Relaxed) + self.browser_tx.load(Ordering::Relaxed); // ğŸ“Š è®¡ç®—æ€»å‘é€
        let _total_rx = self.ws_rx.load(Ordering::Relaxed) + self.browser_rx.load(Ordering::Relaxed); // ğŸ“Š è®¡ç®—æ€»æ¥æ”¶
        
        let net_cost = (total_tx as f64 / 1_073_741_824.0) * 0.1; // $0.10 per GB // ğŸ’¸ è®¡ç®—ç½‘ç»œæˆæœ¬
        let ai_cost = self.ai_cost_usd.load(Ordering::Relaxed) as f64 / 1_000_000.0; // ğŸ’¸ è®¡ç®— AI æˆæœ¬
        
        CostReport {
            total_cost: net_cost + ai_cost, // ğŸ’° æ€»æˆæœ¬
            ai_cost, // ğŸ§  AI æˆæœ¬
            net_cost, // ğŸŒ ç½‘ç»œæˆæœ¬
        }
    }
}
