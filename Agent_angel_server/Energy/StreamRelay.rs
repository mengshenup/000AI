/* ==========================================================================
   ğŸ“ƒ æ–‡ä»¶åŠŸèƒ½ : æµåª’ä½“ä¸­ç»§å™¨
   âš¡ é€»è¾‘æ‘˜è¦ : æ¥æ”¶æ¥è‡ª CDPStream çš„è§†é¢‘å¸§ï¼Œè½¬å‘ç»™æ‰€æœ‰è¿æ¥çš„ WebSocket å®¢æˆ·ç«¯ã€‚
   ğŸ’¡ æ˜“æ‡‚è§£é‡Š : è§†é¢‘ç›´æ’­çš„ "åˆ†å‘ä¸­å¿ƒ"ï¼ŒæŠŠç”»é¢å¹¿æ’­ç»™æ‰€æœ‰è§‚ä¼—ã€‚
   ğŸ”‹ æœªæ¥æ‰©å±• : æ”¯æŒå¤šè·¯æµï¼Œæ”¯æŒè‡ªé€‚åº”ç ç‡ã€‚
   ğŸ“Š å½“å‰çŠ¶æ€ : æ´»è·ƒ (æ›´æ–°: 2025-12-06)
   ğŸ§± Energy/StreamRelay.rs è¸©å‘è®°å½• (ç´¯ç§¯ï¼Œå‹¿è¦†ç›–) :
      1. [2025-12-04] [å·²ä¿®å¤] [é”ç«äº‰]: å¹¿æ’­æ—¶æŒæœ‰é”æ—¶é—´è¿‡é•¿ã€‚ -> ä»…åœ¨è·å–æ¥æ”¶è€…åˆ—è¡¨æ—¶æŒæœ‰é”ï¼Œå‘é€æ“ä½œåœ¨é”å¤–è¿›è¡Œã€‚
   ========================================================================== */

// ğŸ“¦ å¼•å…¥ä¾èµ–
use tokio::sync::broadcast;

pub struct StreamRelay {
    // =============================================================================
    //  ğŸ‰ æµåª’ä½“ä¸­ç»§å™¨
    //
    //  ğŸ¨ ä»£ç ç”¨é€”:
    //      ç®¡ç†è§†é¢‘æµçš„å¹¿æ’­é€šé“ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    //      ä¸€ä¸ªå¤§å–‡å­ï¼Œå–Šä¸€å£°å¤§å®¶éƒ½èƒ½å¬åˆ°ã€‚
    //
    //  âš ï¸ è­¦å‘Š:
    //      [ä¸¢åŒ…]: broadcast channel çš„å®¹é‡æœ‰é™ï¼Œå¦‚æœæ¥æ”¶ç«¯å¤„ç†å¤ªæ…¢ï¼Œæ—§æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ (Lagged)ã€‚
    //
    //  âš™ï¸ è§¦å‘æº:
    //      Through Brain/Main.rs "System Init" -> StreamRelay
    // =============================================================================
    tx: broadcast::Sender<Vec<u8>>, // ğŸ“¡ å¹¿æ’­å‘é€ç«¯
}

impl StreamRelay {
    pub fn new() -> Self {
        // =============================================================================
        //  ğŸ‰ æ„é€ å‡½æ•°
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      åˆ›å»ºå¹¿æ’­é€šé“ï¼Œå®¹é‡ 100 å¸§ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      æ¶èµ·å¤§å–‡å­ã€‚
        //
        //  âš ï¸ è­¦å‘Š:
        //      [å®¹é‡]: å®¹é‡ 100 æ„å‘³ç€å¦‚æœå®¢æˆ·ç«¯å¡é¡¿è¶…è¿‡ 100 å¸§ï¼Œå°±ä¼šä¸¢åŒ…ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Brain/Main.rs "System Init" -> new
        // =============================================================================
        let (tx, _) = broadcast::channel(100); // ğŸ“¡ åˆ›å»ºé€šé“ï¼Œå®¹é‡ 100
        Self { tx }
    }

    pub fn subscribe(&self) -> broadcast::Receiver<Vec<u8>> {
        // =============================================================================
        //  ğŸ‰ è®¢é˜…é¢‘é“
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥æ”¶ç«¯ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      ç»™è§‚ä¼—å‘ä¸€ä¸ªæ”¶éŸ³æœºã€‚
        //
        //  âš ï¸ è­¦å‘Š:
        //      [èµ„æº]: æ¯ä¸ª WebSocket è¿æ¥éƒ½éœ€è¦è°ƒç”¨ä¸€æ¬¡ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Energy/Gateway.rs "WS Upgrade" -> subscribe
        // =============================================================================
        self.tx.subscribe() // ğŸ§ è®¢é˜…é¢‘é“
    }

    pub fn broadcast(&self, data: Vec<u8>) {
        // =============================================================================
        //  ğŸ‰ å¹¿æ’­æ•°æ® (æ•°æ®å¸§)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”:
        //      å‘é€ä¸€å¸§æ•°æ®ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        //      å¹¿æ’­ç”»é¢ã€‚
        //
        //  âš ï¸ è­¦å‘Š:
        //      [é™é»˜ä¸¢å¼ƒ]: å¦‚æœæ²¡äººå¬ï¼Œæ¶ˆæ¯ä¼šè¢«ç›´æ¥ä¸¢å¼ƒï¼Œä¸ä¼šæŠ¥é”™ã€‚
        //
        //  âš™ï¸ è§¦å‘æº:
        //      Through Energy/CDPstream.rs "Frame Event" -> broadcast
        // =============================================================================
        let _ = self.tx.send(data); // ğŸ“¢ å‘é€å¹¿æ’­
    }
}
