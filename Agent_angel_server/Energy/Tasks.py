# ==========================================================================
#  ğŸ“ƒ æ–‡ä»¶åŠŸèƒ½ : åå°ä»»åŠ¡
#  âš¡ é€»è¾‘æ‘˜è¦ : è´Ÿè´£å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå¦‚æˆæœ¬æ•°æ®åŒæ­¥ã€çŠ¶æ€æ£€æŸ¥ç­‰ã€‚
#  ğŸ’¡ æ˜“æ‡‚è§£é‡Š : æœºå™¨äººçš„ "å¿ƒè·³"ï¼Œæ¯éš”å‡ ç§’é’ŸæŠŠè´¦å•å‘ç»™æ€»éƒ¨ã€‚
#  ğŸ”‹ æœªæ¥æ‰©å±• : æ”¯æŒæ›´å¤šç±»å‹çš„åå°ä»»åŠ¡ï¼Œå¦‚æ—¥å¿—è½®è½¬ã€ç¼“å­˜æ¸…ç†ã€‚
#  ğŸ“Š å½“å‰çŠ¶æ€ : æ´»è·ƒ (æ›´æ–°: 2025-12-06)
#  ğŸ§± Energy/Tasks.py è¸©å‘è®°å½• (ç´¯ç§¯ï¼Œå‹¿è¦†ç›–) :
#     1. [2025-12-04] [å·²ä¿®å¤] [è¿æ¥é”™è¯¯]: å¦‚æœ Rust æœåŠ¡æœªå¯åŠ¨ï¼ŒåŒæ­¥ä¼šæŠ¥é”™ã€‚ -> å¢åŠ äº† try-except å¿½ç•¥è¿æ¥é”™è¯¯ã€‚
# ==========================================================================

import asyncio
import httpx
import sys
import os

# ğŸ› ï¸ ç¡®ä¿èƒ½å¯¼å…¥ Body æ¨¡å—
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from Body.Gemini import global_ai_cost

class Netstat:
    # =============================================================================
    #  ğŸ‰ ç½‘ç»œæµé‡ç»Ÿè®¡
    #
    #  ğŸ¨ ä»£ç ç”¨é€”:
    #      ç»Ÿè®¡ WebSocket å’Œæµè§ˆå™¨çš„ç½‘ç»œæµé‡ã€‚
    #
    #  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    #      æµé‡è®¡ã€‚
    #
    #  âš ï¸ è­¦å‘Š:
    #      [çº¿ç¨‹å®‰å…¨]: éçº¿ç¨‹å®‰å…¨ï¼Œä½†åœ¨ Python GIL ä¸‹é€šå¸¸æ²¡é—®é¢˜ã€‚
    #
    #  âš™ï¸ è§¦å‘æº:
    #      Through Body/Playwright.py "Init" -> Netstat
    # =============================================================================
    def __init__(self):
        self.reset() # ğŸ”„ åˆå§‹åŒ–

    def reset(self):
        # =============================================================================
        #  ğŸ‰ é‡ç½®è®¡æ•°å™¨
        #
        #  ğŸ¨ ä»£ç ç”¨é€”:
        #      é‡ç½®è®¡æ•°å™¨ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        #      å½’é›¶ã€‚
        #
        #  âš ï¸ è­¦å‘Š:
        #      æ— ã€‚
        #
        #  âš™ï¸ è§¦å‘æº:
        #      Through Energy/Tasks.py "Init" -> reset
        # =============================================================================
        self.ws_tx = 0 # ğŸ”¢ WebSocket å‘é€
        self.ws_rx = 0 # ğŸ”¢ WebSocket æ¥æ”¶
        self.browser_tx = 0 # ğŸ”¢ æµè§ˆå™¨å‘é€
        self.browser_rx = 0 # ğŸ”¢ æµè§ˆå™¨æ¥æ”¶
        
        self.delta_ws_tx = 0 # â• å¢é‡ WebSocket å‘é€
        self.delta_ws_rx = 0 # â• å¢é‡ WebSocket æ¥æ”¶
        self.delta_browser_tx = 0 # â• å¢é‡ æµè§ˆå™¨å‘é€
        self.delta_browser_rx = 0 # â• å¢é‡ æµè§ˆå™¨æ¥æ”¶

    def track_ws(self, tx=0, rx=0):
        # =============================================================================
        #  ğŸ‰ è®°å½• WebSocket æµé‡ (å‘é€é‡, æ¥æ”¶é‡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”:
        #      è®°å½• WebSocket æµé‡ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        #      "åˆšæ‰å‘äº†å¤šå°‘æ•°æ®ï¼Ÿ"
        #
        #  âš ï¸ è­¦å‘Š:
        #      æ— ã€‚
        #
        #  âš™ï¸ è§¦å‘æº:
        #      Through Memory/Interface.py "Traffic Event" -> track_ws
        # =============================================================================
        self.ws_tx += tx # ğŸ“ˆ ç´¯åŠ å‘é€
        self.ws_rx += rx # ğŸ“ˆ ç´¯åŠ æ¥æ”¶
        self.delta_ws_tx += tx # â• ç´¯åŠ å¢é‡
        self.delta_ws_rx += rx # â• ç´¯åŠ å¢é‡

    def track_browser(self, tx=0, rx=0):
        # =============================================================================
        #  ğŸ‰ è®°å½•æµè§ˆå™¨æµé‡ (å‘é€é‡, æ¥æ”¶é‡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”:
        #      è®°å½•æµè§ˆå™¨æµé‡ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
        #      "åˆšæ‰ç½‘é¡µåŠ è½½äº†å¤šå°‘æ•°æ®ï¼Ÿ"
        #
        #  âš ï¸ è­¦å‘Š:
        #      æ— ã€‚
        #
        #  âš™ï¸ è§¦å‘æº:
        #      Through Body/Playwright.py "Network Event" -> track_browser
        # =============================================================================
        self.browser_tx += tx # ğŸ“ˆ ç´¯åŠ å‘é€
        self.browser_rx += rx # ğŸ“ˆ ç´¯åŠ æ¥æ”¶
        self.delta_browser_tx += tx # â• ç´¯åŠ å¢é‡
        self.delta_browser_rx += rx # â• ç´¯åŠ å¢é‡

    # =============================================================================
    #  ğŸ‰ pop_deltas (æ— å‚æ•°)
    #
    #  ğŸ¨ ç”¨é€”:
    #      è·å–å¹¶æ¸…ç©ºå¢é‡æ•°æ®ã€‚
    #
    #  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    #      "æŠŠåˆšæ‰çš„æµé‡å•å­ç»“ä¸€ä¸‹ã€‚"
    #
    #  âš ï¸ è­¦å‘Š:
    #      æ— ã€‚
    #
    #  âš™ï¸ è§¦å‘æº:
    #      cost_sync_loop
    # =============================================================================
    def pop_deltas(self):
        d = {
            "ws": {"tx": self.delta_ws_tx, "rx": self.delta_ws_rx}, # ğŸ“¦ æ‰“åŒ… WebSocket å¢é‡
            "browser": {"tx": self.delta_browser_tx, "rx": self.delta_browser_rx} # ğŸ“¦ æ‰“åŒ…æµè§ˆå™¨å¢é‡
        }
        self.delta_ws_tx = 0 # ğŸ§¹ é‡ç½®
        self.delta_ws_rx = 0 # ğŸ§¹ é‡ç½®
        self.delta_browser_tx = 0 # ğŸ§¹ é‡ç½®
        self.delta_browser_rx = 0 # ğŸ§¹ é‡ç½®
        return d # ğŸ“¤ è¿”å›æ•°æ®

global_net_cost = Netstat()

# =============================================================================
#  ğŸ‰ cost_sync_loop (æ— å‚æ•°)
#
#  ğŸ¨ ç”¨é€”:
#      å®šæœŸå°†æˆæœ¬æ•°æ®åŒæ­¥ç»™ Rust Coreã€‚
#
#  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
#      "æ¯éš” 2 ç§’å‘æ€»éƒ¨æ±‡æŠ¥ä¸€æ¬¡å¼€é”€ã€‚"
#
#  âš ï¸ è­¦å‘Š:
#      å¦‚æœ Rust æœåŠ¡ä¸å¯ç”¨ï¼Œä¼šé™é»˜å¤±è´¥ã€‚
#
#  âš™ï¸ è§¦å‘æº:
#      Main.py (Startup)
# =============================================================================
async def cost_sync_loop():
    """å®šæœŸå°†æˆæœ¬æ•°æ®åŒæ­¥ç»™ Rust Core"""
    print("ğŸ”„ [Tasks] æˆæœ¬åŒæ­¥ä»»åŠ¡å·²å¯åŠ¨") # ğŸ“¢ å¯åŠ¨æ—¥å¿—
    async with httpx.AsyncClient() as client: # ğŸŒ åˆ›å»º HTTP å®¢æˆ·ç«¯
        while True: # ğŸ”„ æ— é™å¾ªç¯
            await asyncio.sleep(2) # ğŸ’¤ ç¡çœ  2 ç§’
            
            # 1. ç½‘ç»œæˆæœ¬
            net_deltas = global_net_cost.pop_deltas() # ğŸ“Š è·å–ç½‘ç»œå¢é‡
            try: # ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†
                if net_deltas["browser"]["tx"] > 0 or net_deltas["browser"]["rx"] > 0: # ğŸš¦ æ£€æŸ¥æ˜¯å¦æœ‰æµé‡
                    await client.post("http://127.0.0.1:8000/internal/cost", json={ # ğŸ“® å‘é€æŠ¥å‘Š
                        "kind": "browser",
                        "tx": net_deltas["browser"]["tx"],
                        "rx": net_deltas["browser"]["rx"]
                    })
            except: pass # ğŸ¤ å¿½ç•¥é”™è¯¯

            # 2. AI æˆæœ¬
            ai_deltas = global_ai_cost.pop_deltas() # ğŸ“Š è·å– AI å¢é‡
            try: # ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†
                if ai_deltas["cost_usd"] > 0: # ğŸš¦ æ£€æŸ¥æ˜¯å¦æœ‰æˆæœ¬
                    await client.post("http://127.0.0.1:8000/internal/cost", json={ # ğŸ“® å‘é€æŠ¥å‘Š
                        "kind": "ai",
                        "input_tokens": ai_deltas["input_tokens"],
                        "output_tokens": ai_deltas["output_tokens"],
                        "cost_usd": ai_deltas["cost_usd"]
                    })
            except: pass # ğŸ¤ å¿½ç•¥é”™è¯¯
