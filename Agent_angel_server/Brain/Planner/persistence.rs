/* ==========================================================================
   ğŸ“ƒ æ–‡ä»¶åŠŸèƒ½ : ä»»åŠ¡æŒä¹…åŒ–æ¨¡å—
   âš¡ é€»è¾‘æ‘˜è¦ : ä½¿ç”¨ RocksDB å­˜å‚¨å’Œæ¢å¤ä»»åŠ¡çŠ¶æ€ï¼Œç¡®ä¿é‡å¯åä¸ä¸¢å¤±è¿›åº¦ã€‚
   ğŸ’¡ æ˜“æ‡‚è§£é‡Š : è¿™æ˜¯æœºå™¨äººçš„ "è®°äº‹æœ¬"ï¼ŒæŠŠé‡è¦çš„äº‹æƒ…å†™åœ¨ç¡¬ç›˜ä¸Šã€‚
   ğŸ”‹ æœªæ¥æ‰©å±• : æ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢ï¼Œå¦‚æŒ‰æ—¶é—´èŒƒå›´æŸ¥æ‰¾å†å²ä»»åŠ¡ã€‚
   ğŸ“Š å½“å‰çŠ¶æ€ : æ´»è·ƒ (æ›´æ–°: 2025-12-06)
   ğŸ§± Brain/Planner/persistence.rs è¸©å‘è®°å½• (ç´¯ç§¯ï¼Œå‹¿è¦†ç›–) :
      1. [2025-12-04] [å·²ä¿®å¤] [åºåˆ—åŒ–é”™è¯¯]: JSON æ ¼å¼ä¸å…¼å®¹å¯¼è‡´ panicã€‚ -> å¢åŠ  unwrap_or_default å¤„ç†ã€‚
   ========================================================================== */

use std::sync::Arc;
use dashmap::DashMap;
use rocksdb::DB;
use crate::data_models::Task;

pub fn load_state(db: &Arc<DB>, tasks: &DashMap<String, Task>) {
    // =============================================================================
    //  ğŸ‰ åŠ è½½çŠ¶æ€ (æ•°æ®åº“ï¼Œä»»åŠ¡è¡¨)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”:
    //      ä» RocksDB éå†æ‰€æœ‰è®°å½•ï¼Œååºåˆ—åŒ–ä¸º Task å¯¹è±¡å¹¶å¡«å…¥å†…å­˜ã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    //      èµ·åºŠç¬¬ä¸€ä»¶äº‹ï¼Œç¿»ç¿»è®°äº‹æœ¬ï¼Œçœ‹çœ‹æ˜¨å¤©å¹²åˆ°å“ªäº†ã€‚
    //
    //  âš ï¸ è­¦å‘Š:
    //      [æ€§èƒ½]: å¦‚æœå†å²ä»»åŠ¡è¿‡å¤šï¼Œå¯åŠ¨å¯èƒ½ä¼šå˜æ…¢ã€‚
    //
    //  âš™ï¸ è§¦å‘æº:
    //      Through Brain/Planner.rs "System Init" -> load_state
    // =============================================================================
    let iter = db.iterator(rocksdb::IteratorMode::Start); // ğŸ” åˆ›å»ºè¿­ä»£å™¨
    for item in iter { // ğŸ”„ éå†æ•°æ®åº“
        if let Ok((key, value)) = item { // âœ… è¯»å–æˆåŠŸ
            if let Ok(k_str) = String::from_utf8(key.to_vec()) { // ğŸ”¤ è§£æ Key
                if let Ok(task) = serde_json::from_slice::<Task>(&value) { // ğŸ“¦ è§£æ Value
                    tasks.insert(k_str, task); // ğŸ“ å­˜å…¥å†…å­˜
                }
            }
        }
    }
}

pub fn save_task(db: &Arc<DB>, task: &Task) {
    // =============================================================================
    //  ğŸ‰ ä¿å­˜ä»»åŠ¡ (æ•°æ®åº“ï¼Œä»»åŠ¡)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”:
    //      å°†å•ä¸ª Task å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å¹¶å†™å…¥ RocksDBã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Š:
    //      åšå®Œä¸€æ­¥ï¼Œèµ¶ç´§è®°ä¸‹æ¥ï¼Œå…å¾—å¾…ä¼šå¿˜äº†ã€‚
    //
    //  âš ï¸ è­¦å‘Š:
    //      [IOå¼€é”€]: é¢‘ç¹å†™å…¥å¯èƒ½å½±å“æ€§èƒ½ï¼Œè™½ç„¶ RocksDB å¾ˆå¿«ã€‚
    //
    //  âš™ï¸ è§¦å‘æº:
    //      Through Brain/Planner.rs "State Update" -> save_task
    // =============================================================================
    if let Ok(json) = serde_json::to_vec(task) { // ğŸ“¦ åºåˆ—åŒ–
        let _ = db.put(task.id.as_bytes(), json); // ğŸ’¾ å†™å…¥ç¡¬ç›˜
    }
}
