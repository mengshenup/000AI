import { WS_URL } from './config.js'; // å¯¼å…¥ WebSocket æœåŠ¡å™¨åœ°å€é…ç½®
import { bus } from './event_bus.js'; // å¯¼å…¥äº‹ä»¶æ€»çº¿ï¼Œç”¨äºé€šçŸ¥å…¶ä»–æ¨¡å—

export class Network {
    // ---------------------------------------------------------------- //
    //  ç½‘ç»œç®¡ç†ç±»()
    //
    //  å‡½æ•°ç”¨å¤„ï¼š
    //     ç®¡ç† WebSocket è¿æ¥ï¼Œè´Ÿè´£ä¸æœåŠ¡å™¨è¿›è¡ŒåŒå‘é€šä¿¡ã€‚
    //
    //  æ˜“æ‡‚è§£é‡Šï¼š
    //     è¿™æ˜¯å°å¤©ä½¿çš„â€œç”µè¯çº¿â€ã€‚å®ƒè´Ÿè´£æ‹¨é€šæœåŠ¡å™¨çš„ç”µè¯ï¼ŒæŠŠä½ çš„æŒ‡ä»¤ä¼ è¿‡å»ï¼Œå†æŠŠæœåŠ¡å™¨çš„æ¶ˆæ¯ä¼ å›æ¥ã€‚
    //
    //  è­¦å‘Šï¼š
    //     å¦‚æœç½‘ç»œæ–­å¼€ï¼Œå®ƒä¼šè‡ªåŠ¨å°è¯•é‡è¿ã€‚
    // ---------------------------------------------------------------- //
    constructor() {
        this.ws = null; // WebSocket å®ä¾‹å®¹å™¨
        this.reconnectTimer = null; // é‡è¿å®šæ—¶å™¨
    }

    connect() {
        // ---------------------------------------------------------------- //
        //  è¿æ¥()
        //
        //  å‡½æ•°ç”¨å¤„ï¼š
        //     å»ºç«‹ WebSocket è¿æ¥ï¼Œå¹¶ç»‘å®š open, message, close ç­‰äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
        //
        //  æ˜“æ‡‚è§£é‡Šï¼š
        //     æ‹¨æ‰“ç”µè¯ã€‚å¦‚æœé€šäº†å°±å–Šä¸€å£°â€œä¿¡å·æ»¡æ ¼â€ï¼Œå¦‚æœæ–­äº†å°±è¿‡ä¸€ä¼šå†æ‹¨ã€‚
        // ---------------------------------------------------------------- //

        try {
            // åˆ›å»º WebSocket è¿æ¥å¯¹è±¡
            this.ws = new WebSocket(WS_URL);

            // å½“è¿æ¥æˆåŠŸå»ºç«‹æ—¶è§¦å‘
            this.ws.onopen = () => {
                console.log("WS Connected"); // æ§åˆ¶å°æ‰“å°æ—¥å¿—
                // é€šçŸ¥å°å¤©ä½¿è¯´è¯
                bus.emit('system:speak', "ç½‘ç»œæ¥é€šï¼ä¿¡å·æ»¡æ ¼ğŸ“¶");
            };

            // å½“æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯æ—¶è§¦å‘
            this.ws.onmessage = (e) => {
                // è§£ææ”¶åˆ°çš„ JSON å­—ç¬¦ä¸²æ•°æ®
                const d = JSON.parse(e.data);

                // åˆ†å‘äº‹ä»¶ï¼Œä¸å†ç›´æ¥æ“ä½œ DOMï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶æ€»çº¿é€šçŸ¥å…¶ä»–æ¨¡å—
                if (d._stats) bus.emit('net:stats', d._stats); // æ›´æ–°ç½‘ç»œç»Ÿè®¡
                if (d.type === 'log') bus.emit('system:speak', d.msg); // ç³»ç»Ÿæ—¥å¿—æ¶ˆæ¯ -> å°å¤©ä½¿è¯´è¯
                if (d.type === 'frame_update') bus.emit('net:frame', d.image); // è§†é¢‘å¸§æ›´æ–°
                if (d.type === 'new_intel') bus.emit('net:intel', d.data); // å‘ç°æ–°æƒ…æŠ¥
            };

            // å½“è¿æ¥å…³é—­æ—¶è§¦å‘
            this.ws.onclose = () => {
                console.log("WS Closed, retrying..."); // æ‰“å°æ—¥å¿—
                bus.emit('system:speak', "ç½‘ç»œä¸­æ–­ï¼Œæ­£åœ¨é‡è¿...ğŸ“¡"); // é€šçŸ¥ç”¨æˆ·

                // æ¸…é™¤æ—§çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢é‡å¤
                clearTimeout(this.reconnectTimer);
                // è®¾ç½® 3 ç§’åå°è¯•é‡æ–°è¿æ¥
                this.reconnectTimer = setTimeout(() => this.connect(), 3000);
            };
        } catch (e) {
            // æ•è·è¿æ¥è¿‡ç¨‹ä¸­çš„åŒæ­¥é”™è¯¯
            console.error(e);
        }
    }

    send(arg1, arg2 = {}) {
        // ---------------------------------------------------------------- //
        //  å‘é€(ç±»å‹/å¯¹è±¡, [è´Ÿè½½æ•°æ®])
        //
        //  å‡½æ•°ç”¨å¤„ï¼š
        //     å‘æœåŠ¡å™¨å‘é€ JSON æ ¼å¼çš„æŒ‡ä»¤ã€‚æ”¯æŒä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š
        //     1. send('cmd', {data: 1})
        //     2. send({type: 'cmd', data: 1})
        //
        //  æ˜“æ‡‚è§£é‡Šï¼š
        //     å¯¹ç€ç”µè¯ç­’è¯´è¯ã€‚æŠŠä½ çš„å‘½ä»¤æ‰“åŒ…æˆä¸€ä¸ªåŒ…è£¹å¯„ç»™æœåŠ¡å™¨ã€‚
        //
        //  è­¦å‘Šï¼š
        //     å¦‚æœè¿æ¥æœªå°±ç»ª (readyState !== 1)ï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒå¹¶æç¤ºé”™è¯¯ã€‚
        // ---------------------------------------------------------------- //

        let type, payload;
        // åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸ºå¯¹è±¡ï¼Œä»¥æ”¯æŒä¸åŒçš„è°ƒç”¨ä¹ æƒ¯
        if (typeof arg1 === 'object') {
            type = arg1.type; // ä»å¯¹è±¡ä¸­æå– type
            payload = arg1;   // æ•´ä¸ªå¯¹è±¡ä½œä¸º payload
        } else {
            type = arg1;      // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ type å­—ç¬¦ä¸²
            payload = arg2;   // ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®å¯¹è±¡
        }

        // æ£€æŸ¥ WebSocket æ˜¯å¦å­˜åœ¨ä¸”å¤„äºè¿æ¥æ‰“å¼€çŠ¶æ€ (readyState 1)
        if (this.ws && this.ws.readyState === 1) {
            // æ„é€ æœ€ç»ˆè¦å‘é€çš„æ•°æ®å¯¹è±¡ï¼Œç¡®ä¿åŒ…å« type å­—æ®µ
            const data = { ...payload, type };
            // å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²å¹¶å‘é€
            this.ws.send(JSON.stringify(data));
        } else {
            // å¦‚æœæ²¡è¿æ¥ï¼Œé€šçŸ¥ç”¨æˆ·
            bus.emit('system:speak', "ç½‘ç»œæœªè¿æ¥ï¼Œæ— æ³•å‘é€æŒ‡ä»¤âŒ");
        }
    }
}

// å¯¼å‡º Network ç±»çš„å•ä¾‹å®ä¾‹ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨åªä½¿ç”¨ä¸€ä¸ªç½‘ç»œè¿æ¥
export const network = new Network();