import { DEFAULT_APPS } from './config.js'; // 导入默认配置

class Store {
    // ---------------------------------------------------------------- //
    //  状态存储类()
    //
    //  函数用处：
    //     管理应用的状态（如窗口位置、是否打开），并持久化到 localStorage。
    //
    //  易懂解释：
    //     这是小天使的“记事本”。
    //     它会记下你把窗口拖到了哪里，上次关机前开了哪些软件。
    //     这样下次你打开网页，一切还是你熟悉的样子。
    //
    //  警告：
    //     如果用户清除了浏览器缓存，所有保存的设置（如窗口位置）都会丢失，重置为默认值。
    // ---------------------------------------------------------------- //
    constructor() {
        // 尝试从浏览器缓存中读取上次保存的状态
        // 版本号 _v4 用于在代码更新导致数据结构变化时，强制重置旧缓存
        const saved = localStorage.getItem('seraphim_apps_v4');

        if (saved) {
            // 如果有缓存，解析缓存
            const savedApps = JSON.parse(saved);

            // 初始化为默认配置的深拷贝
            this.apps = JSON.parse(JSON.stringify(DEFAULT_APPS));

            // 仅从 savedApps 中恢复已知 APP 的状态 (位置、是否打开等)
            // 这样可以自动过滤掉旧版本遗留的、不再使用的 APP (解决图标重复问题)
            Object.keys(this.apps).forEach(key => {
                if (savedApps[key]) {
                    // 保留默认配置中的静态属性(如 iconPath, color)，只覆盖动态属性(如 pos, winPos, isOpen)
                    this.apps[key] = { ...this.apps[key], ...savedApps[key] };
                }
            });
        } else {
            // 如果没有缓存，直接使用默认配置
            this.apps = JSON.parse(JSON.stringify(DEFAULT_APPS));
        }
    }

    save() {
        // ---------------------------------------------------------------- //
        //  保存()
        //
        //  函数用处：
        //     将当前内存中的状态写入 localStorage。
        //
        //  易懂解释：
        //     把记在脑子里的东西写到硬盘上，防止断电忘记。
        //
        //  警告：
        //     localStorage 是同步操作，如果数据量非常大（虽然这里不会），可能会轻微阻塞主线程。
        // ---------------------------------------------------------------- //

        localStorage.setItem('seraphim_apps_v4', JSON.stringify(this.apps));
    }

    getApp(id) {
        // ---------------------------------------------------------------- //
        //  获取应用信息(应用ID)
        //
        //  函数用处：
        //     根据 ID 获取某个应用的完整配置信息。
        //
        //  易懂解释：
        //     查户口。根据身份证号（ID）查出这个软件叫什么、图标是什么、上次停在哪里。
        //
        //  警告：
        //     如果传入不存在的 ID，会返回 undefined。
        // ---------------------------------------------------------------- //

        return this.apps[id];
    }

    updateApp(id, data) {
        // ---------------------------------------------------------------- //
        //  更新应用信息(应用ID, 新数据)
        //
        //  函数用处：
        //     更新某个应用的状态（例如位置改变了、被关闭了），并立即保存。
        //
        //  易懂解释：
        //     修改户口信息。比如“小明搬家了”，就把他的新地址记下来。
        //
        //  警告：
        //     data 参数应该是一个对象。如果传入 null 或非对象，可能会导致数据损坏。
        // ---------------------------------------------------------------- //

        if (this.apps[id]) {
            // 使用展开运算符 ... 合并新旧数据
            // 比如旧数据是 {x:1, y:1}, 新数据是 {x:2}, 合并后就是 {x:2, y:1}
            this.apps[id] = { ...this.apps[id], ...data };
            // 保存更改
            this.save();
        }
    }

    setAppMetadata(id, metadata) {
        // ---------------------------------------------------------------- //
        //  设置应用元数据(应用ID, 元数据对象)
        //
        //  函数用处：
        //     运行时注入应用的静态信息（如名称、欢迎语）。
        //     这些信息不应该被保存到 localStorage 中（因为它们是代码的一部分，不是用户状态）。
        //
        //  易懂解释：
        //     给户口本上补全名字和照片。
        // ---------------------------------------------------------------- //
        if (this.apps[id]) {
            this.apps[id] = { ...this.apps[id], ...metadata };
            // 注意：这里不调用 save()，因为我们不想把代码里的静态配置保存到用户的缓存里
            // 这样如果下次代码改了名字，用户刷新页面能立刻看到新名字，而不是旧缓存
        }
    }
}

// 导出单例
export const store = new Store();