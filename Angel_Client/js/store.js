import { DEFAULT_APPS } from './config.js'; // 导入默认配置

class Store {
    // ---------------------------------------------------------------- //
    //  状态存储类()
    //
    //  函数用处：
    //     管理应用的状态（如窗口位置、是否打开），并持久化到 localStorage。
    //
    //  易懂解释：
    //     这是小天使的“记事本”。
    //     它会记下你把窗口拖到了哪里，上次关机前开了哪些软件。
    //     这样下次你打开网页，一切还是你熟悉的样子。
    //
    //  警告：
    //     如果用户清除了浏览器缓存，所有保存的设置（如窗口位置）都会丢失，重置为默认值。
    // ---------------------------------------------------------------- //
    constructor() {
        // 尝试从浏览器缓存中读取上次保存的状态
        // 版本号 _v4 用于在代码更新导致数据结构变化时，强制重置旧缓存
        const saved = localStorage.getItem('seraphim_apps_v4');

        if (saved) {
            // 如果有缓存，解析缓存
            const savedApps = JSON.parse(saved);
            // 将默认配置合并进去，确保新增的 APP (如情报站) 能显示出来
            // 使用深拷贝的 DEFAULT_APPS 作为基底，然后用保存的数据覆盖它
            // 这样既保留了用户的设置(如位置)，又有了新 APP
            this.apps = { ...JSON.parse(JSON.stringify(DEFAULT_APPS)), ...savedApps };

            // 再次检查：如果有新 APP 在 savedApps 里完全不存在，上面的合并可能不够
            // (因为 savedApps 里的 key 可能少于 DEFAULT_APPS)
            // 所以我们需要遍历 DEFAULT_APPS，把缺失的补上
            Object.keys(DEFAULT_APPS).forEach(key => {
                if (!this.apps[key]) {
                    this.apps[key] = JSON.parse(JSON.stringify(DEFAULT_APPS[key]));
                }
            });
        } else {
            // 如果没有缓存，直接使用默认配置
            this.apps = JSON.parse(JSON.stringify(DEFAULT_APPS));
        }
    }

    save() {
        // ---------------------------------------------------------------- //
        //  保存()
        //
        //  函数用处：
        //     将当前内存中的状态写入 localStorage。
        //
        //  易懂解释：
        //     把记在脑子里的东西写到硬盘上，防止断电忘记。
        //
        //  警告：
        //     localStorage 是同步操作，如果数据量非常大（虽然这里不会），可能会轻微阻塞主线程。
        // ---------------------------------------------------------------- //

        localStorage.setItem('seraphim_apps_v4', JSON.stringify(this.apps));
    }

    getApp(id) {
        // ---------------------------------------------------------------- //
        //  获取应用信息(应用ID)
        //
        //  函数用处：
        //     根据 ID 获取某个应用的完整配置信息。
        //
        //  易懂解释：
        //     查户口。根据身份证号（ID）查出这个软件叫什么、图标是什么、上次停在哪里。
        //
        //  警告：
        //     如果传入不存在的 ID，会返回 undefined。
        // ---------------------------------------------------------------- //

        return this.apps[id];
    }

    updateApp(id, data) {
        // ---------------------------------------------------------------- //
        //  更新应用信息(应用ID, 新数据)
        //
        //  函数用处：
        //     更新某个应用的状态（例如位置改变了、被关闭了），并立即保存。
        //
        //  易懂解释：
        //     修改户口信息。比如“小明搬家了”，就把他的新地址记下来。
        //
        //  警告：
        //     data 参数应该是一个对象。如果传入 null 或非对象，可能会导致数据损坏。
        // ---------------------------------------------------------------- //

        if (this.apps[id]) {
            // 使用展开运算符 ... 合并新旧数据
            // 比如旧数据是 {x:1, y:1}, 新数据是 {x:2}, 合并后就是 {x:2, y:1}
            this.apps[id] = { ...this.apps[id], ...data };
            // 保存更改
            this.save();
        }
    }
}

// 导出单例
export const store = new Store();