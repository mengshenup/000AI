import { DEFAULT_APPS } from './config.js'; // âš™ï¸ å¯¼å…¥é»˜è®¤é…ç½®

class Store {
    // =================================
    //  ğŸ‰ çŠ¶æ€å­˜å‚¨ç±» (æ— å‚æ•°)
    //
    //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    //     ç®¡ç†åº”ç”¨çš„çŠ¶æ€ï¼ˆå¦‚çª—å£ä½ç½®ã€æ˜¯å¦æ‰“å¼€ï¼‰ï¼Œå¹¶æŒä¹…åŒ–åˆ° localStorageã€‚
    //
    //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    //     è¿™æ˜¯å°å¤©ä½¿çš„â€œè®°äº‹æœ¬â€ã€‚
    //     å®ƒä¼šè®°ä¸‹ä½ æŠŠçª—å£æ‹–åˆ°äº†å“ªé‡Œï¼Œä¸Šæ¬¡å…³æœºå‰å¼€äº†å“ªäº›è½¯ä»¶ã€‚
    //     è¿™æ ·ä¸‹æ¬¡ä½ æ‰“å¼€ç½‘é¡µï¼Œä¸€åˆ‡è¿˜æ˜¯ä½ ç†Ÿæ‚‰çš„æ ·å­ã€‚
    //
    //  âš ï¸ è­¦å‘Šï¼š
    //     å¦‚æœç”¨æˆ·æ¸…é™¤äº†æµè§ˆå™¨ç¼“å­˜ï¼Œæ‰€æœ‰ä¿å­˜çš„è®¾ç½®ï¼ˆå¦‚çª—å£ä½ç½®ï¼‰éƒ½ä¼šä¸¢å¤±ï¼Œé‡ç½®ä¸ºé»˜è®¤å€¼ã€‚
    // =================================
    constructor() {
        // =================================
        //  ğŸ‰ æœ¬åœ°æ•°æ®åº“ (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     åˆå§‹åŒ–å­˜å‚¨å¯¹è±¡ï¼Œå°è¯•ä»åç«¯æ–‡ä»¶è¯»å–æ•°æ®ã€‚
        //     ğŸ’– ä¿®æ”¹ï¼šä¸å†ä½¿ç”¨ LocalStorageï¼Œæ”¹ä¸ºå®Œå…¨ä¾èµ–åç«¯æ–‡ä»¶å­˜å‚¨ (Angel_Client/Memorybank/apps.json)ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     ç¿»å¼€è®°äº‹æœ¬ï¼Œçœ‹çœ‹ä¸Šæ¬¡å†™äº†ä»€ä¹ˆã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœæ•°æ®æŸåï¼Œä¼šè‡ªåŠ¨é‡ç½®ä¸ºç©ºã€‚
        // =================================

        this.apps = {}; // ğŸ†• åˆå§‹åŒ–ä¸ºç©º

        // 1. ğŸ’– å¼‚æ­¥ä»åç«¯åŠ è½½æœ€æ–°å¸ƒå±€ (æƒå¨æ•°æ®)
        // è¿™æ ·å³ä½¿æ›´æ¢äº†æµè§ˆå™¨ç¼“å­˜ï¼Œåªè¦åç«¯æ•°æ®è¿˜åœ¨ï¼Œå°±èƒ½æ¢å¤
        this.syncFromBackend();
    }

    // ğŸ’– ä»åç«¯åŒæ­¥æ•°æ®
    async syncFromBackend() {
        try {
            const res = await fetch('http://localhost:8000/load_layout');
            const data = await res.json();
            if (data && Object.keys(data).length > 0) {
                console.log("ä»åç«¯æˆåŠŸåŠ è½½å¸ƒå±€é…ç½® âœ¨");
                this.apps = data;
            } else {
                console.log("åç«¯æ— é…ç½®æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤é…ç½®");
                this.apps = {}; // ä¿æŒä¸ºç©ºï¼Œç­‰å¾…åç»­é€»è¾‘ä½¿ç”¨é»˜è®¤å€¼
            }
        } catch (e) {
            console.warn("æ— æ³•è¿æ¥åç«¯è·å–å¸ƒå±€é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®", e);
            this.apps = {};
        }
    }

    // ğŸ†• åŠ¨æ€ç‰ˆæœ¬æ£€æŸ¥ï¼šè®¡ç®—å½“å‰é…ç½®çš„æŒ‡çº¹
    checkVersion(metadataMap) {
        // æš‚æ—¶ç¦ç”¨æŒ‡çº¹æ£€æŸ¥ï¼Œå› ä¸ºå·²ç§»é™¤ LocalStorage
        /*
        // ç”ŸæˆæŒ‡çº¹ï¼šæ‰€æœ‰ App ID æ’åºåçš„å­—ç¬¦ä¸²
        const currentFingerprint = Object.keys(metadataMap).sort().join('|');
        const savedFingerprint = localStorage.getItem('seraphim_fingerprint');

        if (savedFingerprint !== currentFingerprint) {
            console.log(`[Store] æ£€æµ‹åˆ°åº”ç”¨ç»“æ„å˜æ›´ (${savedFingerprint} -> ${currentFingerprint})ï¼Œæ‰§è¡Œæ™ºèƒ½æ¸…ç†...`);
            
            // ç­–ç•¥ï¼šä¿ç•™ä½ç½®ä¿¡æ¯ï¼Œé‡ç½®æ‰“å¼€çŠ¶æ€ (é˜²æ­¢æ–°æ—§é€»è¾‘å†²çªå¯¼è‡´å¡æ­»)
            Object.keys(this.apps).forEach(id => {
                if (this.apps[id]) {
                    this.apps[id].isOpen = false; // ğŸ”’ å¼ºåˆ¶å…³é—­æ‰€æœ‰çª—å£
                    this.apps[id].isMinimized = false;
                    // å¦‚æœ ID å·²ç»ä¸å­˜åœ¨äºæ–°é…ç½®ä¸­ï¼Œprune æ–¹æ³•ç¨åä¼šå¤„ç†
                }
            });
            
            // æ›´æ–°æŒ‡çº¹
            localStorage.setItem('seraphim_fingerprint', currentFingerprint);
            this.save();
        }
        */
    }

    save() {
        // =================================
        //  ğŸ‰ ä¿å­˜ (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     å°†å½“å‰å†…å­˜ä¸­çš„çŠ¶æ€å‘é€ç»™åç«¯ä¿å­˜ã€‚
        //     åªä¿å­˜å…³é”®çš„åŠ¨æ€çŠ¶æ€å­—æ®µï¼Œé¿å…æ•°æ®è†¨èƒ€ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     æŠŠè®°åœ¨è„‘å­é‡Œçš„ä¸œè¥¿å†™åˆ°ç¡¬ç›˜ä¸Šï¼Œé˜²æ­¢æ–­ç”µå¿˜è®°ã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     ç½‘ç»œè¯·æ±‚æ˜¯å¼‚æ­¥çš„ã€‚
        // =================================

        // å®šä¹‰åªä¿å­˜è¿™äº›åŠ¨æ€å­—æ®µï¼Œè¿‡æ»¤æ‰é™æ€ HTML å†…å®¹
        const DYNAMIC_KEYS = ['pos', 'winPos', 'isOpen', 'zIndex', 'isMinimized', 'isMaximized', 'size', 'customName', 'description']; // ğŸ”‘ å…³é”®å­—æ®µåˆ—è¡¨
        
        const stateToSave = {}; // ğŸ“¦ å¾…ä¿å­˜å¯¹è±¡
        Object.entries(this.apps).forEach(([id, app]) => {
            stateToSave[id] = {};
            DYNAMIC_KEYS.forEach(key => {
                if (app[key] !== undefined) {
                    stateToSave[id][key] = app[key]; // ğŸ“¥ å¤åˆ¶å­—æ®µ
                }
            });
        });

        // ğŸš€ å‘é€ç»™åç«¯ä¿å­˜
        fetch('http://127.0.0.1:8000/save_layout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: stateToSave })
        }).catch(err => console.error("ä¿å­˜å¤±è´¥:", err));
    }

    reset() {
        // =================================
        //  ğŸ‰ é‡ç½®æ‰€æœ‰çŠ¶æ€ (æ— å‚æ•°)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œæ¢å¤å‡ºå‚è®¾ç½®ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     å¿˜æ‰è¿‡å»ï¼Œé‡æ–°å¼€å§‹ï¼âœ¨
        // =================================
        this.apps = {};
        // å‘é€ç©ºæ•°æ®ç»™åç«¯ä»¥è¦†ç›–å­˜æ¡£
        fetch('http://127.0.0.1:8000/save_layout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: {} })
        }).then(() => {
            location.reload(); // ğŸ”„ åˆ·æ–°é¡µé¢
        }).catch(err => {
            console.error("é‡ç½®å¤±è´¥:", err);
            location.reload(); // å³ä½¿å¤±è´¥ä¹Ÿåˆ·æ–°
        });
    }

    prune(validIds) {
        // =================================
        //  ğŸ‰ æ¸…ç†åƒµå°¸æ•°æ® (æœ‰æ•ˆIDåˆ—è¡¨)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     åˆ é™¤é‚£äº›å­˜åœ¨äºç¼“å­˜ä¸­ä½†å½“å‰ä»£ç ä¸­å·²ä¸å­˜åœ¨çš„åº”ç”¨æ•°æ®ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     å¤§æ‰«é™¤ã€‚æŠŠé‚£äº›å·²ç»æ¬èµ°çš„äººï¼ˆåˆ æ‰çš„åº”ç”¨ï¼‰çš„æˆ·å£æ³¨é”€æ‰ã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     ä¸€æ—¦åˆ é™¤æ— æ³•æ¢å¤ã€‚
        // =================================
        const validSet = new Set(validIds); // ğŸ“‹ æœ‰æ•ˆIDé›†åˆ
        let changed = false; // ğŸš© å˜æ›´æ ‡è®°
        
        Object.keys(this.apps).forEach(id => {
            if (!validSet.has(id)) {
                console.log(`[Store] æ¸…ç†åƒµå°¸åº”ç”¨æ•°æ®: ${id}`); // ğŸ“ æ—¥å¿—
                delete this.apps[id]; // ğŸ—‘ï¸ åˆ é™¤æ•°æ®
                changed = true; // ğŸš© æ ‡è®°å˜æ›´
            }
        });

        if (changed) this.save(); // ğŸ’¾ å¦‚æœæœ‰å˜åŠ¨åˆ™ä¿å­˜
    }

    getApp(id) {
        // =================================
        //  ğŸ‰ è·å–åº”ç”¨ä¿¡æ¯ (åº”ç”¨ID)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æ ¹æ® ID è·å–æŸä¸ªåº”ç”¨çš„å®Œæ•´é…ç½®ä¿¡æ¯ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     æŸ¥æˆ·å£ã€‚æ ¹æ®èº«ä»½è¯å·ï¼ˆIDï¼‰æŸ¥å‡ºè¿™ä¸ªè½¯ä»¶å«ä»€ä¹ˆã€å›¾æ ‡æ˜¯ä»€ä¹ˆã€ä¸Šæ¬¡åœåœ¨å“ªé‡Œã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœä¼ å…¥ä¸å­˜åœ¨çš„ IDï¼Œä¼šè¿”å› undefinedã€‚
        // =================================

        return this.apps[id]; // ğŸ“¤ è¿”å›åº”ç”¨æ•°æ®
    }

    updateApp(id, data) {
        // =================================
        //  ğŸ‰ æ›´æ–°åº”ç”¨ä¿¡æ¯ (åº”ç”¨ID, æ–°æ•°æ®)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     æ›´æ–°æŸä¸ªåº”ç”¨çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ä½ç½®æ”¹å˜äº†ã€è¢«å…³é—­äº†ï¼‰ï¼Œå¹¶ç«‹å³ä¿å­˜ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     ä¿®æ”¹æˆ·å£ä¿¡æ¯ã€‚æ¯”å¦‚â€œå°æ˜æ¬å®¶äº†â€ï¼Œå°±æŠŠä»–çš„æ–°åœ°å€è®°ä¸‹æ¥ã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     data å‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœä¼ å…¥ null æˆ–éå¯¹è±¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æŸåã€‚
        // =================================

        if (this.apps[id]) {
            // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦ ... åˆå¹¶æ–°æ—§æ•°æ®
            // æ¯”å¦‚æ—§æ•°æ®æ˜¯ {x:1, y:1}, æ–°æ•°æ®æ˜¯ {x:2}, åˆå¹¶åå°±æ˜¯ {x:2, y:1}
            this.apps[id] = { ...this.apps[id], ...data }; // ğŸ”„ åˆå¹¶æ•°æ®
            // ä¿å­˜æ›´æ”¹
            this.save(); // ğŸ’¾ ä¿å­˜
        }
    }

    setAppMetadata(id, metadata) {
        // =================================
        //  ğŸ‰ è®¾ç½®åº”ç”¨å…ƒæ•°æ® (åº”ç”¨ID, å…ƒæ•°æ®å¯¹è±¡)
        //
        //  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        //     è¿è¡Œæ—¶æ³¨å…¥åº”ç”¨çš„é™æ€ä¿¡æ¯ï¼ˆå¦‚åç§°ã€æ¬¢è¿è¯­ï¼‰ã€‚
        //     è¿™äº›ä¿¡æ¯ä¸åº”è¯¥è¢«ä¿å­˜åˆ° localStorage ä¸­ï¼ˆå› ä¸ºå®ƒä»¬æ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œä¸æ˜¯ç”¨æˆ·çŠ¶æ€ï¼‰ã€‚
        //
        //  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        //     ç»™æˆ·å£æœ¬ä¸Šè¡¥å…¨åå­—å’Œç…§ç‰‡ã€‚
        //
        //  âš ï¸ è­¦å‘Šï¼š
        //     å¦‚æœåº”ç”¨IDå·²å­˜åœ¨ï¼Œä¼šä¿ç•™åŸæœ‰çš„ç”¨æˆ·çŠ¶æ€ï¼ˆå¦‚ä½ç½®ï¼‰ï¼Œåªæ›´æ–°é™æ€ä¿¡æ¯ã€‚
        // =================================
        if (this.apps[id]) {
            // ä¿®å¤ï¼šä¼˜å…ˆä¿ç•™ this.apps[id] ä¸­çš„ç”¨æˆ·çŠ¶æ€ (å¦‚ pos, winPos, isOpen)
            // metadata ä¸­çš„é»˜è®¤å€¼åªåœ¨ this.apps[id] ä¸­ä¸å­˜åœ¨æ—¶ç”Ÿæ•ˆ
            this.apps[id] = { ...metadata, ...this.apps[id] }; // ğŸ”„ åˆå¹¶ï¼Œä¿ç•™ç”¨æˆ·çŠ¶æ€
            
            // ç¡®ä¿é™æ€é…ç½® (name, content, icon, color) æ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„ä»£ç ç‰ˆæœ¬
            // è¿™æ ·å³ä½¿ç”¨æˆ·ç¼“å­˜äº†æ—§çš„é…ç½®ï¼Œä»£ç æ›´æ–°åä¹Ÿèƒ½çœ‹åˆ°æ–°ç•Œé¢
            // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„åç§° (customName)ï¼Œå¦‚æœä¸å­˜åœ¨æ‰ä½¿ç”¨å…ƒæ•°æ®ä¸­çš„é»˜è®¤åç§°
            this.apps[id].name = this.apps[id].customName || metadata.name; 
            this.apps[id].description = metadata.description; // ğŸ“ æ›´æ–°æè¿°
            this.apps[id].content = metadata.content; // ğŸ“„ æ›´æ–°å†…å®¹
            this.apps[id].icon = metadata.icon; // ğŸ–¼ï¸ æ›´æ–°å›¾æ ‡
            this.apps[id].color = metadata.color; // ğŸ¨ æ›´æ–°é¢œè‰²
            this.apps[id].contentStyle = metadata.contentStyle; // ğŸ’… æ›´æ–°æ ·å¼
            this.apps[id].openMsg = metadata.openMsg; // ğŸ’¬ æ›´æ–°æ¬¢è¿è¯­
            
            // ğŸ’– æ˜¾å¼æ›´æ–°å¸ƒå±€å±æ€§ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬ UI ç”Ÿæ•ˆ
            this.apps[id].frameless = metadata.frameless; 
            this.apps[id].fixed = metadata.fixed;
            this.apps[id].width = metadata.width;
            this.apps[id].height = metadata.height;
        } else {
            // å¦‚æœæ˜¯æ–°åº”ç”¨ï¼Œç›´æ¥ä½¿ç”¨å…ƒæ•°æ®
            this.apps[id] = metadata; // ğŸ†• åˆ›å»ºæ–°åº”ç”¨æ•°æ®
        }
    }
}

// å¯¼å‡ºå•ä¾‹
export const store = new Store(); // ğŸ’¾ å…¨å±€å”¯ä¸€çš„å­˜å‚¨å®ä¾‹