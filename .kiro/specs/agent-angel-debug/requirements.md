# 需求文档

## 简介

本文档定义了Agent_angel_server的全面调试和测试系统需求。Agent_angel_server是一个混合Rust + Python AI代理架构。系统由Rust核心（端口8000）处理WebSocket连接、认证和消息路由，以及Python工作器（端口8001）处理浏览器自动化（Playwright）和AI认知（Gemini）组成。调试系统必须验证两个组件、它们的集成点和端到端工作流的所有关键功能。

## 术语表

- **Rust核心**: 基于Axum的服务器，运行在端口8000，负责WebSocket管理、认证、消息路由、CDP流和成本监控
- **Python工作器**: 基于FastAPI的服务器，运行在端口8001，负责通过Playwright进行浏览器自动化和通过Gemini进行AI处理
- **CDP流**: Chrome开发者工具协议流服务，捕获浏览器视频帧
- **认知系统**: AI规划和任务执行引擎（Planner.rs）
- **成本监控器**: 跟踪Gemini调用的API使用成本的服务
- **网关**: WebSocket消息路由层，连接客户端到Rust核心
- **Body客户端**: 与Python工作器通信以进行浏览器操作的Rust模块
- **会话**: 由Playwright管理的浏览器自动化会话
- **任务队列**: 认知系统任务在Memorybank/task_queue.json中的持久存储
- **密钥管理器**: 管理存储在RocksDB中的API密钥的服务

## 需求

### 需求1

**用户故事:** 作为开发人员，我想验证Rust核心服务器启动和基本健康状况，以便确认基础层可正常运行。

#### 验收标准

1. 当Rust核心启动时，系统应绑定到端口8000并记录启动确认
2. 当Rust核心初始化时，系统应创建所有必需的组件（AppState、CognitiveSystem、CostMonitor、KeyManager、CDPStream）
3. 当Rust核心加载环境变量时，系统应成功读取.env配置而不出错
4. 当Rust核心初始化认知系统时，系统应从Memorybank/task_queue.json加载现有任务
5. 当Rust核心初始化密钥管理器时，系统应成功打开Memorybank/keys_db的RocksDB数据库

### 需求2

**用户故事:** 作为开发人员，我想验证Python工作器启动和基本健康状况，以便确认自动化层可正常运行。

#### 验收标准

1. 当Python工作器启动时，系统应绑定到端口8001并记录启动确认
2. 当Python工作器初始化时，系统应成功导入所有必需的模块（Playwright、Gemini、Interface、Tasks）
3. 当Python工作器启动时，系统应启动成本同步后台任务
4. 当Python工作器加载配置时，系统应成功读取Memory/Config.py设置
5. 当Python工作器初始化Playwright时，系统应验证Playwright浏览器二进制文件已安装

### 需求3

**用户故事:** 作为开发人员，我想测试WebSocket连接，以便验证客户端-服务器通信通道正常工作。

#### 验收标准

1. 当客户端连接到/ws/{user_id}时，系统应建立WebSocket连接并将客户端添加到连接池
2. 当客户端发送有效消息时，系统应解析消息并将其路由到适当的处理程序
3. 当客户端断开连接时，系统应从连接池中删除客户端并清理资源
4. 当多个客户端使用不同的user_id连接时，系统应在DashMap中维护单独的连接
5. 当广播消息发送到/internal/broadcast时，系统应将消息传递给所有连接的客户端

### 需求4

**用户故事:** 作为开发人员，我想测试浏览器会话管理，以便验证Playwright自动化正常工作。

#### 验收标准

1. 当会话初始化请求发送到Python /session/init时，系统应启动一个打开CDP端口9222的Chrome浏览器
2. 当创建会话时，系统应向调用者返回会话标识符
3. 当会话关闭请求发送到/session/close时，系统应终止浏览器进程并清理资源
4. 当请求多个会话时，系统应处理并发浏览器实例而不发生冲突
5. 当会话初始化失败时，系统应返回带有诊断信息的错误消息

### 需求5

**用户故事:** 作为开发人员，我想测试浏览器自动化动作，以便验证Playwright命令正确执行。

#### 验收标准

1. 当导航动作发送到/action/execute并带有URL时，系统应将浏览器导航到指定的URL
2. 当点击动作发送并带有选择器时，系统应定位并点击元素
3. 当输入动作发送并带有文本和选择器时，系统应将文本输入到指定的元素
4. 当截图动作发送到/state/screenshot时，系统应捕获并返回当前页面截图
5. 当动作因无效选择器而失败时，系统应返回带有选择器和超时信息的错误

### 需求6

**用户故事:** 作为开发人员，我想测试CDP视频流，以便验证实时浏览器帧捕获正常工作。

#### 验收标准

1. 当CDP启动请求发送到/internal/cdp/start时，系统应连接到Chrome的调试端口9222
2. 当CDP流处于活动状态时，系统应捕获视频帧并将其作为带有type="vision"的base64编码消息发送
3. 当CDP流遇到连接错误时，系统应记录错误并尝试重新连接
4. 当客户端断开连接时，系统应停止该用户的CDP流
5. 当CDP流处于活动状态时，系统应在正常条件下保持帧率高于10 FPS

### 需求7

**用户故事:** 作为开发人员，我想测试认知系统任务管理，以便验证AI规划和执行正常工作。

#### 验收标准

1. 当任务创建请求发送到/task/create时，系统应将任务添加到认知队列
2. 当认知系统处理任务时，系统应将任务队列持久化到Memorybank/task_queue.json
3. 当认知系统启动时，系统应从持久存储加载现有任务
4. 当执行任务时，系统应调用Python工作器执行浏览器动作
5. 当任务完成时，系统应更新任务状态并保存到持久存储

### 需求8

**用户故事:** 作为开发人员，我想测试Gemini AI集成，以便验证AI认知和响应生成正常工作。

#### 验收标准

1. 当进行Gemini API调用时，系统应使用适当的认证头发送请求
2. 当Gemini返回响应时，系统应解析JSON并提取生成的文本
3. 当Gemini调用因速率限制而失败时，系统应返回带有重试后信息的错误
4. 当Gemini调用成功时，系统应向成本监控器报告令牌使用情况
5. 当API密钥无效时，系统应返回带有诊断信息的认证错误

### 需求9

**用户故事:** 作为开发人员，我想测试成本监控，以便验证API使用跟踪正常工作。

#### 验收标准

1. 当Gemini API调用完成时，系统应记录输入和输出令牌计数
2. 当更新成本数据时，系统应根据令牌定价计算总成本
3. 当Python工作器同步成本时，系统应将成本数据发送到Rust核心/internal/cost端点
4. 当查询成本数据时，系统应返回当前会话的累积成本
5. 当成本监控器持久化数据时，系统应将成本历史保存到持久存储

### 需求10

**用户故事:** 作为开发人员，我想测试密钥管理器，以便验证API密钥存储和检索正常工作。

#### 验收标准

1. 当存储API密钥时，系统应将其保存到RocksDB，服务名称作为键
2. 当检索API密钥时，系统应返回解密的密钥值
3. 当请求不存在的密钥时，系统应返回指示未找到密钥的错误
4. 当密钥管理器初始化时，系统应创建RocksDB数据库（如果不存在）
5. 当存储多个密钥时，系统应维护单独的条目而不发生冲突

### 需求11

**用户故事:** 作为开发人员，我想测试Rust-Python集成，以便验证跨语言通信正常工作。

#### 验收标准

1. 当Rust核心调用Python工作器端点时，系统应成功向localhost:8001发出HTTP请求
2. 当Python工作器向Rust核心报告时，系统应成功向localhost:8000发出HTTP请求
3. 当服务之间发生网络错误时，系统应记录错误并返回适当的错误响应
4. 当两个服务都在运行时，系统应完成端到端工作流而不发生通信失败
5. 当序列化请求有效负载时，系统应在Rust和Python之间使用兼容的JSON模式

### 需求12

**用户故事:** 作为开发人员，我想测试错误处理和恢复，以便验证系统优雅地处理失败。

#### 验收标准

1. 当Python工作器端点不可达时，系统应返回带有超时信息的连接错误
2. 当浏览器动作超时时，系统应返回错误并且不阻塞后续请求
3. 当收到无效JSON时，系统应返回带有无效有效负载的解析错误
4. 当WebSocket连接意外断开时，系统应清理资源并记录断开连接
5. 当系统遇到未处理的错误时，系统应记录完整的错误跟踪并向客户端返回通用错误消息

### 需求13

**用户故事:** 作为开发人员，我想测试端到端工作流，以便验证完整的用户场景正常工作。

#### 验收标准

1. 当执行完整工作流（连接→创建会话→导航→截图→关闭会话）时，系统应完成所有步骤而不出错
2. 当创建并执行任务时，系统应协调Rust核心、Python工作器和浏览器以完成任务
3. 当会话期间CDP流处于活动状态时，系统应在执行浏览器动作时传递视频帧
4. 当执行多个并发工作流时，系统应处理它们而不发生资源冲突或死锁
5. 当工作流被中断时，系统应清理部分状态并允许新工作流启动

### 需求14

**用户故事:** 作为开发人员，我想测试性能和资源使用，以便验证系统高效运行。

#### 验收标准

1. 当系统空闲时，系统应为Rust核心消耗少于200MB的内存
2. 当浏览器会话处于活动状态时，系统应在正常负载下保持CPU使用率低于50%
3. 当发送WebSocket消息时，系统应以低于100ms的延迟传递消息
4. 当CDP流处于活动状态时，系统应保持帧传递，抖动低于50ms
5. 当10个并发会话处于活动状态时，系统应处理所有会话，性能降级不超过基线的2倍
