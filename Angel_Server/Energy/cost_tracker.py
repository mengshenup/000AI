import json # ğŸ§© JSON å¤„ç†åº“
from Memory.system_config import PRICING_TABLE # ğŸ’° å¯¼å…¥å®šä»·è¡¨

class CostTracker:
    # =================================
    #  ğŸ‰ æˆæœ¬è¿½è¸ªå™¨ (æ— å‚æ•°)
    #
    #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
    #     ä½œä¸ºç³»ç»Ÿçš„â€œè´¢åŠ¡æ€»ç›‘â€ï¼Œå®æ—¶è¿½è¸ªå…¨ç³»ç»Ÿçš„èµ„æºæ¶ˆè€—ï¼ŒåŒ…æ‹¬ç½‘ç»œæµé‡ï¼ˆWebSocket + æµè§ˆå™¨ï¼‰å’Œ AI Token ä½¿ç”¨é‡ï¼Œå¹¶è®¡ç®—é¢„ä¼°è´¹ç”¨ã€‚
    #
    #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
    #     Angel çš„å°è´¦æœ¬ï¼ğŸ“’ æ¯ä¸€ç¬”æµé‡ã€æ¯ä¸€æ¬¡æ€è€ƒï¼ˆAI è°ƒç”¨ï¼‰ï¼Œéƒ½è¦è®°ä¸‹æ¥ï¼Œçœ‹çœ‹æˆ‘ä»¬èŠ±äº†å¤šå°‘é’±ï¼Œæ˜¯ä¸æ˜¯è¯¥çœç€ç‚¹èŠ±å•¦ï¼Ÿ
    #
    #  âš ï¸ è­¦å‘Šï¼š
    #     Token ä¼°ç®—ä»…åŸºäºå­—ç¬¦é•¿åº¦ï¼ˆ0.35ç³»æ•°ï¼‰ï¼Œå¹¶éç²¾ç¡®çš„ Tokenizer ç»“æœï¼Œå®é™…è´¹ç”¨ä»¥ API è´¦å•ä¸ºå‡†ã€‚
    # =================================
    def __init__(self):
        # =================================
        #  ğŸ‰ åˆå§‹åŒ–è´¦æœ¬ (æ— å‚æ•°)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     åˆå§‹åŒ–å„é¡¹è®¡æ•°å™¨ä¸ºé›¶ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     æ–°çš„ä¸€å¤©å¼€å§‹å•¦ï¼ŒæŠŠè´¦æœ¬ç¿»åˆ°æ–°çš„ä¸€é¡µï¼Œæ‰€æœ‰æ•°å­—éƒ½å½’é›¶ï¼0ï¸âƒ£
        # =================================
        self.ws_tx = 0 # ğŸ“¤ WebSocket å‘é€å­—èŠ‚æ•°
        self.ws_rx = 0 # ğŸ“¥ WebSocket æ¥æ”¶å­—èŠ‚æ•°
        self.browser_rx = 0 # ğŸ“¥ æµè§ˆå™¨æ¥æ”¶å­—èŠ‚æ•°
        self.browser_tx = 0 # ğŸ“¤ æµè§ˆå™¨å‘é€å­—èŠ‚æ•°
        self.input_tokens = 0 # ğŸ“ AI è¾“å…¥ Token æ•°
        self.output_tokens = 0 # ğŸ—£ï¸ AI è¾“å‡º Token æ•°
        self.ai_cost = 0.0 # ğŸ’¸ æ€» AI è´¹ç”¨ (USD)
    
    def track_ws(self, tx=0, rx=0):
        # =================================
        #  ğŸ‰ è®°å½• WebSocket æµé‡ (å‘é€é‡ï¼Œæ¥æ”¶é‡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     ç´¯åŠ  WebSocket é€šé“çš„ä¸Šä¸‹è¡Œæµé‡ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     è®°ä¸€ç¬”ï¼šç¥ç»ç³»ç»Ÿï¼ˆWebSocketï¼‰åˆä¼ è¾“äº†ä¸€äº›ä¿¡å·ï¼âš¡
        # =================================
        self.ws_tx += tx # ğŸ“¤ ç´¯åŠ å‘é€æµé‡
        self.ws_rx += rx # ğŸ“¥ ç´¯åŠ æ¥æ”¶æµé‡

    def track_browser(self, tx=0, rx=0):
        # =================================
        #  ğŸ‰ è®°å½•æµè§ˆå™¨æµé‡ (å‘é€é‡ï¼Œæ¥æ”¶é‡)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     ç´¯åŠ æµè§ˆå™¨äº§ç”Ÿçš„ç½‘ç»œæµé‡ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     è®°ä¸€ç¬”ï¼šçœ¼ç›ï¼ˆæµè§ˆå™¨ï¼‰çœ‹ç½‘é¡µç”¨äº†å¤šå°‘æµé‡ï¼ğŸŒ
        # =================================
        self.browser_tx += tx # ğŸ“¤ ç´¯åŠ å‘é€æµé‡
        self.browser_rx += rx # ğŸ“¥ ç´¯åŠ æ¥æ”¶æµé‡

    def track_ai(self, text_content: str, is_input=True, model="gemini-1.5-flash"):
        # =================================
        #  ğŸ‰ è®°å½• AI æ¶ˆè€— (æ–‡æœ¬å†…å®¹ï¼Œæ˜¯å¦ä¸ºè¾“å…¥ï¼Œæ¨¡å‹åç§°)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     ä¼°ç®—æ–‡æœ¬çš„ Token æ•°é‡ï¼Œå¹¶æ ¹æ®å®šä»·è¡¨è®¡ç®—è´¹ç”¨ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     è®°ä¸€ç¬”ï¼šå¤§è„‘ï¼ˆAIï¼‰æ€è€ƒäº†å¤šå°‘ä¸œè¥¿ï¼ğŸ§  æ€è€ƒä¹Ÿæ˜¯è¦èŠ±é’±çš„å“¦ï¼ˆTokenï¼‰ï¼
        #
        #  âš ï¸ è­¦å‘Šï¼š
        #     å¦‚æœ text_content ä¸ºç©ºï¼Œå°†ç›´æ¥è¿”å›ã€‚é»˜è®¤ä½¿ç”¨ gemini-1.5-flash å®šä»·ã€‚
        # =================================
        if not text_content: return # ğŸš« å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡
        est_tokens = max(1, len(text_content) * 0.35) # ğŸ“ ä¼°ç®— Token æ•°
        price = PRICING_TABLE.get(model, PRICING_TABLE["gemini-1.5-flash"]) # ğŸ’° è·å–å•ä»·
        rate = price["input"] if is_input else price["output"] # ğŸ“Š é€‰æ‹©è´¹ç‡
        cost = (est_tokens / 1_000_000) * rate # ğŸ’¸ è®¡ç®—è´¹ç”¨
        
        if is_input:
            self.input_tokens += est_tokens # ğŸ“ ç´¯åŠ è¾“å…¥ Token
        else:
            self.output_tokens += est_tokens # ğŸ—£ï¸ ç´¯åŠ è¾“å‡º Token
        self.ai_cost += cost # ğŸ’¸ ç´¯åŠ æ€»è´¹ç”¨

    def get_report(self):
        # =================================
        #  ğŸ‰ è·å–è´¢åŠ¡æŠ¥è¡¨ (æ— å‚æ•°)
        #
        #  ğŸ¨ ä»£ç ç”¨é€”ï¼š
        #     æ‰“åŒ…å½“å‰çš„èµ„æºæ¶ˆè€—æ•°æ®ï¼Œè¿”å›å­—å…¸æ ¼å¼çš„æŠ¥è¡¨ã€‚
        #
        #  ğŸ’¡ æ˜“æ‡‚è§£é‡Šï¼š
        #     è€æ¿ï¼Œè¿™æ˜¯ä»Šå¤©çš„è´¦å•ï¼ğŸ§¾ è¯·è¿‡ç›®ï¼
        # =================================
        return {
            "ws_traffic": {"tx": self.ws_tx, "rx": self.ws_rx},
            "browser_traffic": {"tx": self.browser_tx, "rx": self.browser_rx},
            "ai_usage": {
                "input_tokens": int(self.input_tokens),
                "output_tokens": int(self.output_tokens),
                "cost_usd": round(self.ai_cost, 4)
            }
        }

# ğŸŒ å…¨å±€å•ä¾‹å®ä¾‹
global_cost_tracker = CostTracker()
