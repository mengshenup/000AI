# Angel Server 启动延迟与日志分析报告

## 1. 启动延迟分析 (10-15秒)

### 1.1. 现象描述
用户反馈服务器启动或热重载后，需要等待十几秒才能看到“应用核心已加载”的提示。

### 1.2. 潜在原因排查
经过对代码和环境的分析，主要原因如下：

1.  **Playwright 浏览器初始化 (最主要原因)**
    *   **机制**: `AngelBrowser` 类在初始化时可能预加载了 Chromium 内核。
    *   **耗时**: 在 Windows 上，启动一个无头浏览器进程通常需要 2-5 秒。如果系统负载高，可能更久。
    *   **代码位置**: `websocket_handler.py` -> `browser_service = AngelBrowser()`。虽然这行代码在 WebSocket 连接时才执行，但 `services.browser` 模块的导入本身可能会触发一些全局初始化。

2.  **Python 模块导入开销**
    *   **机制**: `main.py` 导入了 `routers.websocket_handler`，后者又导入了 `services.browser`、`services.billing` 等。
    *   **耗时**: Python 的 `import` 是同步阻塞的。如果某个模块在顶层执行了耗时操作（如读取大文件、连接数据库），会阻塞整个启动过程。

3.  **Uvicorn 热重载机制 (WatchFiles)**
    *   **机制**: `watchfiles` 需要扫描整个目录树建立文件索引。
    *   **耗时**: 如果 `user_data` 目录（包含浏览器缓存）非常大且未被完全排除，扫描会非常慢。
    *   **现状**: `run.py` 中已排除了 `user_data`，但这可能还不够（比如 `__pycache__` 或 `.git` 如果很大）。

### 1.3. 风险评估
*   **功能性 BUG**: **无**。这属于性能特性，不影响功能正确性。
*   **体验影响**: 开发时等待时间较长，生产环境无影响（因为不频繁重启）。

### 1.4. 优化建议
*   **延迟导入**: 将重型模块（如 Playwright 相关）的导入移到函数内部，而不是放在文件顶层。
*   **优化排除列表**: 确保 `run.py` 中的 `reload_excludes` 覆盖了所有大文件夹。

---

## 2. Uvicorn 英文日志分析

### 2.1. 现象描述
控制台依然显示绿色的 `INFO: ...` 英文日志。

### 2.2. 技术原理
这些日志是由 **Uvicorn** (ASGI 服务器) 和 **Starlette** (FastAPI 的底层框架) 的内部 Logger 直接输出的。
*   它们是硬编码在第三方库源码中的。
*   它们不走 Python 的标准 `print`，而是走 `logging` 模块。

### 2.3. 为什么不能简单改成中文？
1.  **源码级修改**: 需要修改 `site-packages/uvicorn/...` 下的文件，这在部署时不可行。
2.  **日志拦截**: 可以编写复杂的 `logging.Filter` 来拦截并翻译这些日志，但这会增加大量非业务代码，且容易因为库版本更新而失效。

### 2.4. 结论
**这是正常现象，不是 BUG。**
这些英文日志是服务器底层的标准输出，用于指示进程状态（PID、端口、监听模式）。只要看到我们自定义的中文“✨ Angel Server 应用核心已加载”出现，就说明业务层已经接管，可以忽略底层的英文日志。
