# 🔄 000AI Workflow & Coding Protocol (v2.0)

## 🕰️ 长程续航与状态管理 (Long-Running & State Management)

**1. 🧠 状态持久化 (State Persistence)**
*   **快照机制**: 耗时超过 1 分钟的任务，必须维护 `Debug/State/<TaskName>_checkpoint.json`。
*   **Schema**: `{"step": "current_step", "status": "running", "timestamp": "ISO8601", "context_summary": "..."}`
*   **断点续传**: 任务中断重启时，**优先**读取快照，严禁从零开始。

**2. ⏱️ 智能监控 (Smart Monitoring)**
*   **心跳保活**: 长耗时操作（如构建、训练）必须开启详细日志 (`-v`) 或每 60 秒输出进度点 (`.`)，证明进程存活。
*   **死锁熔断**:
    *   **输入阻塞**: 依靠 `< nul` 立即熔断。
    *   **静默死锁**: 持续 **300秒** 无输出视为死锁，自动终止并触发 *Reflexion*。

**3. 🧹 上下文剪枝 (Context Pruning)**
*   **触发**: 当上下文达到20,000 tokens 时。
*   **动作**: 将已完成步骤的详细日志归档至 `Debug/Memory/context_window.md`，仅保留当前步骤的必要上下文。

---

## 🔄 核心工作流 (The 6-Step Autonomous Loop)

You MUST use **XML Tags** to denote your current state.

### 1. 🗺️ 计划 (Plan) `<plan>`
*   **动作**: 读取 `activeContext.json`，拆解任务为原子步骤。
*   **输出**: `<plan> ... </plan>`

### 2. 📐 逻辑构建 (Logic) `<logic>`
*   **规则**: **Logic First, Code Later**.
*   **动作**: 对于复杂任务 (>50行代码)，必须先创建 `.logic` 文件（伪代码/流程图）。
*   **禁止**: 此阶段严禁编写可执行代码。
*   **输出**: `<logic> ... </logic>`

### 3. ⌨️ 编码 (Code) `<code_action>`
*   **标准**: **高评分紧凑代码** (强类型、极简命名、原子化)。
*   **禁止**: **严禁**在此阶段添加任何注释（除必要的 TODO）。
*   **目标**: 逻辑评分极高，体积极小。
*   **输出**: `<code_action> ... </code_action>`

### 4. ⚡ 测试 (Test) `<test_action>`
*   **规则**: **Silence is Gold**.
*   **动作**: 执行测试脚本，捕获真实输出。
*   **强制**: 必须使用 `Input Starvation` 参数 (e.g., `< nul`).
*   **输出**: `<test_action> ... </test_action>`

### 5. 🧠 反思 (Reflexion) `<reflexion>`
*   **触发**: 测试失败或完成。
*   **动作**: 分析 *Why* (根本原因)。
*   **决策**:
    *   **失败**: 回到 `<logic>` 或 `<code_action>`。
    *   **成功**: 进入 `<annotation_action>`。
*   **输出**: `<reflexion> ... </reflexion>`

### 6. 📝 个性化注释 (Annotation) `<annotation_action>`
*   **触发**: 仅在 **最终代码** 验证通过后。
*   **核心任务**: **逆向工程与文档注入**。
*   **动作**: 使用 `replace_string_in_file` 注入“五段式备注”和“Emoji 信标”。
*   **输出**: `<annotation_action> ... </annotation_action>`

---

## 📜 注释规范 (Strict Standards - Phase 6 Only)

**A. 文件头 (File Header)**
*   **位置**: 文件顶部。
*   **格式**:
    ```text
    /* ==========================================================================
       📃 文件功能 : [写全]
       ⚡ 逻辑摘要 : [核心算法/思路]
       💡 易懂解释 : [高中生能懂，正面可爱语气，不使用比喻]
       🔋 扩展备注 : [未来扩展建议]
       📊 当前状态 : [活跃 | 待解决 | 已完成 | 废弃] (最后更新: YYYY-MM-DD)
       🧱 [当前文件名] 踩坑记录 (必须累加，严禁覆盖) :
          1. [YYYY-MM-DD] [已修复/待验证] [坑名]: [原因] -> [修复方案] (Line XX)
       ========================================================================== */
    ```

**B. 五段式备注 (The 5-Part Block)**
*   **适用**: 函数、类、模块、HTML容器。
*   **位置**: 定义行的下一行（内部）。
*   **必填**:
```text
// =============================================================================
//  🎉 [中文含义] ([参数的中文含义]，[参数的中文含义]，[参数的中文含义]，...)
//
//  🎨 代码用途：
//      [专业描述：精准的编程术语，描述这段代码的技术目，但要易懂]
//
//  💡 易懂解释：
//      [高中生能懂，正面可爱语气，不使用比喻]
//  
//  ⚠️ 警告：
//      [风险类型]: [具体后果与解决方案]
//      (例如：死锁隐患、内存溢出、数据一致性等。若无特殊风险，写“无特殊风险”)
//  
//  ⚙️ 触发源 (Trigger Source)：
//      [文件/模块] -> [UI交互/事件] -> [函数调用链]
//      (例如：通过 admin_panel.js 后台管理系统的 “强制结算” 按钮 handle_click(参数名,参数名,) -> Admin_Force_Settle(参数名,参数名,) 触发)
// =============================================================================
```

**C. 📍 视觉状态信标 (Visual State Beacons)**
*   **定义**: 优先选用正面、可爱的 Emoji作为**视觉信标**，将代码逻辑映射为人类可读的语义块。
*   **覆盖率**: **100%** (除纯括号外)。每一行代码必须有信标。
*   **内容**: **状态/结果导向 (State/Result Oriented)**。
    *   侧重描述代码执行后的 **“状态变化”** 或 **“业务结果”**。
    *   **严禁**使用逗号、长句或“初始化为...”等废话。
    *   **风格**: 词汇偏名词化，简洁有力，像仪表盘的状态灯。
*   **语法适配**: 自动识别 `.py` (#), `.js` (//), `.bat` (REM), `.html` (<!-- -->)。
    *   **特殊规则**: 对于 `.bat` (Batch) 文件，**严禁**在 `if` 或 `for` 代码块内部使用 `::` 风格注释，必须强制使用 `REM`，否则会破坏语法结构。

**示例**:
```python
def calculate_score(points):
    # ... (此处必须有完整的五段式备注) ...
    current_score = 0  # 🥚 基础分归零
    if points > 10:    # ⚖️ 高分阈值判定
        current_score = points * 2  # 🚀 双倍奖励生效
    return current_score # 📤 最终结果交付
```
